<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.361">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Juliaプログラミング大全 - サンプルコード</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./code.html">サンプルコード</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Juliaプログラミング大全</a> 
    </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ホーム</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./code.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">サンプルコード</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./corrections.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">訂正</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#章" id="toc-章" class="nav-link active" data-scroll-target="#章">1章</a>
  <ul class="collapse">
  <li><a href="#insertionsort.jl" id="toc-insertionsort.jl" class="nav-link" data-scroll-target="#insertionsort.jl">insertionsort.jl</a></li>
  <li><a href="#nqnqueens.jl" id="toc-nqnqueens.jl" class="nav-link" data-scroll-target="#nqnqueens.jl">nq/nqueens.jl</a></li>
  <li><a href="#pca.jl" id="toc-pca.jl" class="nav-link" data-scroll-target="#pca.jl">pca.jl</a></li>
  </ul></li>
  <li><a href="#章-1" id="toc-章-1" class="nav-link" data-scroll-target="#章-1">2章</a>
  <ul class="collapse">
  <li><a href="#hello.jl" id="toc-hello.jl" class="nav-link" data-scroll-target="#hello.jl">hello.jl</a></li>
  <li><a href="#helloargs.jl" id="toc-helloargs.jl" class="nav-link" data-scroll-target="#helloargs.jl">helloargs.jl</a></li>
  </ul></li>
  <li><a href="#章-2" id="toc-章-2" class="nav-link" data-scroll-target="#章-2">3章</a>
  <ul class="collapse">
  <li><a href="#isprime.jl" id="toc-isprime.jl" class="nav-link" data-scroll-target="#isprime.jl">isprime.jl</a></li>
  <li><a href="#primes.jl" id="toc-primes.jl" class="nav-link" data-scroll-target="#primes.jl">primes.jl</a></li>
  <li><a href="#othello.jl" id="toc-othello.jl" class="nav-link" data-scroll-target="#othello.jl">Othello.jl</a></li>
  </ul></li>
  <li><a href="#章-3" id="toc-章-3" class="nav-link" data-scroll-target="#章-3">6章</a>
  <ul class="collapse">
  <li><a href="#printchars.jl" id="toc-printchars.jl" class="nav-link" data-scroll-target="#printchars.jl">printchars.jl</a></li>
  </ul></li>
  <li><a href="#章-4" id="toc-章-4" class="nav-link" data-scroll-target="#章-4">7章</a>
  <ul class="collapse">
  <li><a href="#lastitem.jl" id="toc-lastitem.jl" class="nav-link" data-scroll-target="#lastitem.jl">lastitem.jl</a></li>
  <li><a href="#fib.jl" id="toc-fib.jl" class="nav-link" data-scroll-target="#fib.jl">fib.jl</a></li>
  <li><a href="#min.jl" id="toc-min.jl" class="nav-link" data-scroll-target="#min.jl">min.jl</a></li>
  </ul></li>
  <li><a href="#章-5" id="toc-章-5" class="nav-link" data-scroll-target="#章-5">8章</a>
  <ul class="collapse">
  <li><a href="#periodictable.jl" id="toc-periodictable.jl" class="nav-link" data-scroll-target="#periodictable.jl">periodictable.jl</a></li>
  <li><a href="#reportfields.jl" id="toc-reportfields.jl" class="nav-link" data-scroll-target="#reportfields.jl">reportfields.jl</a></li>
  </ul></li>
  <li><a href="#章-6" id="toc-章-6" class="nav-link" data-scroll-target="#章-6">9章</a>
  <ul class="collapse">
  <li><a href="#circle.jl" id="toc-circle.jl" class="nav-link" data-scroll-target="#circle.jl">circle.jl</a></li>
  <li><a href="#rgb.jl" id="toc-rgb.jl" class="nav-link" data-scroll-target="#rgb.jl">rgb.jl</a></li>
  <li><a href="#normal.jl" id="toc-normal.jl" class="nav-link" data-scroll-target="#normal.jl">normal.jl</a></li>
  <li><a href="#node.jl" id="toc-node.jl" class="nav-link" data-scroll-target="#node.jl">node.jl</a></li>
  <li><a href="#stack.jl" id="toc-stack.jl" class="nav-link" data-scroll-target="#stack.jl">stack.jl</a></li>
  <li><a href="#shortstring.jl" id="toc-shortstring.jl" class="nav-link" data-scroll-target="#shortstring.jl">shortstring.jl</a></li>
  <li><a href="#bitrotator.jl" id="toc-bitrotator.jl" class="nav-link" data-scroll-target="#bitrotator.jl">bitrotator.jl</a></li>
  <li><a href="#composition.jl" id="toc-composition.jl" class="nav-link" data-scroll-target="#composition.jl">composition.jl</a></li>
  <li><a href="#trait.jl" id="toc-trait.jl" class="nav-link" data-scroll-target="#trait.jl">trait.jl</a></li>
  </ul></li>
  <li><a href="#章-7" id="toc-章-7" class="nav-link" data-scroll-target="#章-7">10章</a>
  <ul class="collapse">
  <li><a href="#msb.jl" id="toc-msb.jl" class="nav-link" data-scroll-target="#msb.jl">msb.jl</a></li>
  <li><a href="#check.jl" id="toc-check.jl" class="nav-link" data-scroll-target="#check.jl">check.jl</a></li>
  <li><a href="#repeat.jl" id="toc-repeat.jl" class="nav-link" data-scroll-target="#repeat.jl">repeat.jl</a></li>
  <li><a href="#elapsed.jl" id="toc-elapsed.jl" class="nav-link" data-scroll-target="#elapsed.jl">elapsed.jl</a></li>
  <li><a href="#fstring.jl" id="toc-fstring.jl" class="nav-link" data-scroll-target="#fstring.jl">fstring.jl</a></li>
  <li><a href="#genfun.jl" id="toc-genfun.jl" class="nav-link" data-scroll-target="#genfun.jl">genfun.jl</a></li>
  <li><a href="#polynomial.jl" id="toc-polynomial.jl" class="nav-link" data-scroll-target="#polynomial.jl">polynomial.jl</a></li>
  </ul></li>
  <li><a href="#章-8" id="toc-章-8" class="nav-link" data-scroll-target="#章-8">11章</a>
  <ul class="collapse">
  <li><a href="#mysparse.jl" id="toc-mysparse.jl" class="nav-link" data-scroll-target="#mysparse.jl">mysparse.jl</a></li>
  </ul></li>
  <li><a href="#章-9" id="toc-章-9" class="nav-link" data-scroll-target="#章-9">12章</a>
  <ul class="collapse">
  <li><a href="#tarai.jl" id="toc-tarai.jl" class="nav-link" data-scroll-target="#tarai.jl">tarai.jl</a></li>
  <li><a href="#producer-consumer.jl" id="toc-producer-consumer.jl" class="nav-link" data-scroll-target="#producer-consumer.jl">producer-consumer.jl</a></li>
  <li><a href="#counter-bad.jl" id="toc-counter-bad.jl" class="nav-link" data-scroll-target="#counter-bad.jl">counter-bad.jl</a></li>
  <li><a href="#mbmandelbrot.jl" id="toc-mbmandelbrot.jl" class="nav-link" data-scroll-target="#mbmandelbrot.jl">mb/mandelbrot.jl</a></li>
  <li><a href="#mbplot-seq.jl" id="toc-mbplot-seq.jl" class="nav-link" data-scroll-target="#mbplot-seq.jl">mb/plot-seq.jl</a></li>
  <li><a href="#mbplot-par1.jl" id="toc-mbplot-par1.jl" class="nav-link" data-scroll-target="#mbplot-par1.jl">mb/plot-par1.jl</a></li>
  <li><a href="#counter-lock.jl" id="toc-counter-lock.jl" class="nav-link" data-scroll-target="#counter-lock.jl">counter-lock.jl</a></li>
  <li><a href="#notification.jl" id="toc-notification.jl" class="nav-link" data-scroll-target="#notification.jl">notification.jl</a></li>
  <li><a href="#counter-atomicadd.jl" id="toc-counter-atomicadd.jl" class="nav-link" data-scroll-target="#counter-atomicadd.jl">counter-atomicadd.jl</a></li>
  <li><a href="#atomic.jl" id="toc-atomic.jl" class="nav-link" data-scroll-target="#atomic.jl">atomic.jl</a></li>
  <li><a href="#distaddworkers.jl" id="toc-distaddworkers.jl" class="nav-link" data-scroll-target="#distaddworkers.jl">dist/addworkers.jl</a></li>
  </ul></li>
  <li><a href="#章-10" id="toc-章-10" class="nav-link" data-scroll-target="#章-10">13章</a>
  <ul class="collapse">
  <li><a href="#walkpwd.jl" id="toc-walkpwd.jl" class="nav-link" data-scroll-target="#walkpwd.jl">walkpwd.jl</a></li>
  <li><a href="#titlecase.jl" id="toc-titlecase.jl" class="nav-link" data-scroll-target="#titlecase.jl">titlecase.jl</a></li>
  <li><a href="#json.jl" id="toc-json.jl" class="nav-link" data-scroll-target="#json.jl">json.jl</a></li>
  <li><a href="#logging.jl" id="toc-logging.jl" class="nav-link" data-scroll-target="#logging.jl">logging.jl</a></li>
  </ul></li>
  <li><a href="#章-11" id="toc-章-11" class="nav-link" data-scroll-target="#章-11">14章</a>
  <ul class="collapse">
  <li><a href="#toplogger.jl" id="toc-toplogger.jl" class="nav-link" data-scroll-target="#toplogger.jl">toplogger.jl</a></li>
  </ul></li>
  <li><a href="#章-12" id="toc-章-12" class="nav-link" data-scroll-target="#章-12">15章</a>
  <ul class="collapse">
  <li><a href="#voyager.c" id="toc-voyager.c" class="nav-link" data-scroll-target="#voyager.c">voyager.c</a></li>
  <li><a href="#memcmp.jl" id="toc-memcmp.jl" class="nav-link" data-scroll-target="#memcmp.jl">memcmp.jl</a></li>
  <li><a href="#sort.c" id="toc-sort.c" class="nav-link" data-scroll-target="#sort.c">sort.c</a></li>
  <li><a href="#textwrap.jl" id="toc-textwrap.jl" class="nav-link" data-scroll-target="#textwrap.jl">textwrap.jl</a></li>
  </ul></li>
  <li><a href="#章-13" id="toc-章-13" class="nav-link" data-scroll-target="#章-13">16章</a>
  <ul class="collapse">
  <li><a href="#myprojecthello.jl" id="toc-myprojecthello.jl" class="nav-link" data-scroll-target="#myprojecthello.jl">myproject/hello.jl</a></li>
  <li><a href="#pkgtemplate.jl" id="toc-pkgtemplate.jl" class="nav-link" data-scroll-target="#pkgtemplate.jl">pkgtemplate.jl</a></li>
  <li><a href="#othellosrcothello.jl" id="toc-othellosrcothello.jl" class="nav-link" data-scroll-target="#othellosrcothello.jl">Othello/src/Othello.jl</a></li>
  <li><a href="#othellotestruntests.jl" id="toc-othellotestruntests.jl" class="nav-link" data-scroll-target="#othellotestruntests.jl">Othello/test/runtests.jl</a></li>
  <li><a href="#message.jl" id="toc-message.jl" class="nav-link" data-scroll-target="#message.jl">message.jl</a></li>
  </ul></li>
  <li><a href="#章-14" id="toc-章-14" class="nav-link" data-scroll-target="#章-14">17章</a>
  <ul class="collapse">
  <li><a href="#primetools.jl" id="toc-primetools.jl" class="nav-link" data-scroll-target="#primetools.jl">PrimeTools.jl</a></li>
  <li><a href="#isin.jl" id="toc-isin.jl" class="nav-link" data-scroll-target="#isin.jl">isin.jl</a></li>
  <li><a href="#sum-unstable.jl" id="toc-sum-unstable.jl" class="nav-link" data-scroll-target="#sum-unstable.jl">sum-unstable.jl</a></li>
  <li><a href="#loop.jl" id="toc-loop.jl" class="nav-link" data-scroll-target="#loop.jl">loop.jl</a></li>
  <li><a href="#sum-stable.jl" id="toc-sum-stable.jl" class="nav-link" data-scroll-target="#sum-stable.jl">sum-stable.jl</a></li>
  </ul></li>
  <li><a href="#章-15" id="toc-章-15" class="nav-link" data-scroll-target="#章-15">18章</a>
  <ul class="collapse">
  <li><a href="#calccircle.jl" id="toc-calccircle.jl" class="nav-link" data-scroll-target="#calccircle.jl">calccircle.jl</a></li>
  <li><a href="#calccircle-test.jl" id="toc-calccircle-test.jl" class="nav-link" data-scroll-target="#calccircle-test.jl">calccircle-test.jl</a></li>
  <li><a href="#sleeper.jl" id="toc-sleeper.jl" class="nav-link" data-scroll-target="#sleeper.jl">sleeper.jl</a></li>
  <li><a href="#allocator.jl" id="toc-allocator.jl" class="nav-link" data-scroll-target="#allocator.jl">allocator.jl</a></li>
  <li><a href="#vec4.jl" id="toc-vec4.jl" class="nav-link" data-scroll-target="#vec4.jl">vec4.jl</a></li>
  <li><a href="#rank1matrix.jl" id="toc-rank1matrix.jl" class="nav-link" data-scroll-target="#rank1matrix.jl">rank1matrix.jl</a></li>
  <li><a href="#database.jl" id="toc-database.jl" class="nav-link" data-scroll-target="#database.jl">database.jl</a></li>
  <li><a href="#split.jl" id="toc-split.jl" class="nav-link" data-scroll-target="#split.jl">split.jl</a></li>
  <li><a href="#rowmins.jl" id="toc-rowmins.jl" class="nav-link" data-scroll-target="#rowmins.jl">rowmins.jl</a></li>
  <li><a href="#sortmerge.jl" id="toc-sortmerge.jl" class="nav-link" data-scroll-target="#sortmerge.jl">sortmerge.jl</a></li>
  <li><a href="#b64hex2char.jl" id="toc-b64hex2char.jl" class="nav-link" data-scroll-target="#b64hex2char.jl">b64/hex2char.jl</a></li>
  <li><a href="#b64encode1.jl" id="toc-b64encode1.jl" class="nav-link" data-scroll-target="#b64encode1.jl">b64/encode1.jl</a></li>
  <li><a href="#b64encode2.jl" id="toc-b64encode2.jl" class="nav-link" data-scroll-target="#b64encode2.jl">b64/encode2.jl</a></li>
  <li><a href="#b64encode3.jl" id="toc-b64encode3.jl" class="nav-link" data-scroll-target="#b64encode3.jl">b64/encode3.jl</a></li>
  <li><a href="#mbplot-par2.jl" id="toc-mbplot-par2.jl" class="nav-link" data-scroll-target="#mbplot-par2.jl">mb/plot-par2.jl</a></li>
  <li><a href="#fsparsum.jl" id="toc-fsparsum.jl" class="nav-link" data-scroll-target="#fsparsum.jl">fs/parsum.jl</a></li>
  <li><a href="#histhistogram-serial.jl" id="toc-histhistogram-serial.jl" class="nav-link" data-scroll-target="#histhistogram-serial.jl">hist/histogram-serial.jl</a></li>
  <li><a href="#histhistogram-lock.jl" id="toc-histhistogram-lock.jl" class="nav-link" data-scroll-target="#histhistogram-lock.jl">hist/histogram-lock.jl</a></li>
  <li><a href="#histhistogram-mapreduce.jl" id="toc-histhistogram-mapreduce.jl" class="nav-link" data-scroll-target="#histhistogram-mapreduce.jl">hist/histogram-mapreduce.jl</a></li>
  <li><a href="#nqnqueens-flat.jl" id="toc-nqnqueens-flat.jl" class="nav-link" data-scroll-target="#nqnqueens-flat.jl">nq/nqueens-flat.jl</a></li>
  <li><a href="#nqnqueens-nested.jl" id="toc-nqnqueens-nested.jl" class="nav-link" data-scroll-target="#nqnqueens-nested.jl">nq/nqueens-nested.jl</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">サンプルコード</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>このページでは「Juliaプログラミング大全」中のサンプルコードを掲載しています。</p>
<p>ファイルに特別の記載がない限りは<a href="https://creativecommons.org/publicdomain/mark/1.0/deed.ja">パブリック・ドメイン</a>です。</p>
<p>サンプルコードのファイルは次のリンクで一括ダウンロードできます。</p>
<ul>
<li><a href="code.tar.gz">code.tar.gz</a></li>
<li><a href="code.zip">code.zip</a></li>
</ul>
<section id="章" class="level2">
<h2 class="anchored" data-anchor-id="章">1章</h2>
<section id="insertionsort.jl" class="level3">
<h3 class="anchored" data-anchor-id="insertionsort.jl">insertionsort.jl</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># 挿入ソート</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw">function</span> <span class="fu">insertionsort</span>(xs)</span>
<span id="cb1-3"><a href="#cb1-3"></a>    xs <span class="op">=</span> <span class="fu">copy</span>(xs)</span>
<span id="cb1-4"><a href="#cb1-4"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="fu">lastindex</span>(xs)</span>
<span id="cb1-5"><a href="#cb1-5"></a>        x <span class="op">=</span> xs[i]</span>
<span id="cb1-6"><a href="#cb1-6"></a>        <span class="cf">while</span> i <span class="op">&gt;</span> <span class="fl">1</span> <span class="op">&amp;&amp;</span> xs[i<span class="op">-</span><span class="fl">1</span>] <span class="op">&gt;</span> x</span>
<span id="cb1-7"><a href="#cb1-7"></a>            xs[i] <span class="op">=</span> xs[i<span class="op">-</span><span class="fl">1</span>]</span>
<span id="cb1-8"><a href="#cb1-8"></a>            i <span class="op">-=</span> <span class="fl">1</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>        <span class="cf">end</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>        xs[i] <span class="op">=</span> x</span>
<span id="cb1-11"><a href="#cb1-11"></a>    <span class="cf">end</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>    <span class="cf">return</span> xs</span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="nqnqueens.jl" class="level3">
<h3 class="anchored" data-anchor-id="nqnqueens.jl">nq/nqueens.jl</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1"></a><span class="co">#!/usr/bin/env julia</span></span>
<span id="cb2-2"><a href="#cb2-2"></a></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co"># 列fileにクイーンを置き、再帰的に解を数え上げる</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="kw">function</span> <span class="fu">solve</span>(ranks, file)</span>
<span id="cb2-5"><a href="#cb2-5"></a>    n <span class="op">=</span> <span class="fu">length</span>(ranks)</span>
<span id="cb2-6"><a href="#cb2-6"></a>    nsols <span class="op">=</span> <span class="fl">0</span>  <span class="co"># 解の数</span></span>
<span id="cb2-7"><a href="#cb2-7"></a>    <span class="cf">for</span> rank <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>n</span>
<span id="cb2-8"><a href="#cb2-8"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>file<span class="op">-</span><span class="fl">1</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>            <span class="pp">@inbounds</span> r <span class="op">=</span> rank <span class="op">-</span> ranks[i]</span>
<span id="cb2-10"><a href="#cb2-10"></a>            <span class="cf">if</span> r <span class="op">==</span> <span class="fl">0</span> <span class="op">||</span> file <span class="op">-</span> i <span class="op">==</span> <span class="fu">abs</span>(r)</span>
<span id="cb2-11"><a href="#cb2-11"></a>                <span class="co"># 横か斜めにクイーンがあるので次の行に移る</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>                <span class="pp">@goto</span> next</span>
<span id="cb2-13"><a href="#cb2-13"></a>            <span class="cf">end</span></span>
<span id="cb2-14"><a href="#cb2-14"></a>        <span class="cf">end</span></span>
<span id="cb2-15"><a href="#cb2-15"></a>        <span class="co"># (file, rank)にクイーンを置く</span></span>
<span id="cb2-16"><a href="#cb2-16"></a>        ranks[file] <span class="op">=</span> rank</span>
<span id="cb2-17"><a href="#cb2-17"></a>        <span class="co"># 次の列に移る（既に最後の列なら解を1つ発見）</span></span>
<span id="cb2-18"><a href="#cb2-18"></a>        nsols <span class="op">+=</span> file <span class="op">&lt;</span> n ? <span class="fu">solve</span>(ranks, file <span class="op">+</span> <span class="fl">1</span>) <span class="op">:</span> <span class="fl">1</span></span>
<span id="cb2-19"><a href="#cb2-19"></a>        <span class="pp">@label</span> next</span>
<span id="cb2-20"><a href="#cb2-20"></a>    <span class="cf">end</span></span>
<span id="cb2-21"><a href="#cb2-21"></a>    <span class="cf">return</span> nsols</span>
<span id="cb2-22"><a href="#cb2-22"></a><span class="kw">end</span></span>
<span id="cb2-23"><a href="#cb2-23"></a></span>
<span id="cb2-24"><a href="#cb2-24"></a><span class="co"># nクイーン問題の解を数え上げる</span></span>
<span id="cb2-25"><a href="#cb2-25"></a><span class="fu">nqueens</span>(n) <span class="op">=</span> n <span class="op">≤</span> <span class="fl">0</span> ? <span class="fl">0</span> <span class="op">:</span> <span class="fu">solve</span>(<span class="fu">zeros</span>(<span class="dt">Int</span>, n), <span class="fl">1</span>)</span>
<span id="cb2-26"><a href="#cb2-26"></a></span>
<span id="cb2-27"><a href="#cb2-27"></a><span class="co"># コマンドラインから呼び出されたときのエントリーポイント</span></span>
<span id="cb2-28"><a href="#cb2-28"></a><span class="cf">if</span> <span class="fu">abspath</span>(<span class="cn">PROGRAM_FILE</span>) <span class="op">==</span> <span class="pp">@__FILE__</span></span>
<span id="cb2-29"><a href="#cb2-29"></a>    <span class="kw">let</span></span>
<span id="cb2-30"><a href="#cb2-30"></a>        n <span class="op">=</span> <span class="fu">parse</span>(<span class="dt">Int</span>, <span class="cn">ARGS</span>[<span class="fl">1</span>])</span>
<span id="cb2-31"><a href="#cb2-31"></a>        <span class="fu">println</span>(n, <span class="st">": "</span>, <span class="fu">nqueens</span>(n))</span>
<span id="cb2-32"><a href="#cb2-32"></a>    <span class="cf">end</span></span>
<span id="cb2-33"><a href="#cb2-33"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="pca.jl" class="level3">
<h3 class="anchored" data-anchor-id="pca.jl">pca.jl</h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># 標準ライブラリの読込み</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="im">using</span> <span class="bu">LinearAlgebra</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="im">using</span> <span class="bu">Statistics</span></span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="co"># 主成分分析（データXは各列が観測値の行列）</span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="kw">function</span> <span class="fu">pca</span>(X)</span>
<span id="cb3-7"><a href="#cb3-7"></a>    <span class="co"># 中心化（各行の平均値を差し引く）</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>    X <span class="op">=</span> X <span class="op">.-</span> <span class="fu">mean</span>(X, dims <span class="op">=</span> <span class="fl">2</span>)</span>
<span id="cb3-9"><a href="#cb3-9"></a>    <span class="co"># 特異値分解</span></span>
<span id="cb3-10"><a href="#cb3-10"></a>    U, <span class="op">=</span> <span class="fu">svd</span>(X)</span>
<span id="cb3-11"><a href="#cb3-11"></a>    <span class="co"># 射影（i行目が第i主成分に対応）</span></span>
<span id="cb3-12"><a href="#cb3-12"></a>    <span class="cf">return</span> U<span class="op">'</span>X</span>
<span id="cb3-13"><a href="#cb3-13"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="章-1" class="level2">
<h2 class="anchored" data-anchor-id="章-1">2章</h2>
<section id="hello.jl" class="level3">
<h3 class="anchored" data-anchor-id="hello.jl">hello.jl</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><a href="#cb4-1"></a><span class="co">#!/usr/bin/env julia</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="fu">println</span>(<span class="st">"hello, world"</span>)</span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="fu">println</span>(<span class="st">"こんにちは、世界"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="helloargs.jl" class="level3">
<h3 class="anchored" data-anchor-id="helloargs.jl">helloargs.jl</h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1"></a><span class="co">#!/usr/bin/env julia</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>name1 <span class="op">=</span> <span class="cn">ARGS</span>[<span class="fl">1</span>]</span>
<span id="cb5-3"><a href="#cb5-3"></a>name2 <span class="op">=</span> <span class="cn">ARGS</span>[<span class="fl">2</span>]</span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="fu">println</span>(<span class="st">"こんにちは、</span><span class="sc">$</span>(name1)<span class="st">さんと</span><span class="sc">$</span>(name2)<span class="st">さん"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="章-2" class="level2">
<h2 class="anchored" data-anchor-id="章-2">3章</h2>
<section id="isprime.jl" class="level3">
<h3 class="anchored" data-anchor-id="isprime.jl">isprime.jl</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># nが素数かを判定</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="kw">function</span> <span class="fu">isprime</span>(n)</span>
<span id="cb6-3"><a href="#cb6-3"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="fu">isqrt</span>(n)</span>
<span id="cb6-4"><a href="#cb6-4"></a>        <span class="cf">if</span> n <span class="op">%</span> i <span class="op">==</span> <span class="fl">0</span></span>
<span id="cb6-5"><a href="#cb6-5"></a>            <span class="co"># 約数が見つかったので素数ではない</span></span>
<span id="cb6-6"><a href="#cb6-6"></a>            <span class="cf">return</span> <span class="cn">false</span></span>
<span id="cb6-7"><a href="#cb6-7"></a>        <span class="cf">end</span></span>
<span id="cb6-8"><a href="#cb6-8"></a>    <span class="cf">end</span></span>
<span id="cb6-9"><a href="#cb6-9"></a>    <span class="co"># 約数がなかったので素数である</span></span>
<span id="cb6-10"><a href="#cb6-10"></a>    <span class="cf">return</span> <span class="cn">true</span></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="primes.jl" class="level3">
<h3 class="anchored" data-anchor-id="primes.jl">primes.jl</h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1"></a><span class="co"># n以下の素数を返す</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="kw">function</span> <span class="fu">primes</span>(n)</span>
<span id="cb7-3"><a href="#cb7-3"></a>    <span class="co"># 素数の候補を配列で保持</span></span>
<span id="cb7-4"><a href="#cb7-4"></a>    list <span class="op">=</span> <span class="fu">trues</span>(n)</span>
<span id="cb7-5"><a href="#cb7-5"></a>    <span class="co"># 1は素数ではないので削除</span></span>
<span id="cb7-6"><a href="#cb7-6"></a>    list[<span class="fl">1</span>] <span class="op">=</span> <span class="cn">false</span></span>
<span id="cb7-7"><a href="#cb7-7"></a>    <span class="co"># 最初の素数</span></span>
<span id="cb7-8"><a href="#cb7-8"></a>    p <span class="op">=</span> <span class="fl">2</span></span>
<span id="cb7-9"><a href="#cb7-9"></a>    <span class="cf">while</span> p <span class="op">≤</span> <span class="fu">isqrt</span>(n)</span>
<span id="cb7-10"><a href="#cb7-10"></a>        <span class="co"># 2p, 3p, … は素数ではないので削除</span></span>
<span id="cb7-11"><a href="#cb7-11"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">2</span>p<span class="op">:</span>p<span class="op">:</span>n</span>
<span id="cb7-12"><a href="#cb7-12"></a>            list[i] <span class="op">=</span> <span class="cn">false</span></span>
<span id="cb7-13"><a href="#cb7-13"></a>        <span class="cf">end</span></span>
<span id="cb7-14"><a href="#cb7-14"></a>        <span class="co">#@show p bitstring(list)  # 変数の内容を表示する</span></span>
<span id="cb7-15"><a href="#cb7-15"></a>        <span class="co"># 候補から最小の自然数（素数）を選ぶ</span></span>
<span id="cb7-16"><a href="#cb7-16"></a>        p <span class="op">=</span> <span class="fu">findnext</span>(list, p <span class="op">+</span> <span class="fl">1</span>)</span>
<span id="cb7-17"><a href="#cb7-17"></a>    <span class="cf">end</span></span>
<span id="cb7-18"><a href="#cb7-18"></a>    <span class="co"># 残った素数の候補を返す</span></span>
<span id="cb7-19"><a href="#cb7-19"></a>    <span class="cf">return</span> <span class="fu">findall</span>(list)</span>
<span id="cb7-20"><a href="#cb7-20"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="othello.jl" class="level3">
<h3 class="anchored" data-anchor-id="othello.jl">Othello.jl</h3>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1"></a><span class="co"># Othelloモジュールの定義開始</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="kw">module</span> Othello</span>
<span id="cb8-3"><a href="#cb8-3"></a></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="co"># インターフェース（モジュール外から使う型や関数）</span></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="kw">export</span> User, RandomAI, play</span>
<span id="cb8-6"><a href="#cb8-6"></a></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="co"># オセロ石</span></span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="co"># -------</span></span>
<span id="cb8-9"><a href="#cb8-9"></a></span>
<span id="cb8-10"><a href="#cb8-10"></a><span class="co"># 石は文字で表現</span></span>
<span id="cb8-11"><a href="#cb8-11"></a><span class="kw">const</span> Disk <span class="op">=</span> <span class="dt">Char</span></span>
<span id="cb8-12"><a href="#cb8-12"></a><span class="kw">const</span> DISK_EMPTY <span class="op">=</span> <span class="ch">'\u22c5'</span>  <span class="co"># 空き '⋅'</span></span>
<span id="cb8-13"><a href="#cb8-13"></a><span class="kw">const</span> DISK_BLACK <span class="op">=</span> <span class="ch">'\u25cf'</span>  <span class="co"># 黒石 '●'</span></span>
<span id="cb8-14"><a href="#cb8-14"></a><span class="kw">const</span> DISK_WHITE <span class="op">=</span> <span class="ch">'\u25cb'</span>  <span class="co"># 白石 '○'</span></span>
<span id="cb8-15"><a href="#cb8-15"></a></span>
<span id="cb8-16"><a href="#cb8-16"></a><span class="co"># 石を判定する便利関数</span></span>
<span id="cb8-17"><a href="#cb8-17"></a><span class="fu">isblack</span>(disk<span class="op">::</span><span class="dt">Disk</span>) <span class="op">=</span> disk <span class="op">==</span> DISK_BLACK</span>
<span id="cb8-18"><a href="#cb8-18"></a><span class="fu">iswhite</span>(disk<span class="op">::</span><span class="dt">Disk</span>) <span class="op">=</span> disk <span class="op">==</span> DISK_WHITE</span>
<span id="cb8-19"><a href="#cb8-19"></a></span>
<span id="cb8-20"><a href="#cb8-20"></a><span class="co"># 石をひっくり返す関数</span></span>
<span id="cb8-21"><a href="#cb8-21"></a><span class="fu">flip</span>(disk<span class="op">::</span><span class="dt">Disk</span>) <span class="op">=</span></span>
<span id="cb8-22"><a href="#cb8-22"></a>    <span class="fu">isblack</span>(disk) ? DISK_WHITE <span class="op">:</span></span>
<span id="cb8-23"><a href="#cb8-23"></a>    <span class="fu">iswhite</span>(disk) ? DISK_BLACK <span class="op">:</span></span>
<span id="cb8-24"><a href="#cb8-24"></a>    <span class="fu">throw</span>(<span class="fu">ArgumentError</span>(<span class="st">"not flippable"</span>))</span>
<span id="cb8-25"><a href="#cb8-25"></a></span>
<span id="cb8-26"><a href="#cb8-26"></a></span>
<span id="cb8-27"><a href="#cb8-27"></a><span class="co"># 盤上の位置</span></span>
<span id="cb8-28"><a href="#cb8-28"></a><span class="co"># --------</span></span>
<span id="cb8-29"><a href="#cb8-29"></a></span>
<span id="cb8-30"><a href="#cb8-30"></a><span class="kw">const</span> Position <span class="op">=</span> <span class="dt">Tuple</span>{<span class="dt">Char</span>, <span class="dt">Int</span>}  <span class="co"># 位置をタプルで表現</span></span>
<span id="cb8-31"><a href="#cb8-31"></a><span class="kw">const</span> N <span class="op">=</span> <span class="fl">8</span>                        <span class="co"># 盤の1辺のサイズ</span></span>
<span id="cb8-32"><a href="#cb8-32"></a><span class="kw">const</span> ROWS <span class="op">=</span> <span class="fl">1</span><span class="op">:</span>N                   <span class="co"># 行の範囲</span></span>
<span id="cb8-33"><a href="#cb8-33"></a><span class="kw">const</span> COLS <span class="op">=</span> <span class="ch">'a'</span><span class="op">:</span><span class="ch">'a'</span><span class="op">+</span>N<span class="op">-</span><span class="fl">1</span>           <span class="co"># 列の範囲</span></span>
<span id="cb8-34"><a href="#cb8-34"></a></span>
<span id="cb8-35"><a href="#cb8-35"></a><span class="co"># 位置posを行列のインデックスに変換</span></span>
<span id="cb8-36"><a href="#cb8-36"></a><span class="fu">pos2idx</span>(pos<span class="op">::</span><span class="dt">Position</span>) <span class="op">=</span> (pos[<span class="fl">2</span>], pos[<span class="fl">1</span>] <span class="op">-</span> <span class="ch">'a'</span> <span class="op">+</span> <span class="fl">1</span>)</span>
<span id="cb8-37"><a href="#cb8-37"></a></span>
<span id="cb8-38"><a href="#cb8-38"></a><span class="co"># 位置posが盤上にあるかを判定</span></span>
<span id="cb8-39"><a href="#cb8-39"></a><span class="fu">isonboard</span>(pos<span class="op">::</span><span class="dt">Position</span>) <span class="op">=</span> pos[<span class="fl">2</span>] <span class="kw">in</span> ROWS <span class="op">&amp;&amp;</span> pos[<span class="fl">1</span>] <span class="kw">in</span> COLS</span>
<span id="cb8-40"><a href="#cb8-40"></a></span>
<span id="cb8-41"><a href="#cb8-41"></a></span>
<span id="cb8-42"><a href="#cb8-42"></a><span class="co"># オセロ盤</span></span>
<span id="cb8-43"><a href="#cb8-43"></a><span class="co"># -------</span></span>
<span id="cb8-44"><a href="#cb8-44"></a></span>
<span id="cb8-45"><a href="#cb8-45"></a><span class="co"># オセロ盤のデータ型</span></span>
<span id="cb8-46"><a href="#cb8-46"></a><span class="kw">struct</span> Board</span>
<span id="cb8-47"><a href="#cb8-47"></a>    data<span class="op">::</span><span class="dt">Matrix{Disk}  </span><span class="co"># 石の行列（2次元配列）でオセロ盤を表現</span></span>
<span id="cb8-48"><a href="#cb8-48"></a><span class="kw">end</span></span>
<span id="cb8-49"><a href="#cb8-49"></a></span>
<span id="cb8-50"><a href="#cb8-50"></a><span class="co"># オセロ盤を作るコンストラクタ</span></span>
<span id="cb8-51"><a href="#cb8-51"></a><span class="kw">function</span> <span class="fu">Board</span>()</span>
<span id="cb8-52"><a href="#cb8-52"></a>    board <span class="op">=</span> <span class="fu">Board</span>(<span class="fu">fill</span>(DISK_EMPTY, (N, N)))</span>
<span id="cb8-53"><a href="#cb8-53"></a>    <span class="co"># 石の初期配置</span></span>
<span id="cb8-54"><a href="#cb8-54"></a>    board[(<span class="ch">'d'</span>, <span class="fl">5</span>)] <span class="op">=</span> board[(<span class="ch">'e'</span>, <span class="fl">4</span>)] <span class="op">=</span> DISK_BLACK</span>
<span id="cb8-55"><a href="#cb8-55"></a>    board[(<span class="ch">'d'</span>, <span class="fl">4</span>)] <span class="op">=</span> board[(<span class="ch">'e'</span>, <span class="fl">5</span>)] <span class="op">=</span> DISK_WHITE</span>
<span id="cb8-56"><a href="#cb8-56"></a>    <span class="cf">return</span> board</span>
<span id="cb8-57"><a href="#cb8-57"></a><span class="kw">end</span></span>
<span id="cb8-58"><a href="#cb8-58"></a></span>
<span id="cb8-59"><a href="#cb8-59"></a><span class="co"># オセロ盤の石を見る操作</span></span>
<span id="cb8-60"><a href="#cb8-60"></a><span class="bu">Base</span>.<span class="fu">getindex</span>(board<span class="op">::</span><span class="dt">Board</span>, pos<span class="op">::</span><span class="dt">Position</span>) <span class="op">=</span></span>
<span id="cb8-61"><a href="#cb8-61"></a>    board.data[<span class="fu">pos2idx</span>(pos)<span class="op">...</span>]</span>
<span id="cb8-62"><a href="#cb8-62"></a></span>
<span id="cb8-63"><a href="#cb8-63"></a><span class="co"># オセロ盤に石を置く操作</span></span>
<span id="cb8-64"><a href="#cb8-64"></a><span class="kw">function</span> <span class="bu">Base</span>.<span class="fu">setindex!</span>(board<span class="op">::</span><span class="dt">Board</span>, disk<span class="op">::</span><span class="dt">Disk</span>, pos<span class="op">::</span><span class="dt">Position</span>)</span>
<span id="cb8-65"><a href="#cb8-65"></a>    board.data[<span class="fu">pos2idx</span>(pos)<span class="op">...</span>] <span class="op">=</span> disk</span>
<span id="cb8-66"><a href="#cb8-66"></a>    <span class="cf">return</span> board</span>
<span id="cb8-67"><a href="#cb8-67"></a><span class="kw">end</span></span>
<span id="cb8-68"><a href="#cb8-68"></a></span>
<span id="cb8-69"><a href="#cb8-69"></a><span class="co"># オセロ盤の表示</span></span>
<span id="cb8-70"><a href="#cb8-70"></a><span class="kw">function</span> <span class="bu">Base</span>.<span class="fu">show</span>(output<span class="op">::</span><span class="dt">IO</span>, board<span class="op">::</span><span class="dt">Board</span>)</span>
<span id="cb8-71"><a href="#cb8-71"></a>    disks <span class="op">=</span> <span class="fu">countdisks</span>(board)</span>
<span id="cb8-72"><a href="#cb8-72"></a>    <span class="fu">print</span>(output, <span class="st">"Board with </span><span class="sc">$</span>(disks.black)<span class="st"> blacks"</span>)</span>
<span id="cb8-73"><a href="#cb8-73"></a>    <span class="fu">print</span>(output, <span class="st">" and </span><span class="sc">$</span>(disks.white)<span class="st"> whites:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb8-74"><a href="#cb8-74"></a>    <span class="fu">print</span>(output, <span class="st">"  "</span>)</span>
<span id="cb8-75"><a href="#cb8-75"></a>    <span class="cf">for</span> c <span class="kw">in</span> COLS</span>
<span id="cb8-76"><a href="#cb8-76"></a>        <span class="fu">print</span>(output, <span class="ch">' '</span>, c)  <span class="co"># 列の英字表示</span></span>
<span id="cb8-77"><a href="#cb8-77"></a>    <span class="cf">end</span></span>
<span id="cb8-78"><a href="#cb8-78"></a>    <span class="cf">for</span> r <span class="kw">in</span> ROWS</span>
<span id="cb8-79"><a href="#cb8-79"></a>        <span class="fu">print</span>(output, <span class="st">"</span><span class="sc">\n</span><span class="st"> "</span>, r)  <span class="co"># 行の数字表示</span></span>
<span id="cb8-80"><a href="#cb8-80"></a>        <span class="cf">for</span> c <span class="kw">in</span> COLS</span>
<span id="cb8-81"><a href="#cb8-81"></a>            <span class="fu">print</span>(output, <span class="ch">' '</span>, board[(c, r)])</span>
<span id="cb8-82"><a href="#cb8-82"></a>        <span class="cf">end</span></span>
<span id="cb8-83"><a href="#cb8-83"></a>    <span class="cf">end</span></span>
<span id="cb8-84"><a href="#cb8-84"></a><span class="kw">end</span></span>
<span id="cb8-85"><a href="#cb8-85"></a></span>
<span id="cb8-86"><a href="#cb8-86"></a><span class="co"># 盤上にある石のカウント</span></span>
<span id="cb8-87"><a href="#cb8-87"></a><span class="kw">function</span> <span class="fu">countdisks</span>(board<span class="op">::</span><span class="dt">Board</span>)</span>
<span id="cb8-88"><a href="#cb8-88"></a>    black <span class="op">=</span> white <span class="op">=</span> <span class="fl">0</span></span>
<span id="cb8-89"><a href="#cb8-89"></a>    <span class="cf">for</span> c <span class="kw">in</span> COLS, r <span class="kw">in</span> ROWS</span>
<span id="cb8-90"><a href="#cb8-90"></a>        disk <span class="op">=</span> board[(c, r)]</span>
<span id="cb8-91"><a href="#cb8-91"></a>        <span class="cf">if</span> <span class="fu">isblack</span>(disk)</span>
<span id="cb8-92"><a href="#cb8-92"></a>            black <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb8-93"><a href="#cb8-93"></a>        <span class="cf">elseif</span> <span class="fu">iswhite</span>(disk)</span>
<span id="cb8-94"><a href="#cb8-94"></a>            white <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb8-95"><a href="#cb8-95"></a>        <span class="cf">end</span></span>
<span id="cb8-96"><a href="#cb8-96"></a>    <span class="cf">end</span></span>
<span id="cb8-97"><a href="#cb8-97"></a>    <span class="co"># 名前付きタプルを返す</span></span>
<span id="cb8-98"><a href="#cb8-98"></a>    <span class="cf">return</span> (black <span class="op">=</span> black, white <span class="op">=</span> white)</span>
<span id="cb8-99"><a href="#cb8-99"></a><span class="kw">end</span></span>
<span id="cb8-100"><a href="#cb8-100"></a></span>
<span id="cb8-101"><a href="#cb8-101"></a></span>
<span id="cb8-102"><a href="#cb8-102"></a><span class="co"># 石の打ち方</span></span>
<span id="cb8-103"><a href="#cb8-103"></a><span class="co"># --------</span></span>
<span id="cb8-104"><a href="#cb8-104"></a></span>
<span id="cb8-105"><a href="#cb8-105"></a><span class="co"># 方向dirに対してひっくり返せる石を探索</span></span>
<span id="cb8-106"><a href="#cb8-106"></a><span class="kw">function</span> <span class="fu">flips</span>(board<span class="op">::</span><span class="dt">Board</span>, disk<span class="op">::</span><span class="dt">Disk</span>, pos<span class="op">::</span><span class="dt">Position</span>, dir<span class="op">::</span><span class="dt">NTuple{2, Int}</span>)</span>
<span id="cb8-107"><a href="#cb8-107"></a>    dir <span class="op">==</span> (<span class="fl">0</span>, <span class="fl">0</span>) <span class="op">&amp;&amp;</span> <span class="cf">return</span> <span class="cn">nothing</span></span>
<span id="cb8-108"><a href="#cb8-108"></a>    nflips <span class="op">=</span> <span class="fl">0</span>  <span class="co"># ひっくり返せる石の数</span></span>
<span id="cb8-109"><a href="#cb8-109"></a>    <span class="co"># 自分の石を探索</span></span>
<span id="cb8-110"><a href="#cb8-110"></a>    next <span class="op">=</span> pos <span class="op">.+</span> dir</span>
<span id="cb8-111"><a href="#cb8-111"></a>    <span class="cf">while</span> <span class="fu">isonboard</span>(next) <span class="op">&amp;&amp;</span> board[next] <span class="op">==</span> <span class="fu">flip</span>(disk)</span>
<span id="cb8-112"><a href="#cb8-112"></a>        nflips <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb8-113"><a href="#cb8-113"></a>        next <span class="op">=</span> next <span class="op">.+</span> dir</span>
<span id="cb8-114"><a href="#cb8-114"></a>    <span class="cf">end</span></span>
<span id="cb8-115"><a href="#cb8-115"></a>    <span class="co"># 相手の石を挟めているかをチェック</span></span>
<span id="cb8-116"><a href="#cb8-116"></a>    <span class="cf">if</span> nflips <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">&amp;&amp;</span> <span class="fu">isonboard</span>(next) <span class="op">&amp;&amp;</span> board[next] <span class="op">==</span> disk</span>
<span id="cb8-117"><a href="#cb8-117"></a>        <span class="co"># ペアになる石の位置を返す</span></span>
<span id="cb8-118"><a href="#cb8-118"></a>        <span class="cf">return</span> next</span>
<span id="cb8-119"><a href="#cb8-119"></a>    <span class="cf">else</span></span>
<span id="cb8-120"><a href="#cb8-120"></a>        <span class="cf">return</span> <span class="cn">nothing</span></span>
<span id="cb8-121"><a href="#cb8-121"></a>    <span class="cf">end</span></span>
<span id="cb8-122"><a href="#cb8-122"></a><span class="kw">end</span></span>
<span id="cb8-123"><a href="#cb8-123"></a></span>
<span id="cb8-124"><a href="#cb8-124"></a><span class="co"># 有効手か判定</span></span>
<span id="cb8-125"><a href="#cb8-125"></a><span class="kw">function</span> <span class="fu">isvalidmove</span>(board<span class="op">::</span><span class="dt">Board</span>, disk<span class="op">::</span><span class="dt">Disk</span>, pos<span class="op">::</span><span class="dt">Position</span>)</span>
<span id="cb8-126"><a href="#cb8-126"></a>    <span class="fu">isonboard</span>(pos) <span class="op">&amp;&amp;</span></span>
<span id="cb8-127"><a href="#cb8-127"></a>    !<span class="fu">isblack</span>(board[pos]) <span class="op">&amp;&amp;</span></span>
<span id="cb8-128"><a href="#cb8-128"></a>    !<span class="fu">iswhite</span>(board[pos]) <span class="op">||</span> <span class="cf">return</span> <span class="cn">false</span></span>
<span id="cb8-129"><a href="#cb8-129"></a>    dirs <span class="op">=</span> ((u, v) <span class="cf">for</span> u <span class="kw">in</span> <span class="op">-</span><span class="fl">1</span><span class="op">:</span><span class="fl">1</span> <span class="cf">for</span> v <span class="kw">in</span> <span class="op">-</span><span class="fl">1</span><span class="op">:</span><span class="fl">1</span> <span class="cf">if</span> !(u <span class="op">==</span> v <span class="op">==</span> <span class="fl">0</span>))</span>
<span id="cb8-130"><a href="#cb8-130"></a>    <span class="cf">return</span> !<span class="fu">all</span>(isnothing, <span class="fu">flips</span>(board, disk, pos, dir) <span class="cf">for</span> dir <span class="kw">in</span> dirs)</span>
<span id="cb8-131"><a href="#cb8-131"></a><span class="cf">end</span></span>
<span id="cb8-132"><a href="#cb8-132"></a></span>
<span id="cb8-133"><a href="#cb8-133"></a><span class="co"># 石diskを位置posに置いたときの盤面boardの更新</span></span>
<span id="cb8-134"><a href="#cb8-134"></a><span class="kw">function</span> <span class="fu">move!</span>(board<span class="op">::</span><span class="dt">Board</span>, disk<span class="op">::</span><span class="dt">Disk</span>, pos<span class="op">::</span><span class="dt">Position</span>)</span>
<span id="cb8-135"><a href="#cb8-135"></a>    <span class="fu">isvalidmove</span>(board, disk, pos) <span class="op">||</span> <span class="fu">throw</span>(<span class="fu">ArgumentError</span>(<span class="st">"invalid move"</span>))</span>
<span id="cb8-136"><a href="#cb8-136"></a>    board[pos] <span class="op">=</span> disk</span>
<span id="cb8-137"><a href="#cb8-137"></a>    <span class="cf">for</span> u <span class="kw">in</span> <span class="op">-</span><span class="fl">1</span><span class="op">:</span><span class="fl">1</span>, v <span class="kw">in</span> <span class="op">-</span><span class="fl">1</span><span class="op">:</span><span class="fl">1</span></span>
<span id="cb8-138"><a href="#cb8-138"></a>        dir <span class="op">=</span> (u, v)  <span class="co"># ひっくり返す方向</span></span>
<span id="cb8-139"><a href="#cb8-139"></a>        pair <span class="op">=</span> <span class="fu">flips</span>(board, disk, pos, dir)</span>
<span id="cb8-140"><a href="#cb8-140"></a>        <span class="fu">isnothing</span>(pair) <span class="op">&amp;&amp;</span> <span class="cf">continue</span>  <span class="co"># ひっくり返す石がなければスキップ</span></span>
<span id="cb8-141"><a href="#cb8-141"></a>        next <span class="op">=</span> pos <span class="op">.+</span> dir</span>
<span id="cb8-142"><a href="#cb8-142"></a>        <span class="cf">while</span> next <span class="op">!=</span> pair</span>
<span id="cb8-143"><a href="#cb8-143"></a>            board[next] <span class="op">=</span> disk</span>
<span id="cb8-144"><a href="#cb8-144"></a>            next <span class="op">=</span> next <span class="op">.+</span> dir</span>
<span id="cb8-145"><a href="#cb8-145"></a>        <span class="cf">end</span></span>
<span id="cb8-146"><a href="#cb8-146"></a>    <span class="cf">end</span></span>
<span id="cb8-147"><a href="#cb8-147"></a>    <span class="cf">return</span> board</span>
<span id="cb8-148"><a href="#cb8-148"></a><span class="cf">end</span></span>
<span id="cb8-149"><a href="#cb8-149"></a></span>
<span id="cb8-150"><a href="#cb8-150"></a></span>
<span id="cb8-151"><a href="#cb8-151"></a><span class="co"># プレイヤー</span></span>
<span id="cb8-152"><a href="#cb8-152"></a><span class="co"># ---------</span></span>
<span id="cb8-153"><a href="#cb8-153"></a></span>
<span id="cb8-154"><a href="#cb8-154"></a><span class="co"># 抽象的なプレイヤーの型</span></span>
<span id="cb8-155"><a href="#cb8-155"></a><span class="kw">abstract type</span> Player <span class="cf">end</span></span>
<span id="cb8-156"><a href="#cb8-156"></a></span>
<span id="cb8-157"><a href="#cb8-157"></a><span class="co"># ユーザの型</span></span>
<span id="cb8-158"><a href="#cb8-158"></a><span class="st">"""</span></span>
<span id="cb8-159"><a href="#cb8-159"></a><span class="st">An interactive human player.</span></span>
<span id="cb8-160"><a href="#cb8-160"></a><span class="st">"""</span></span>
<span id="cb8-161"><a href="#cb8-161"></a><span class="kw">struct</span> User <span class="op">&lt;:</span><span class="dt"> Player</span></span>
<span id="cb8-162"><a href="#cb8-162"></a>    name<span class="op">::</span><span class="dt">String</span></span>
<span id="cb8-163"><a href="#cb8-163"></a><span class="cf">end</span></span>
<span id="cb8-164"><a href="#cb8-164"></a></span>
<span id="cb8-165"><a href="#cb8-165"></a><span class="co"># プレイヤー名を取得</span></span>
<span id="cb8-166"><a href="#cb8-166"></a><span class="fu">name</span>(user<span class="op">::</span><span class="dt">User</span>) <span class="op">=</span> user.name</span>
<span id="cb8-167"><a href="#cb8-167"></a></span>
<span id="cb8-168"><a href="#cb8-168"></a><span class="co"># ユーザに次の手を入力させる</span></span>
<span id="cb8-169"><a href="#cb8-169"></a><span class="kw">function</span> <span class="fu">move</span>(<span class="op">::</span><span class="dt">User</span>, <span class="op">::</span><span class="dt">Disk</span>, <span class="op">::</span><span class="dt">Board</span>)</span>
<span id="cb8-170"><a href="#cb8-170"></a>    <span class="cf">while</span> <span class="cn">true</span></span>
<span id="cb8-171"><a href="#cb8-171"></a>        input <span class="op">=</span> <span class="fu">prompt</span>(<span class="st">"move&gt; "</span>)</span>
<span id="cb8-172"><a href="#cb8-172"></a>        <span class="cf">if</span> <span class="fu">isnothing</span>(input) <span class="op">||</span> <span class="fu">lowercase</span>(input) <span class="op">==</span> <span class="st">"resign"</span></span>
<span id="cb8-173"><a href="#cb8-173"></a>            <span class="cf">return</span> <span class="cn">nothing</span></span>
<span id="cb8-174"><a href="#cb8-174"></a>        <span class="cf">elseif</span> <span class="fu">contains</span>(input, <span class="st">r"^</span><span class="ch">[</span><span class="st">a-h</span><span class="ch">][</span><span class="st">1-8</span><span class="ch">]</span><span class="sc">$</span><span class="st">"</span>i<span class="ch">)</span></span>
<span id="cb8-175"><a href="#cb8-175"></a>            c <span class="op">=</span> <span class="fu">lowercase</span>(input[<span class="fl">1</span>])</span>
<span id="cb8-176"><a href="#cb8-176"></a>            r <span class="op">=</span> input[<span class="fl">2</span>] <span class="op">-</span> <span class="ch">'0'</span></span>
<span id="cb8-177"><a href="#cb8-177"></a>            <span class="cf">return</span> (c, r)</span>
<span id="cb8-178"><a href="#cb8-178"></a>        <span class="cf">end</span></span>
<span id="cb8-179"><a href="#cb8-179"></a>        <span class="fu">println</span>(<span class="st">"Invalid input; try again (e.g. f5)."</span>)</span>
<span id="cb8-180"><a href="#cb8-180"></a>    <span class="cf">end</span></span>
<span id="cb8-181"><a href="#cb8-181"></a><span class="kw">end</span></span>
<span id="cb8-182"><a href="#cb8-182"></a></span>
<span id="cb8-183"><a href="#cb8-183"></a><span class="co"># プロンプトを表示して入力させる</span></span>
<span id="cb8-184"><a href="#cb8-184"></a><span class="kw">function</span> <span class="fu">prompt</span>(msg<span class="op">::</span><span class="dt">String</span>)</span>
<span id="cb8-185"><a href="#cb8-185"></a>    <span class="fu">print</span>(msg)</span>
<span id="cb8-186"><a href="#cb8-186"></a>    input <span class="op">=</span> <span class="fu">readline</span>(<span class="cn">stdin</span>)</span>
<span id="cb8-187"><a href="#cb8-187"></a>    <span class="cf">return</span> <span class="fu">isopen</span>(<span class="cn">stdin</span>) ? <span class="fu">strip</span>(input) <span class="op">:</span> <span class="cn">nothing</span></span>
<span id="cb8-188"><a href="#cb8-188"></a><span class="kw">end</span></span>
<span id="cb8-189"><a href="#cb8-189"></a></span>
<span id="cb8-190"><a href="#cb8-190"></a><span class="co"># 人工知能の型</span></span>
<span id="cb8-191"><a href="#cb8-191"></a><span class="st">"""</span></span>
<span id="cb8-192"><a href="#cb8-192"></a><span class="st">A foolish AI player playing random moves.</span></span>
<span id="cb8-193"><a href="#cb8-193"></a><span class="st">"""</span></span>
<span id="cb8-194"><a href="#cb8-194"></a><span class="kw">struct</span> RandomAI <span class="op">&lt;:</span><span class="dt"> Player</span></span>
<span id="cb8-195"><a href="#cb8-195"></a>    name<span class="op">::</span><span class="dt">String</span></span>
<span id="cb8-196"><a href="#cb8-196"></a><span class="kw">end</span></span>
<span id="cb8-197"><a href="#cb8-197"></a></span>
<span id="cb8-198"><a href="#cb8-198"></a><span class="co"># プレイヤー名を取得</span></span>
<span id="cb8-199"><a href="#cb8-199"></a><span class="fu">name</span>(ai<span class="op">::</span><span class="dt">RandomAI</span>) <span class="op">=</span> ai.name</span>
<span id="cb8-200"><a href="#cb8-200"></a></span>
<span id="cb8-201"><a href="#cb8-201"></a><span class="co"># 人工知能に次の手を決めさせる</span></span>
<span id="cb8-202"><a href="#cb8-202"></a><span class="kw">function</span> <span class="fu">move</span>(<span class="op">::</span><span class="dt">RandomAI</span>, disk<span class="op">::</span><span class="dt">Disk</span>, board<span class="op">::</span><span class="dt">Board</span>)</span>
<span id="cb8-203"><a href="#cb8-203"></a>    moves <span class="op">=</span> Position[]</span>
<span id="cb8-204"><a href="#cb8-204"></a>    <span class="cf">for</span> c <span class="kw">in</span> COLS, r <span class="kw">in</span> ROWS</span>
<span id="cb8-205"><a href="#cb8-205"></a>        pos <span class="op">=</span> (c, r)</span>
<span id="cb8-206"><a href="#cb8-206"></a>        <span class="cf">if</span> <span class="fu">isvalidmove</span>(board, disk, pos)</span>
<span id="cb8-207"><a href="#cb8-207"></a>            <span class="fu">push!</span>(moves, pos)</span>
<span id="cb8-208"><a href="#cb8-208"></a>        <span class="cf">end</span></span>
<span id="cb8-209"><a href="#cb8-209"></a>    <span class="cf">end</span></span>
<span id="cb8-210"><a href="#cb8-210"></a>    <span class="cf">return</span> <span class="fu">rand</span>(moves)</span>
<span id="cb8-211"><a href="#cb8-211"></a><span class="kw">end</span></span>
<span id="cb8-212"><a href="#cb8-212"></a></span>
<span id="cb8-213"><a href="#cb8-213"></a></span>
<span id="cb8-214"><a href="#cb8-214"></a><span class="co"># ゲーム</span></span>
<span id="cb8-215"><a href="#cb8-215"></a><span class="co"># -----</span></span>
<span id="cb8-216"><a href="#cb8-216"></a></span>
<span id="cb8-217"><a href="#cb8-217"></a><span class="co"># ゲームの結果</span></span>
<span id="cb8-218"><a href="#cb8-218"></a><span class="kw">struct</span> Result</span>
<span id="cb8-219"><a href="#cb8-219"></a>    board<span class="op">::</span><span class="dt">Board                    </span><span class="co"># 終局盤面</span></span>
<span id="cb8-220"><a href="#cb8-220"></a>    black<span class="op">::</span><span class="dt">Player                   </span><span class="co"># 黒石を持ったプレイヤー　</span></span>
<span id="cb8-221"><a href="#cb8-221"></a>    white<span class="op">::</span><span class="dt">Player                   </span><span class="co"># 白石を持ったプレイヤー</span></span>
<span id="cb8-222"><a href="#cb8-222"></a>    resigned<span class="op">::</span><span class="dt">Union{Disk, Nothing}  </span><span class="co"># 投了した石の色</span></span>
<span id="cb8-223"><a href="#cb8-223"></a><span class="kw">end</span></span>
<span id="cb8-224"><a href="#cb8-224"></a></span>
<span id="cb8-225"><a href="#cb8-225"></a><span class="co"># 出力に使うマクロの読込み</span></span>
<span id="cb8-226"><a href="#cb8-226"></a><span class="im">using</span> <span class="bu">Printf</span>: @printf</span>
<span id="cb8-227"><a href="#cb8-227"></a></span>
<span id="cb8-228"><a href="#cb8-228"></a><span class="co"># 結果の表示</span></span>
<span id="cb8-229"><a href="#cb8-229"></a><span class="kw">function</span> <span class="bu">Base</span>.<span class="fu">show</span>(output<span class="op">::</span><span class="dt">IO</span>, result<span class="op">::</span><span class="dt">Result</span>)</span>
<span id="cb8-230"><a href="#cb8-230"></a>    <span class="fu">report</span>(disk, count, player) <span class="op">=</span></span>
<span id="cb8-231"><a href="#cb8-231"></a>        <span class="pp">@printf</span> output <span class="st">"%s×%2d %s</span><span class="sc">\n</span><span class="st">"</span> disk count <span class="fu">name</span>(player)</span>
<span id="cb8-232"><a href="#cb8-232"></a>    disks <span class="op">=</span> <span class="fu">countdisks</span>(result.board)</span>
<span id="cb8-233"><a href="#cb8-233"></a>    <span class="fu">report</span>(DISK_BLACK, disks.black, result.black)</span>
<span id="cb8-234"><a href="#cb8-234"></a>    <span class="fu">report</span>(DISK_WHITE, disks.white, result.white)</span>
<span id="cb8-235"><a href="#cb8-235"></a>    resigned <span class="op">=</span> result.resigned</span>
<span id="cb8-236"><a href="#cb8-236"></a>    <span class="cf">if</span> <span class="fu">isnothing</span>(resigned)</span>
<span id="cb8-237"><a href="#cb8-237"></a>        x <span class="op">=</span> <span class="fu">cmp</span>(disks.black, disks.white)</span>
<span id="cb8-238"><a href="#cb8-238"></a>        msg <span class="op">=</span> x <span class="op">&lt;</span> <span class="fl">0</span> ? <span class="st">"white winned"</span> <span class="op">:</span></span>
<span id="cb8-239"><a href="#cb8-239"></a>              x <span class="op">&gt;</span> <span class="fl">0</span> ? <span class="st">"black winned"</span> <span class="op">:</span> <span class="st">"draw"</span></span>
<span id="cb8-240"><a href="#cb8-240"></a>    <span class="cf">else</span></span>
<span id="cb8-241"><a href="#cb8-241"></a>        <span class="pp">@assert</span> <span class="fu">isblack</span>(resigned) <span class="op">||</span> <span class="fu">iswhite</span>(resigned)</span>
<span id="cb8-242"><a href="#cb8-242"></a>        color <span class="op">=</span> <span class="fu">isblack</span>(resigned) ? <span class="st">"black"</span> <span class="op">:</span> <span class="st">"white"</span></span>
<span id="cb8-243"><a href="#cb8-243"></a>        msg <span class="op">=</span> <span class="st">"</span><span class="sc">$</span>(color)<span class="st"> resigned"</span></span>
<span id="cb8-244"><a href="#cb8-244"></a>    <span class="cf">end</span></span>
<span id="cb8-245"><a href="#cb8-245"></a>    <span class="fu">print</span>(output, msg)</span>
<span id="cb8-246"><a href="#cb8-246"></a><span class="kw">end</span></span>
<span id="cb8-247"><a href="#cb8-247"></a></span>
<span id="cb8-248"><a href="#cb8-248"></a><span class="co"># ゲームを開始する関数</span></span>
<span id="cb8-249"><a href="#cb8-249"></a><span class="st">"""</span></span>
<span id="cb8-250"><a href="#cb8-250"></a><span class="st">    play(; black, white)</span></span>
<span id="cb8-251"><a href="#cb8-251"></a></span>
<span id="cb8-252"><a href="#cb8-252"></a><span class="st">Start playing a game.</span></span>
<span id="cb8-253"><a href="#cb8-253"></a></span>
<span id="cb8-254"><a href="#cb8-254"></a><span class="st"># Arguments</span></span>
<span id="cb8-255"><a href="#cb8-255"></a><span class="st">- `black`:</span></span>
<span id="cb8-256"><a href="#cb8-256"></a><span class="st">    a player making the first move.</span></span>
<span id="cb8-257"><a href="#cb8-257"></a><span class="st">    `User` with a random name is the default.</span></span>
<span id="cb8-258"><a href="#cb8-258"></a><span class="st">- `white`:</span></span>
<span id="cb8-259"><a href="#cb8-259"></a><span class="st">    a player making the second move.</span></span>
<span id="cb8-260"><a href="#cb8-260"></a><span class="st">    `RandomAI` with a random name is the default.</span></span>
<span id="cb8-261"><a href="#cb8-261"></a><span class="st">"""</span></span>
<span id="cb8-262"><a href="#cb8-262"></a><span class="kw">function</span> <span class="fu">play</span>(;</span>
<span id="cb8-263"><a href="#cb8-263"></a>    black<span class="op">::</span><span class="dt">Player </span><span class="op">=</span> <span class="fu">User</span>(<span class="fu">randname</span>(DISK_BLACK)),</span>
<span id="cb8-264"><a href="#cb8-264"></a>    white<span class="op">::</span><span class="dt">Player </span><span class="op">=</span> <span class="fu">RandomAI</span>(<span class="fu">randname</span>(DISK_WHITE)),</span>
<span id="cb8-265"><a href="#cb8-265"></a>)</span>
<span id="cb8-266"><a href="#cb8-266"></a>    <span class="fu">print</span>(<span class="st">"</span><span class="sc">$</span>(DISK_BLACK)<span class="st"> </span><span class="sc">$</span>(<span class="fu">name</span>(black))<span class="st"> vs "</span>)</span>
<span id="cb8-267"><a href="#cb8-267"></a>    <span class="fu">print</span>(<span class="st">"</span><span class="sc">$</span>(DISK_WHITE)<span class="st"> </span><span class="sc">$</span>(<span class="fu">name</span>(white))<span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb8-268"><a href="#cb8-268"></a>    board <span class="op">=</span> <span class="fu">Board</span>()  <span class="co"># 初期盤面の作成</span></span>
<span id="cb8-269"><a href="#cb8-269"></a>    nextdisk <span class="op">=</span> <span class="fu">alternatedisks</span>(board)  <span class="co"># 次に打つ石を決める関数</span></span>
<span id="cb8-270"><a href="#cb8-270"></a>    <span class="cf">while</span> <span class="cn">true</span></span>
<span id="cb8-271"><a href="#cb8-271"></a>        <span class="fu">println</span>(<span class="ch">'\n'</span>, board)</span>
<span id="cb8-272"><a href="#cb8-272"></a>        disk <span class="op">=</span> <span class="fu">nextdisk</span>()  <span class="co"># 次の石を取得</span></span>
<span id="cb8-273"><a href="#cb8-273"></a>        <span class="cf">if</span> <span class="fu">isnothing</span>(disk)</span>
<span id="cb8-274"><a href="#cb8-274"></a>            <span class="co"># 双方次手なし</span></span>
<span id="cb8-275"><a href="#cb8-275"></a>            <span class="cf">return</span> <span class="fu">Result</span>(board, black, white, <span class="cn">nothing</span>)</span>
<span id="cb8-276"><a href="#cb8-276"></a>        <span class="cf">end</span></span>
<span id="cb8-277"><a href="#cb8-277"></a>        player <span class="op">=</span> <span class="fu">isblack</span>(disk) ? black <span class="op">:</span> white</span>
<span id="cb8-278"><a href="#cb8-278"></a>        playername <span class="op">=</span> <span class="fu">name</span>(player)</span>
<span id="cb8-279"><a href="#cb8-279"></a>        <span class="fu">println</span>(<span class="st">"</span><span class="sc">$</span>(disk)<span class="st"> </span><span class="sc">$</span>(playername)<span class="st">'s turn"</span>)</span>
<span id="cb8-280"><a href="#cb8-280"></a>        pos <span class="op">=</span> <span class="fu">getmove</span>(player, disk, board)</span>
<span id="cb8-281"><a href="#cb8-281"></a>        <span class="cf">if</span> <span class="fu">isnothing</span>(pos)</span>
<span id="cb8-282"><a href="#cb8-282"></a>            <span class="co"># 投了</span></span>
<span id="cb8-283"><a href="#cb8-283"></a>            <span class="fu">println</span>(playername, <span class="st">" has resigned."</span>)</span>
<span id="cb8-284"><a href="#cb8-284"></a>            <span class="cf">return</span> <span class="fu">Result</span>(board, black, white, disk)</span>
<span id="cb8-285"><a href="#cb8-285"></a>        <span class="cf">else</span></span>
<span id="cb8-286"><a href="#cb8-286"></a>            <span class="pp">@assert</span> <span class="fu">isvalidmove</span>(board, disk, pos)</span>
<span id="cb8-287"><a href="#cb8-287"></a>            <span class="fu">move!</span>(board, disk, pos)  <span class="co"># 石を設置</span></span>
<span id="cb8-288"><a href="#cb8-288"></a>            <span class="fu">println</span>(<span class="st">"</span><span class="sc">$</span>(playername)<span class="st"> placed at </span><span class="sc">$</span>(pos[<span class="fl">1</span>])<span class="sc">$</span>(pos[<span class="fl">2</span>])<span class="st">."</span>)</span>
<span id="cb8-289"><a href="#cb8-289"></a>        <span class="cf">end</span></span>
<span id="cb8-290"><a href="#cb8-290"></a>    <span class="cf">end</span></span>
<span id="cb8-291"><a href="#cb8-291"></a><span class="kw">end</span></span>
<span id="cb8-292"><a href="#cb8-292"></a></span>
<span id="cb8-293"><a href="#cb8-293"></a><span class="co"># プレイヤーの手を決定</span></span>
<span id="cb8-294"><a href="#cb8-294"></a><span class="kw">function</span> <span class="fu">getmove</span>(player<span class="op">::</span><span class="dt">Player</span>, disk<span class="op">::</span><span class="dt">Disk</span>, board<span class="op">::</span><span class="dt">Board</span>)</span>
<span id="cb8-295"><a href="#cb8-295"></a>    <span class="cf">while</span> <span class="cn">true</span></span>
<span id="cb8-296"><a href="#cb8-296"></a>        pos <span class="op">=</span> <span class="fu">move</span>(player, disk, board)</span>
<span id="cb8-297"><a href="#cb8-297"></a>        <span class="cf">if</span> <span class="fu">isnothing</span>(pos) <span class="op">||</span> <span class="fu">isvalidmove</span>(board, disk, pos)</span>
<span id="cb8-298"><a href="#cb8-298"></a>            <span class="co"># 投了または有効手</span></span>
<span id="cb8-299"><a href="#cb8-299"></a>            <span class="cf">return</span> pos</span>
<span id="cb8-300"><a href="#cb8-300"></a>        <span class="cf">end</span></span>
<span id="cb8-301"><a href="#cb8-301"></a>        <span class="co"># 無効手（選び直し）</span></span>
<span id="cb8-302"><a href="#cb8-302"></a>        <span class="fu">println</span>(<span class="st">"You cannot move that position."</span>)</span>
<span id="cb8-303"><a href="#cb8-303"></a>    <span class="cf">end</span></span>
<span id="cb8-304"><a href="#cb8-304"></a><span class="kw">end</span></span>
<span id="cb8-305"><a href="#cb8-305"></a></span>
<span id="cb8-306"><a href="#cb8-306"></a><span class="co"># プレイヤー名を生成</span></span>
<span id="cb8-307"><a href="#cb8-307"></a><span class="kw">const</span> BLACK_NAMES <span class="op">=</span> (<span class="st">"Panther"</span>, <span class="st">"Hawk"</span>, <span class="st">"Stingray"</span>)</span>
<span id="cb8-308"><a href="#cb8-308"></a><span class="kw">const</span> WHITE_NAMES <span class="op">=</span> (<span class="st">"Tiger"</span>, <span class="st">"Parrot"</span>, <span class="st">"Shark"</span>)</span>
<span id="cb8-309"><a href="#cb8-309"></a><span class="fu">randname</span>(disk<span class="op">::</span><span class="dt">Disk</span>) <span class="op">=</span></span>
<span id="cb8-310"><a href="#cb8-310"></a>    <span class="fu">isblack</span>(disk) ? <span class="st">"Black </span><span class="sc">$</span>(<span class="fu">rand</span>(BLACK_NAMES))<span class="st">"</span> <span class="op">:</span></span>
<span id="cb8-311"><a href="#cb8-311"></a>    <span class="fu">iswhite</span>(disk) ? <span class="st">"White </span><span class="sc">$</span>(<span class="fu">rand</span>(WHITE_NAMES))<span class="st">"</span> <span class="op">:</span></span>
<span id="cb8-312"><a href="#cb8-312"></a>    <span class="fu">throw</span>(<span class="fu">ArgumentError</span>(<span class="st">"invalid disk"</span>))</span>
<span id="cb8-313"><a href="#cb8-313"></a></span>
<span id="cb8-314"><a href="#cb8-314"></a><span class="co"># 「次の石を選ぶ関数（クロージャ）」を返す関数</span></span>
<span id="cb8-315"><a href="#cb8-315"></a><span class="kw">function</span> <span class="fu">alternatedisks</span>(board<span class="op">::</span><span class="dt">Board</span>)</span>
<span id="cb8-316"><a href="#cb8-316"></a>    next <span class="op">=</span> DISK_BLACK  <span class="co"># 初手は黒石</span></span>
<span id="cb8-317"><a href="#cb8-317"></a>    <span class="fu">canmove</span>() <span class="op">=</span>  <span class="co"># nextに打つ手があるかを判定</span></span>
<span id="cb8-318"><a href="#cb8-318"></a>        <span class="fu">any</span>(<span class="fu">isvalidmove</span>(board, next, (c, r))</span>
<span id="cb8-319"><a href="#cb8-319"></a>            <span class="cf">for</span> c <span class="kw">in</span> COLS, r <span class="kw">in</span> ROWS)</span>
<span id="cb8-320"><a href="#cb8-320"></a>    <span class="cf">return</span> <span class="kw">function</span> ()  <span class="co"># クロージャを返す</span></span>
<span id="cb8-321"><a href="#cb8-321"></a>        <span class="cf">if</span> !<span class="fu">canmove</span>()</span>
<span id="cb8-322"><a href="#cb8-322"></a>            next <span class="op">=</span> <span class="fu">flip</span>(next)</span>
<span id="cb8-323"><a href="#cb8-323"></a>            <span class="fu">canmove</span>() <span class="op">||</span> <span class="cf">return</span> <span class="cn">nothing</span></span>
<span id="cb8-324"><a href="#cb8-324"></a>        <span class="cf">end</span></span>
<span id="cb8-325"><a href="#cb8-325"></a>        disk <span class="op">=</span> next</span>
<span id="cb8-326"><a href="#cb8-326"></a>        next <span class="op">=</span> <span class="fu">flip</span>(next)  <span class="co"># 次の石に状態を更新</span></span>
<span id="cb8-327"><a href="#cb8-327"></a>        <span class="cf">return</span> disk</span>
<span id="cb8-328"><a href="#cb8-328"></a>    <span class="cf">end</span></span>
<span id="cb8-329"><a href="#cb8-329"></a><span class="kw">end</span></span>
<span id="cb8-330"><a href="#cb8-330"></a></span>
<span id="cb8-331"><a href="#cb8-331"></a><span class="kw">end</span>  <span class="co"># Othelloモジュールの定義終了</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="章-3" class="level2">
<h2 class="anchored" data-anchor-id="章-3">6章</h2>
<section id="printchars.jl" class="level3">
<h3 class="anchored" data-anchor-id="printchars.jl">printchars.jl</h3>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">function</span> <span class="fu">printchars</span>(s)</span>
<span id="cb9-2"><a href="#cb9-2"></a>    fi, li <span class="op">=</span> <span class="fu">firstindex</span>(s), <span class="fu">lastindex</span>(s)</span>
<span id="cb9-3"><a href="#cb9-3"></a>    i <span class="op">=</span> fi</span>
<span id="cb9-4"><a href="#cb9-4"></a>    <span class="cf">while</span> i <span class="op">≤</span> li</span>
<span id="cb9-5"><a href="#cb9-5"></a>        i <span class="op">&gt;</span> fi <span class="op">&amp;&amp;</span> <span class="fu">print</span>(<span class="ch">'/'</span>)</span>
<span id="cb9-6"><a href="#cb9-6"></a>        <span class="fu">print</span>(s[i])</span>
<span id="cb9-7"><a href="#cb9-7"></a>        i <span class="op">=</span> <span class="fu">nextind</span>(s, i)</span>
<span id="cb9-8"><a href="#cb9-8"></a>    <span class="cf">end</span></span>
<span id="cb9-9"><a href="#cb9-9"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="章-4" class="level2">
<h2 class="anchored" data-anchor-id="章-4">7章</h2>
<section id="lastitem.jl" class="level3">
<h3 class="anchored" data-anchor-id="lastitem.jl">lastitem.jl</h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1"></a><span class="kw">function</span> <span class="fu">lastitem</span>(xs)</span>
<span id="cb10-2"><a href="#cb10-2"></a>    <span class="kw">local</span> last</span>
<span id="cb10-3"><a href="#cb10-3"></a>    <span class="cf">for</span> x <span class="kw">in</span> xs</span>
<span id="cb10-4"><a href="#cb10-4"></a>        last <span class="op">=</span> x</span>
<span id="cb10-5"><a href="#cb10-5"></a>    <span class="cf">end</span></span>
<span id="cb10-6"><a href="#cb10-6"></a>    <span class="cf">return</span> <span class="pp">@isdefined</span>(last) ? last <span class="op">:</span> <span class="cn">nothing</span></span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="fib.jl" class="level3">
<h3 class="anchored" data-anchor-id="fib.jl">fib.jl</h3>
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb11-1"><a href="#cb11-1"></a><span class="co"># 通常の関数定義</span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="kw">function</span> <span class="fu">fib</span>(n)</span>
<span id="cb11-3"><a href="#cb11-3"></a>    <span class="cf">if</span> n <span class="op">≤</span> <span class="fl">2</span></span>
<span id="cb11-4"><a href="#cb11-4"></a>        <span class="cf">return</span> <span class="fl">1</span></span>
<span id="cb11-5"><a href="#cb11-5"></a>    <span class="cf">else</span></span>
<span id="cb11-6"><a href="#cb11-6"></a>        <span class="cf">return</span> <span class="fu">fib</span>(n <span class="op">-</span> <span class="fl">1</span>) <span class="op">+</span> <span class="fu">fib</span>(n <span class="op">-</span> <span class="fl">2</span>)</span>
<span id="cb11-7"><a href="#cb11-7"></a>    <span class="cf">end</span></span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="kw">end</span></span>
<span id="cb11-9"><a href="#cb11-9"></a></span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="co"># 1行関数定義</span></span>
<span id="cb11-11"><a href="#cb11-11"></a><span class="fu">fib</span>(n) <span class="op">=</span> n <span class="op">≤</span> <span class="fl">2</span> ? <span class="fl">1</span> <span class="op">:</span> <span class="fu">fib</span>(n <span class="op">-</span> <span class="fl">1</span>) <span class="op">+</span> <span class="fu">fib</span>(n <span class="op">-</span> <span class="fl">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="min.jl" class="level3">
<h3 class="anchored" data-anchor-id="min.jl">min.jl</h3>
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1"></a><span class="co"># 引数の最小値を返す関数</span></span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="kw">function</span> <span class="fu">min</span>(x1, xs<span class="op">...</span>)</span>
<span id="cb12-3"><a href="#cb12-3"></a>    ret <span class="op">=</span> x1</span>
<span id="cb12-4"><a href="#cb12-4"></a>    <span class="cf">for</span> x <span class="kw">in</span> xs</span>
<span id="cb12-5"><a href="#cb12-5"></a>        <span class="cf">if</span> <span class="fu">isless</span>(x, ret)</span>
<span id="cb12-6"><a href="#cb12-6"></a>            ret <span class="op">=</span> x</span>
<span id="cb12-7"><a href="#cb12-7"></a>        <span class="cf">end</span></span>
<span id="cb12-8"><a href="#cb12-8"></a>    <span class="cf">end</span></span>
<span id="cb12-9"><a href="#cb12-9"></a>    <span class="cf">return</span> ret</span>
<span id="cb12-10"><a href="#cb12-10"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="章-5" class="level2">
<h2 class="anchored" data-anchor-id="章-5">8章</h2>
<section id="periodictable.jl" class="level3">
<h3 class="anchored" data-anchor-id="periodictable.jl">periodictable.jl</h3>
<div class="sourceCode" id="cb13"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb13-1"><a href="#cb13-1"></a><span class="co"># 元素（chemical element）</span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="kw">struct</span> ChemElem</span>
<span id="cb13-3"><a href="#cb13-3"></a>    number<span class="op">::</span><span class="dt">Int</span></span>
<span id="cb13-4"><a href="#cb13-4"></a>    symbol<span class="op">::</span><span class="dt">String</span></span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="kw">end</span></span>
<span id="cb13-6"><a href="#cb13-6"></a></span>
<span id="cb13-7"><a href="#cb13-7"></a><span class="co"># 周期表（periodic table）</span></span>
<span id="cb13-8"><a href="#cb13-8"></a><span class="kw">struct</span> PeriodicTable</span>
<span id="cb13-9"><a href="#cb13-9"></a>    elements<span class="op">::</span><span class="dt">Vector{ChemElem}  </span><span class="co"># 元素</span></span>
<span id="cb13-10"><a href="#cb13-10"></a>    groups<span class="op">::</span><span class="dt">Vector{Int}         </span><span class="co"># 族</span></span>
<span id="cb13-11"><a href="#cb13-11"></a>    periods<span class="op">::</span><span class="dt">Vector{Int}        </span><span class="co"># 周期</span></span>
<span id="cb13-12"><a href="#cb13-12"></a><span class="kw">end</span></span>
<span id="cb13-13"><a href="#cb13-13"></a></span>
<span id="cb13-14"><a href="#cb13-14"></a><span class="co"># 簡単のため原子番号1−6のみ</span></span>
<span id="cb13-15"><a href="#cb13-15"></a>table <span class="op">=</span> <span class="fu">PeriodicTable</span>(</span>
<span id="cb13-16"><a href="#cb13-16"></a>    <span class="co"># elements</span></span>
<span id="cb13-17"><a href="#cb13-17"></a>    [<span class="fu">ChemElem</span>(<span class="fl">1</span>, <span class="st">"H"</span>), <span class="fu">ChemElem</span>(<span class="fl">2</span>, <span class="st">"He"</span>), <span class="fu">ChemElem</span>(<span class="fl">3</span>, <span class="st">"Li"</span>),</span>
<span id="cb13-18"><a href="#cb13-18"></a>     <span class="fu">ChemElem</span>(<span class="fl">4</span>, <span class="st">"Be"</span>), <span class="fu">ChemElem</span>(<span class="fl">5</span>, <span class="st">"B"</span>), <span class="fu">ChemElem</span>(<span class="fl">6</span>, <span class="st">"C"</span>)],</span>
<span id="cb13-19"><a href="#cb13-19"></a>    <span class="co"># groups</span></span>
<span id="cb13-20"><a href="#cb13-20"></a>    [<span class="fl">1</span>, <span class="fl">18</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">13</span>, <span class="fl">14</span>],</span>
<span id="cb13-21"><a href="#cb13-21"></a>    <span class="co"># periods</span></span>
<span id="cb13-22"><a href="#cb13-22"></a>    [<span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>]</span>
<span id="cb13-23"><a href="#cb13-23"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="reportfields.jl" class="level3">
<h3 class="anchored" data-anchor-id="reportfields.jl">reportfields.jl</h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb14-1"><a href="#cb14-1"></a><span class="co"># 構造体型の構造を出力</span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="kw">function</span> <span class="fu">reportfields</span>(T)</span>
<span id="cb14-3"><a href="#cb14-3"></a>    <span class="fu">println</span>(T)</span>
<span id="cb14-4"><a href="#cb14-4"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu">fieldcount</span>(T)</span>
<span id="cb14-5"><a href="#cb14-5"></a>        name <span class="op">=</span> <span class="fu">fieldname</span>(T, i)</span>
<span id="cb14-6"><a href="#cb14-6"></a>        <span class="kw">type</span> <span class="op">=</span> <span class="fu">fieldtype</span>(T, i)</span>
<span id="cb14-7"><a href="#cb14-7"></a>        <span class="fu">println</span>(<span class="st">"  [</span><span class="sc">$</span>(i)<span class="st">] </span><span class="sc">$</span>(name)<span class="st"> :: </span><span class="sc">$</span>(<span class="kw">type</span>)<span class="st">"</span>)</span>
<span id="cb14-8"><a href="#cb14-8"></a>    <span class="cf">end</span></span>
<span id="cb14-9"><a href="#cb14-9"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="章-6" class="level2">
<h2 class="anchored" data-anchor-id="章-6">9章</h2>
<section id="circle.jl" class="level3">
<h3 class="anchored" data-anchor-id="circle.jl">circle.jl</h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb15-1"><a href="#cb15-1"></a><span class="kw">struct</span> Circle</span>
<span id="cb15-2"><a href="#cb15-2"></a>    r<span class="op">::</span><span class="dt">Float64   </span><span class="co"># 半径</span></span>
<span id="cb15-3"><a href="#cb15-3"></a>    cx<span class="op">::</span><span class="dt">Float64  </span><span class="co"># 中心のx座標</span></span>
<span id="cb15-4"><a href="#cb15-4"></a>    cy<span class="op">::</span><span class="dt">Float64  </span><span class="co"># 中心のy座標</span></span>
<span id="cb15-5"><a href="#cb15-5"></a></span>
<span id="cb15-6"><a href="#cb15-6"></a>    <span class="co"># 内部コンストラクタ</span></span>
<span id="cb15-7"><a href="#cb15-7"></a>    <span class="kw">function</span> <span class="fu">Circle</span>(r<span class="op">::</span><span class="dt">Real</span>, cx<span class="op">::</span><span class="dt">Real</span>, cy<span class="op">::</span><span class="dt">Real</span>)</span>
<span id="cb15-8"><a href="#cb15-8"></a>        r <span class="op">≥</span> <span class="fl">0</span> <span class="op">||</span> <span class="fu">throw</span>(<span class="fu">ArgumentError</span>(<span class="st">"r must be non-negative"</span>))</span>
<span id="cb15-9"><a href="#cb15-9"></a>        <span class="cf">return</span> <span class="fu">new</span>(r, cx, cy)</span>
<span id="cb15-10"><a href="#cb15-10"></a>    <span class="kw">end</span></span>
<span id="cb15-11"><a href="#cb15-11"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="rgb.jl" class="level3">
<h3 class="anchored" data-anchor-id="rgb.jl">rgb.jl</h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb16-1"><a href="#cb16-1"></a><span class="co"># RGB色モデル（true color）</span></span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="kw">struct</span> RGB</span>
<span id="cb16-3"><a href="#cb16-3"></a>    r<span class="op">::</span><span class="dt">UInt8  </span><span class="co"># 赤（red）</span></span>
<span id="cb16-4"><a href="#cb16-4"></a>    g<span class="op">::</span><span class="dt">UInt8  </span><span class="co"># 緑（green）</span></span>
<span id="cb16-5"><a href="#cb16-5"></a>    b<span class="op">::</span><span class="dt">UInt8  </span><span class="co"># 青（blue）</span></span>
<span id="cb16-6"><a href="#cb16-6"></a></span>
<span id="cb16-7"><a href="#cb16-7"></a>    <span class="co"># 内部コンストラクタ</span></span>
<span id="cb16-8"><a href="#cb16-8"></a>    <span class="kw">function</span> <span class="fu">RGB</span>(r<span class="op">::</span><span class="dt">Integer</span>, g<span class="op">::</span><span class="dt">Integer</span>, b<span class="op">::</span><span class="dt">Integer</span>)</span>
<span id="cb16-9"><a href="#cb16-9"></a>        <span class="fl">0</span> <span class="op">≤</span> r <span class="op">≤</span> <span class="fl">255</span> <span class="op">&amp;&amp;</span> <span class="fl">0</span> <span class="op">≤</span> g <span class="op">≤</span> <span class="fl">255</span> <span class="op">&amp;&amp;</span> <span class="fl">0</span> <span class="op">≤</span> b <span class="op">≤</span> <span class="fl">255</span> <span class="op">||</span></span>
<span id="cb16-10"><a href="#cb16-10"></a>        <span class="fu">throw</span>(<span class="fu">ArgumentError</span>(<span class="st">"value must be between 0 and 255"</span>))</span>
<span id="cb16-11"><a href="#cb16-11"></a>        <span class="cf">return</span> <span class="fu">new</span>(r, g, b)</span>
<span id="cb16-12"><a href="#cb16-12"></a>    <span class="kw">end</span></span>
<span id="cb16-13"><a href="#cb16-13"></a><span class="kw">end</span></span>
<span id="cb16-14"><a href="#cb16-14"></a></span>
<span id="cb16-15"><a href="#cb16-15"></a><span class="co"># 無彩色を作る外部コンストラクタ</span></span>
<span id="cb16-16"><a href="#cb16-16"></a><span class="fu">RGB</span>(x<span class="op">::</span><span class="dt">Integer</span>) <span class="op">=</span> <span class="fu">RGB</span>(x, x, x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="normal.jl" class="level3">
<h3 class="anchored" data-anchor-id="normal.jl">normal.jl</h3>
<div class="sourceCode" id="cb17"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1"></a><span class="co"># 正規分布（normal distribution）</span></span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="kw">struct</span> Normal{T <span class="op">&lt;:</span><span class="dt"> Real</span>}</span>
<span id="cb17-3"><a href="#cb17-3"></a>    μ<span class="op">::</span><span class="dt">T  </span><span class="co"># 平均</span></span>
<span id="cb17-4"><a href="#cb17-4"></a>    σ<span class="op">::</span><span class="dt">T  </span><span class="co"># 標準偏差</span></span>
<span id="cb17-5"><a href="#cb17-5"></a></span>
<span id="cb17-6"><a href="#cb17-6"></a>    <span class="co"># 内部コンストラクタ</span></span>
<span id="cb17-7"><a href="#cb17-7"></a>    <span class="kw">function</span> <span class="fu">Normal</span><span class="dt">{T}</span>(μ<span class="op">::</span><span class="dt">Real </span><span class="op">=</span> <span class="fl">0</span>, σ<span class="op">::</span><span class="dt">Real </span><span class="op">=</span> <span class="fl">1</span>) <span class="kw">where</span> T <span class="op">&lt;:</span><span class="dt"> Real</span></span>
<span id="cb17-8"><a href="#cb17-8"></a>        σ <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">||</span> <span class="fu">throw</span>(<span class="fu">ArgumentError</span>(<span class="st">"σ must be positive"</span>))</span>
<span id="cb17-9"><a href="#cb17-9"></a>        <span class="cf">return</span> <span class="fu">new</span><span class="dt">{T}</span>(μ, σ)</span>
<span id="cb17-10"><a href="#cb17-10"></a>    <span class="kw">end</span></span>
<span id="cb17-11"><a href="#cb17-11"></a><span class="kw">end</span></span>
<span id="cb17-12"><a href="#cb17-12"></a></span>
<span id="cb17-13"><a href="#cb17-13"></a><span class="co"># 外部コンストラクタ</span></span>
<span id="cb17-14"><a href="#cb17-14"></a><span class="kw">function</span> <span class="fu">Normal</span>(μ<span class="op">::</span><span class="dt">Real </span><span class="op">=</span> <span class="fl">0</span>, σ<span class="op">::</span><span class="dt">Real </span><span class="op">=</span> <span class="fl">1</span>)</span>
<span id="cb17-15"><a href="#cb17-15"></a>    μ, σ <span class="op">=</span> <span class="fu">promote</span>(<span class="fu">float</span>(μ), <span class="fu">float</span>(σ))</span>
<span id="cb17-16"><a href="#cb17-16"></a>    <span class="cf">return</span> <span class="fu">Normal</span><span class="dt">{typeof(μ)}</span>(μ, σ)</span>
<span id="cb17-17"><a href="#cb17-17"></a><span class="kw">end</span></span>
<span id="cb17-18"><a href="#cb17-18"></a></span>
<span id="cb17-19"><a href="#cb17-19"></a><span class="co"># 確率密度関数</span></span>
<span id="cb17-20"><a href="#cb17-20"></a><span class="kw">function</span> <span class="fu">pdf</span>(dist<span class="op">::</span><span class="dt">Normal</span>, x<span class="op">::</span><span class="dt">Real</span>)</span>
<span id="cb17-21"><a href="#cb17-21"></a>    <span class="co"># Julia 1.7以降では (; μ, σ) = dist も可</span></span>
<span id="cb17-22"><a href="#cb17-22"></a>    μ, σ <span class="op">=</span> dist.μ, dist.σ</span>
<span id="cb17-23"><a href="#cb17-23"></a>    <span class="cf">return</span> (σ <span class="op">*</span> <span class="fu">oftype</span>(σ, <span class="fu">√</span>(<span class="fl">2</span>π))) <span class="op">\</span> <span class="fu">exp</span>(<span class="op">-</span><span class="fl">2</span> <span class="op">\</span> ((x <span class="op">-</span> μ) <span class="op">/</span> σ)<span class="op">^</span><span class="fl">2</span>)</span>
<span id="cb17-24"><a href="#cb17-24"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="node.jl" class="level3">
<h3 class="anchored" data-anchor-id="node.jl">node.jl</h3>
<div class="sourceCode" id="cb18"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb18-1"><a href="#cb18-1"></a><span class="co"># 木構造のノード</span></span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="kw">mutable struct</span> Node</span>
<span id="cb18-3"><a href="#cb18-3"></a>    index<span class="op">::</span><span class="dt">Int</span></span>
<span id="cb18-4"><a href="#cb18-4"></a>    parent<span class="op">::</span><span class="dt">Node</span></span>
<span id="cb18-5"><a href="#cb18-5"></a></span>
<span id="cb18-6"><a href="#cb18-6"></a>    <span class="co"># 内部コンストラクタの定義</span></span>
<span id="cb18-7"><a href="#cb18-7"></a>    <span class="fu">Node</span>(index<span class="op">::</span><span class="dt">Integer</span>) <span class="op">=</span> <span class="fu">new</span>(index)</span>
<span id="cb18-8"><a href="#cb18-8"></a>    <span class="fu">Node</span>(index<span class="op">::</span><span class="dt">Integer</span>, parent<span class="op">::</span><span class="dt">Node</span>) <span class="op">=</span> <span class="fu">new</span>(index, parent)</span>
<span id="cb18-9"><a href="#cb18-9"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="stack.jl" class="level3">
<h3 class="anchored" data-anchor-id="stack.jl">stack.jl</h3>
<div class="sourceCode" id="cb19"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb19-1"><a href="#cb19-1"></a><span class="kw">mutable struct</span> Stack{T}</span>
<span id="cb19-2"><a href="#cb19-2"></a>    data<span class="op">::</span><span class="dt">Vector{T}  </span><span class="co"># 要素</span></span>
<span id="cb19-3"><a href="#cb19-3"></a>    size<span class="op">::</span><span class="dt">Int        </span><span class="co"># 要素数</span></span>
<span id="cb19-4"><a href="#cb19-4"></a></span>
<span id="cb19-5"><a href="#cb19-5"></a>    <span class="kw">function</span> <span class="fu">Stack</span><span class="dt">{T}</span>(; capacity<span class="op">::</span><span class="dt">Integer </span><span class="op">=</span> <span class="fl">4</span>) <span class="kw">where</span> T</span>
<span id="cb19-6"><a href="#cb19-6"></a>        data <span class="op">=</span> <span class="fu">Vector</span><span class="dt">{T}</span>(<span class="cn">undef</span>, capacity)</span>
<span id="cb19-7"><a href="#cb19-7"></a>        <span class="cf">return</span> <span class="fu">new</span><span class="dt">{T}</span>(data, <span class="fl">0</span>)</span>
<span id="cb19-8"><a href="#cb19-8"></a>    <span class="kw">end</span></span>
<span id="cb19-9"><a href="#cb19-9"></a><span class="kw">end</span></span>
<span id="cb19-10"><a href="#cb19-10"></a></span>
<span id="cb19-11"><a href="#cb19-11"></a><span class="fu">Stack</span>(; capacity<span class="op">::</span><span class="dt">Integer </span><span class="op">=</span> <span class="fl">4</span>) <span class="op">=</span> <span class="fu">Stack</span><span class="dt">{Any}</span>(; capacity)</span>
<span id="cb19-12"><a href="#cb19-12"></a></span>
<span id="cb19-13"><a href="#cb19-13"></a><span class="bu">Base</span>.<span class="fu">eltype</span>(<span class="op">::</span><span class="dt">Type{Stack{T}}</span>) <span class="kw">where</span> T <span class="op">=</span> T</span>
<span id="cb19-14"><a href="#cb19-14"></a><span class="bu">Base</span>.<span class="fu">length</span>(stack<span class="op">::</span><span class="dt">Stack</span>) <span class="op">=</span> stack.size</span>
<span id="cb19-15"><a href="#cb19-15"></a><span class="bu">Base</span>.<span class="fu">isempty</span>(stack<span class="op">::</span><span class="dt">Stack</span>) <span class="op">=</span> stack.size <span class="op">==</span> <span class="fl">0</span></span>
<span id="cb19-16"><a href="#cb19-16"></a></span>
<span id="cb19-17"><a href="#cb19-17"></a><span class="kw">function</span> <span class="bu">Base</span>.<span class="fu">push!</span>(stack<span class="op">::</span><span class="dt">Stack</span>, item)</span>
<span id="cb19-18"><a href="#cb19-18"></a>    item <span class="op">=</span> <span class="fu">convert</span>(<span class="fu">eltype</span>(stack), item)</span>
<span id="cb19-19"><a href="#cb19-19"></a>    <span class="cf">if</span> stack.size <span class="op">==</span> <span class="fu">length</span>(stack.data)</span>
<span id="cb19-20"><a href="#cb19-20"></a>        <span class="co"># stack.dataがいっぱいなら、サイズを2倍に拡大</span></span>
<span id="cb19-21"><a href="#cb19-21"></a>        <span class="fu">resize!</span>(stack.data, <span class="fu">max</span>(<span class="fl">2</span> <span class="op">*</span> stack.size, <span class="fl">4</span>))</span>
<span id="cb19-22"><a href="#cb19-22"></a>    <span class="cf">end</span></span>
<span id="cb19-23"><a href="#cb19-23"></a>    newsize <span class="op">=</span> stack.size <span class="op">+</span> <span class="fl">1</span></span>
<span id="cb19-24"><a href="#cb19-24"></a>    stack.data[newsize] <span class="op">=</span> item</span>
<span id="cb19-25"><a href="#cb19-25"></a>    stack.size <span class="op">=</span> newsize</span>
<span id="cb19-26"><a href="#cb19-26"></a>    <span class="cf">return</span> stack</span>
<span id="cb19-27"><a href="#cb19-27"></a><span class="kw">end</span></span>
<span id="cb19-28"><a href="#cb19-28"></a></span>
<span id="cb19-29"><a href="#cb19-29"></a><span class="kw">function</span> <span class="bu">Base</span>.<span class="fu">pop!</span>(stack<span class="op">::</span><span class="dt">Stack</span>)</span>
<span id="cb19-30"><a href="#cb19-30"></a>    <span class="fu">isempty</span>(stack) <span class="op">&amp;&amp;</span> <span class="fu">throw</span>(<span class="fu">ArgumentError</span>(<span class="st">"cannot pop! an empty stack"</span>))</span>
<span id="cb19-31"><a href="#cb19-31"></a>    item <span class="op">=</span> stack.data[stack.size]</span>
<span id="cb19-32"><a href="#cb19-32"></a>    stack.size <span class="op">-=</span> <span class="fl">1</span></span>
<span id="cb19-33"><a href="#cb19-33"></a>    <span class="cf">return</span> item</span>
<span id="cb19-34"><a href="#cb19-34"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="shortstring.jl" class="level3">
<h3 class="anchored" data-anchor-id="shortstring.jl">shortstring.jl</h3>
<div class="sourceCode" id="cb20"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb20-1"><a href="#cb20-1"></a><span class="co"># 短い（7バイト以下）ASCII文字列のデータ型</span></span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="kw">struct</span> ShortString <span class="co"># &lt;: AbstractString</span></span>
<span id="cb20-3"><a href="#cb20-3"></a>    data<span class="op">::</span><span class="dt">UInt64</span></span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="kw">end</span></span>
<span id="cb20-5"><a href="#cb20-5"></a></span>
<span id="cb20-6"><a href="#cb20-6"></a><span class="co"># コンストラクタ</span></span>
<span id="cb20-7"><a href="#cb20-7"></a><span class="fu">ShortString</span>(s<span class="op">::</span><span class="dt">String</span>) <span class="op">=</span> <span class="fu">convert</span>(ShortString, s)</span>
<span id="cb20-8"><a href="#cb20-8"></a></span>
<span id="cb20-9"><a href="#cb20-9"></a><span class="co"># String → ShortStringの変換</span></span>
<span id="cb20-10"><a href="#cb20-10"></a><span class="kw">function</span> <span class="bu">Base</span>.<span class="fu">convert</span>(<span class="op">::</span><span class="dt">Type{ShortString}</span>, s<span class="op">::</span><span class="dt">String</span>)</span>
<span id="cb20-11"><a href="#cb20-11"></a>    n <span class="op">=</span> <span class="fu">ncodeunits</span>(s)</span>
<span id="cb20-12"><a href="#cb20-12"></a>    <span class="cf">if</span> n <span class="op">&gt;</span> <span class="fl">7</span> <span class="op">||</span> !<span class="fu">isascii</span>(s) <span class="op">||</span> <span class="ch">'\0'</span> <span class="kw">in</span> s</span>
<span id="cb20-13"><a href="#cb20-13"></a>        <span class="fu">throw</span>(<span class="fu">InexactError</span>(<span class="op">:</span>ShortString, ShortString, s))</span>
<span id="cb20-14"><a href="#cb20-14"></a>    <span class="cf">end</span></span>
<span id="cb20-15"><a href="#cb20-15"></a>    data <span class="op">=</span> <span class="fu">zero</span>(<span class="dt">UInt64</span>)</span>
<span id="cb20-16"><a href="#cb20-16"></a>    <span class="cf">for</span> i <span class="kw">in</span> n<span class="op">:-</span><span class="fl">1</span><span class="op">:</span><span class="fl">1</span></span>
<span id="cb20-17"><a href="#cb20-17"></a>        data <span class="op">=</span> (data <span class="op">&lt;&lt;</span> <span class="fl">8</span>) <span class="op">|</span> <span class="fu">codeunit</span>(s, i)</span>
<span id="cb20-18"><a href="#cb20-18"></a>    <span class="cf">end</span></span>
<span id="cb20-19"><a href="#cb20-19"></a>    <span class="cf">return</span> <span class="fu">ShortString</span>(data)</span>
<span id="cb20-20"><a href="#cb20-20"></a><span class="kw">end</span></span>
<span id="cb20-21"><a href="#cb20-21"></a></span>
<span id="cb20-22"><a href="#cb20-22"></a><span class="co"># ShortString → Stringの変換</span></span>
<span id="cb20-23"><a href="#cb20-23"></a><span class="bu">Base</span>.<span class="fu">convert</span>(<span class="op">::</span><span class="dt">Type{String}</span>, s<span class="op">::</span><span class="dt">ShortString</span>) <span class="op">=</span> <span class="fu">sprint</span>(print, s)</span>
<span id="cb20-24"><a href="#cb20-24"></a></span>
<span id="cb20-25"><a href="#cb20-25"></a><span class="co"># show関数の拡張</span></span>
<span id="cb20-26"><a href="#cb20-26"></a><span class="bu">Base</span>.<span class="fu">show</span>(out<span class="op">::</span><span class="dt">IO</span>, s<span class="op">::</span><span class="dt">ShortString</span>) <span class="op">=</span> <span class="fu">show</span>(out, <span class="fu">convert</span>(<span class="dt">String</span>, s))</span>
<span id="cb20-27"><a href="#cb20-27"></a></span>
<span id="cb20-28"><a href="#cb20-28"></a><span class="co"># print関数の拡張</span></span>
<span id="cb20-29"><a href="#cb20-29"></a><span class="kw">function</span> <span class="bu">Base</span>.<span class="fu">print</span>(out<span class="op">::</span><span class="dt">IO</span>, s<span class="op">::</span><span class="dt">ShortString</span>)</span>
<span id="cb20-30"><a href="#cb20-30"></a>    data <span class="op">=</span> s.data</span>
<span id="cb20-31"><a href="#cb20-31"></a>    <span class="cf">while</span> data <span class="op">&amp;</span> <span class="bn">0xff</span> <span class="op">!=</span> <span class="fl">0</span></span>
<span id="cb20-32"><a href="#cb20-32"></a>        <span class="fu">write</span>(out, data <span class="op">%</span> <span class="dt">UInt8</span>)</span>
<span id="cb20-33"><a href="#cb20-33"></a>        data <span class="op">&gt;&gt;=</span> <span class="fl">8</span></span>
<span id="cb20-34"><a href="#cb20-34"></a>    <span class="cf">end</span></span>
<span id="cb20-35"><a href="#cb20-35"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="bitrotator.jl" class="level3">
<h3 class="anchored" data-anchor-id="bitrotator.jl">bitrotator.jl</h3>
<div class="sourceCode" id="cb21"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb21-1"><a href="#cb21-1"></a><span class="co"># ビットを左回転するイテレータ</span></span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="kw">struct</span> BitRotator{T <span class="op">&lt;:</span><span class="dt"> Base.BitInteger</span>}</span>
<span id="cb21-3"><a href="#cb21-3"></a>    bits<span class="op">::</span><span class="dt">T</span></span>
<span id="cb21-4"><a href="#cb21-4"></a><span class="kw">end</span></span>
<span id="cb21-5"><a href="#cb21-5"></a></span>
<span id="cb21-6"><a href="#cb21-6"></a><span class="co"># 初期状態を返す</span></span>
<span id="cb21-7"><a href="#cb21-7"></a><span class="bu">Base</span>.<span class="fu">iterate</span>(rot<span class="op">::</span><span class="dt">BitRotator</span>) <span class="op">=</span> (rot.bits, <span class="fl">1</span>)</span>
<span id="cb21-8"><a href="#cb21-8"></a></span>
<span id="cb21-9"><a href="#cb21-9"></a><span class="co"># 次の反復を準備する（状態を表すk引数は初期位置からの距離）</span></span>
<span id="cb21-10"><a href="#cb21-10"></a><span class="kw">function</span> <span class="bu">Base</span>.<span class="fu">iterate</span>(rot<span class="op">::</span><span class="dt">BitRotator</span>, k<span class="op">::</span><span class="dt">Int</span>)</span>
<span id="cb21-11"><a href="#cb21-11"></a>    x <span class="op">=</span> rot.bits</span>
<span id="cb21-12"><a href="#cb21-12"></a>    nbits <span class="op">=</span> <span class="fu">sizeof</span>(x) <span class="op">*</span> <span class="fl">8</span></span>
<span id="cb21-13"><a href="#cb21-13"></a>    <span class="cf">if</span> k <span class="op">≥</span> nbits</span>
<span id="cb21-14"><a href="#cb21-14"></a>        <span class="cf">return</span> <span class="cn">nothing</span></span>
<span id="cb21-15"><a href="#cb21-15"></a>    <span class="cf">end</span></span>
<span id="cb21-16"><a href="#cb21-16"></a>    <span class="cf">return</span> <span class="fu">bitrotate</span>(x, k), k <span class="op">+</span> <span class="fl">1</span></span>
<span id="cb21-17"><a href="#cb21-17"></a><span class="kw">end</span></span>
<span id="cb21-18"><a href="#cb21-18"></a></span>
<span id="cb21-19"><a href="#cb21-19"></a><span class="co"># イテレータの長さ（要素数）</span></span>
<span id="cb21-20"><a href="#cb21-20"></a><span class="bu">Base</span>.<span class="fu">length</span>(rot<span class="op">::</span><span class="dt">BitRotator</span>) <span class="op">=</span> <span class="fu">sizeof</span>(rot.bits) <span class="op">*</span> <span class="fl">8</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="composition.jl" class="level3">
<h3 class="anchored" data-anchor-id="composition.jl">composition.jl</h3>
<div class="sourceCode" id="cb22"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb22-1"><a href="#cb22-1"></a><span class="co"># コンポジション型</span></span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="kw">struct</span> Composition{T <span class="op">&lt;:</span><span class="dt"> Real</span>} <span class="op">&lt;:</span><span class="dt"> AbstractVector{T}</span></span>
<span id="cb22-3"><a href="#cb22-3"></a>    data<span class="op">::</span><span class="dt">Vector{T}</span></span>
<span id="cb22-4"><a href="#cb22-4"></a></span>
<span id="cb22-5"><a href="#cb22-5"></a>    <span class="kw">function</span> <span class="fu">Composition</span>(x)</span>
<span id="cb22-6"><a href="#cb22-6"></a>        c <span class="op">=</span> x <span class="op">./</span> <span class="fu">sum</span>(x)</span>
<span id="cb22-7"><a href="#cb22-7"></a>        <span class="cf">return</span> <span class="fu">new</span><span class="dt">{eltype(c)}</span>(c)</span>
<span id="cb22-8"><a href="#cb22-8"></a>    <span class="kw">end</span></span>
<span id="cb22-9"><a href="#cb22-9"></a><span class="kw">end</span></span>
<span id="cb22-10"><a href="#cb22-10"></a></span>
<span id="cb22-11"><a href="#cb22-11"></a><span class="co"># スカラー倍</span></span>
<span id="cb22-12"><a href="#cb22-12"></a><span class="bu">Base</span>.<span class="op">:</span><span class="fu">*</span>(α<span class="op">::</span><span class="dt">Real</span>, x<span class="op">::</span><span class="dt">Composition</span>) <span class="op">=</span> <span class="fu">Composition</span>(x <span class="op">.^</span> α)</span>
<span id="cb22-13"><a href="#cb22-13"></a><span class="bu">Base</span>.<span class="op">:</span><span class="fu">*</span>(x<span class="op">::</span><span class="dt">Composition</span>, α<span class="op">::</span><span class="dt">Real</span>) <span class="op">=</span> <span class="fu">Composition</span>(x <span class="op">.^</span> α)</span>
<span id="cb22-14"><a href="#cb22-14"></a></span>
<span id="cb22-15"><a href="#cb22-15"></a><span class="co"># ベクトル和</span></span>
<span id="cb22-16"><a href="#cb22-16"></a><span class="bu">Base</span>.<span class="op">:</span><span class="fu">+</span>(x<span class="op">::</span><span class="dt">Composition</span>, y<span class="op">::</span><span class="dt">Composition</span>) <span class="op">=</span> <span class="fu">Composition</span>(x <span class="op">.*</span> y)</span>
<span id="cb22-17"><a href="#cb22-17"></a></span>
<span id="cb22-18"><a href="#cb22-18"></a><span class="co"># ベクトル和の逆元とベクトル差</span></span>
<span id="cb22-19"><a href="#cb22-19"></a><span class="bu">Base</span>.<span class="op">:</span><span class="fu">-</span>(x<span class="op">::</span><span class="dt">Composition</span>) <span class="op">=</span> <span class="fu">Composition</span>(<span class="fu">inv</span>.(x))</span>
<span id="cb22-20"><a href="#cb22-20"></a><span class="bu">Base</span>.<span class="op">:</span><span class="fu">-</span>(x<span class="op">::</span><span class="dt">Composition</span>, y<span class="op">::</span><span class="dt">Composition</span>) <span class="op">=</span> x <span class="op">+</span> (<span class="op">-</span>y)</span>
<span id="cb22-21"><a href="#cb22-21"></a></span>
<span id="cb22-22"><a href="#cb22-22"></a><span class="bu">Base</span>.<span class="fu">size</span>(x<span class="op">::</span><span class="dt">Composition</span>) <span class="op">=</span> <span class="fu">size</span>(x.data)</span>
<span id="cb22-23"><a href="#cb22-23"></a><span class="bu">Base</span>.<span class="fu">getindex</span>(x<span class="op">::</span><span class="dt">Composition</span>, i<span class="op">::</span><span class="dt">Integer</span>) <span class="op">=</span> x.data[i]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="trait.jl" class="level3">
<h3 class="anchored" data-anchor-id="trait.jl">trait.jl</h3>
<div class="sourceCode" id="cb23"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb23-1"><a href="#cb23-1"></a><span class="co"># トレイトの定義</span></span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="kw">abstract type</span> Trait <span class="kw">end</span></span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="kw">struct</span> TraitA <span class="op">&lt;:</span><span class="dt"> Trait </span><span class="kw">end</span></span>
<span id="cb23-4"><a href="#cb23-4"></a><span class="kw">struct</span> TraitB <span class="op">&lt;:</span><span class="dt"> Trait </span><span class="kw">end</span></span>
<span id="cb23-5"><a href="#cb23-5"></a></span>
<span id="cb23-6"><a href="#cb23-6"></a><span class="co"># トレイトを利用する関数</span></span>
<span id="cb23-7"><a href="#cb23-7"></a><span class="fu">f</span>(x) <span class="op">=</span> <span class="fu">_f</span>(<span class="fu">Trait</span>(<span class="fu">typeof</span>(x)), x)</span>
<span id="cb23-8"><a href="#cb23-8"></a><span class="fu">_f</span>(<span class="op">::</span><span class="dt">TraitA</span>, x) <span class="op">=</span> <span class="st">"Trait A"</span></span>
<span id="cb23-9"><a href="#cb23-9"></a><span class="fu">_f</span>(<span class="op">::</span><span class="dt">TraitB</span>, x) <span class="op">=</span> <span class="st">"Trait B"</span></span>
<span id="cb23-10"><a href="#cb23-10"></a></span>
<span id="cb23-11"><a href="#cb23-11"></a><span class="co"># トレイトを実装する型</span></span>
<span id="cb23-12"><a href="#cb23-12"></a><span class="kw">struct</span> Foo <span class="kw">end</span></span>
<span id="cb23-13"><a href="#cb23-13"></a><span class="fu">Trait</span>(<span class="op">::</span><span class="dt">Type{Foo}</span>) <span class="op">=</span> <span class="fu">TraitA</span>()</span>
<span id="cb23-14"><a href="#cb23-14"></a><span class="kw">struct</span> Bar <span class="kw">end</span></span>
<span id="cb23-15"><a href="#cb23-15"></a><span class="fu">Trait</span>(<span class="op">::</span><span class="dt">Type{Bar}</span>) <span class="op">=</span> <span class="fu">TraitB</span>()</span>
<span id="cb23-16"><a href="#cb23-16"></a><span class="kw">struct</span> Baz <span class="kw">end</span></span>
<span id="cb23-17"><a href="#cb23-17"></a><span class="fu">Trait</span>(<span class="op">::</span><span class="dt">Type{Baz}</span>) <span class="op">=</span> <span class="fu">TraitB</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="章-7" class="level2">
<h2 class="anchored" data-anchor-id="章-7">10章</h2>
<section id="msb.jl" class="level3">
<h3 class="anchored" data-anchor-id="msb.jl">msb.jl</h3>
<div class="sourceCode" id="cb24"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb24-1"><a href="#cb24-1"></a><span class="co"># 最上位ビット（most significant bit）を取得する関数</span></span>
<span id="cb24-2"><a href="#cb24-2"></a><span class="cf">for</span> T <span class="kw">in</span> [<span class="dt">UInt8</span>, <span class="dt">UInt16</span>, <span class="dt">UInt32</span>, <span class="dt">UInt64</span>, <span class="dt">UInt128</span>]</span>
<span id="cb24-3"><a href="#cb24-3"></a>    <span class="pp">@eval</span> <span class="fu">msb</span>(x<span class="op">::</span><span class="dt">$T</span>) <span class="op">=</span> x <span class="op">&gt;&gt;</span> (<span class="fu">sizeof</span>(<span class="op">$</span>T) <span class="op">*</span> <span class="fl">8</span> <span class="op">-</span> <span class="fl">1</span>)</span>
<span id="cb24-4"><a href="#cb24-4"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="check.jl" class="level3">
<h3 class="anchored" data-anchor-id="check.jl">check.jl</h3>
<div class="sourceCode" id="cb25"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb25-1"><a href="#cb25-1"></a><span class="co"># 注：この定義は問題あり</span></span>
<span id="cb25-2"><a href="#cb25-2"></a><span class="kw">macro</span> <span class="fu">check</span>(ex)</span>
<span id="cb25-3"><a href="#cb25-3"></a>    code <span class="op">=</span> <span class="fu">string</span>(ex)  <span class="co"># 式を文字列化</span></span>
<span id="cb25-4"><a href="#cb25-4"></a>    <span class="kw">quote</span></span>
<span id="cb25-5"><a href="#cb25-5"></a>        <span class="fu">print</span>(<span class="op">$</span>code, <span class="st">" → "</span>)</span>
<span id="cb25-6"><a href="#cb25-6"></a>        <span class="cf">if</span> <span class="op">$</span>ex</span>
<span id="cb25-7"><a href="#cb25-7"></a>            <span class="fu">println</span>(<span class="st">"GOOD"</span>)</span>
<span id="cb25-8"><a href="#cb25-8"></a>        <span class="cf">else</span></span>
<span id="cb25-9"><a href="#cb25-9"></a>            <span class="fu">println</span>(<span class="st">"BAD"</span>)</span>
<span id="cb25-10"><a href="#cb25-10"></a>        <span class="cf">end</span></span>
<span id="cb25-11"><a href="#cb25-11"></a>    <span class="kw">end</span></span>
<span id="cb25-12"><a href="#cb25-12"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="repeat.jl" class="level3">
<h3 class="anchored" data-anchor-id="repeat.jl">repeat.jl</h3>
<div class="sourceCode" id="cb26"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb26-1"><a href="#cb26-1"></a><span class="kw">macro</span> <span class="fu">repeat</span>(n, ex)</span>
<span id="cb26-2"><a href="#cb26-2"></a>    <span class="kw">quote</span></span>
<span id="cb26-3"><a href="#cb26-3"></a>        <span class="cf">for</span> _ <span class="kw">in</span> <span class="fl">1</span><span class="op">:$</span>(<span class="fu">esc</span>(n))</span>
<span id="cb26-4"><a href="#cb26-4"></a>            <span class="op">$</span>(<span class="fu">esc</span>(ex))</span>
<span id="cb26-5"><a href="#cb26-5"></a>        <span class="cf">end</span></span>
<span id="cb26-6"><a href="#cb26-6"></a>    <span class="kw">end</span></span>
<span id="cb26-7"><a href="#cb26-7"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="elapsed.jl" class="level3">
<h3 class="anchored" data-anchor-id="elapsed.jl">elapsed.jl</h3>
<div class="sourceCode" id="cb27"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb27-1"><a href="#cb27-1"></a><span class="co"># base/timing.jl (MIT license: https://julialang.org/license)</span></span>
<span id="cb27-2"><a href="#cb27-2"></a><span class="kw">macro</span> <span class="fu">elapsed</span>(ex)</span>
<span id="cb27-3"><a href="#cb27-3"></a>    <span class="kw">quote</span></span>
<span id="cb27-4"><a href="#cb27-4"></a>        <span class="kw">local</span> t0 <span class="op">=</span> <span class="fu">time_ns</span>()</span>
<span id="cb27-5"><a href="#cb27-5"></a>        <span class="op">$</span>(<span class="fu">esc</span>(ex))</span>
<span id="cb27-6"><a href="#cb27-6"></a>        (<span class="fu">time_ns</span>() <span class="op">-</span> t0) <span class="op">/</span> <span class="fl">1e9</span></span>
<span id="cb27-7"><a href="#cb27-7"></a>    <span class="kw">end</span></span>
<span id="cb27-8"><a href="#cb27-8"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="fstring.jl" class="level3">
<h3 class="anchored" data-anchor-id="fstring.jl">fstring.jl</h3>
<div class="sourceCode" id="cb28"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb28-1"><a href="#cb28-1"></a><span class="co"># f文字列の解析処理</span></span>
<span id="cb28-2"><a href="#cb28-2"></a><span class="kw">function</span> <span class="fu">parse_fstring</span>(str)</span>
<span id="cb28-3"><a href="#cb28-3"></a>    parts <span class="op">=</span> <span class="dt">Union</span>{<span class="dt">String</span>, <span class="dt">Symbol</span>}[]</span>
<span id="cb28-4"><a href="#cb28-4"></a>    pos <span class="op">=</span> <span class="fu">firstindex</span>(str)</span>
<span id="cb28-5"><a href="#cb28-5"></a>    <span class="co"># '{'を探す</span></span>
<span id="cb28-6"><a href="#cb28-6"></a>    <span class="cf">while</span> (open <span class="op">=</span> <span class="fu">findnext</span>(<span class="ch">'{'</span>, str, pos)) <span class="op">!==</span> <span class="cn">nothing</span></span>
<span id="cb28-7"><a href="#cb28-7"></a>        <span class="co"># '}'を探す</span></span>
<span id="cb28-8"><a href="#cb28-8"></a>        close <span class="op">=</span> <span class="fu">findnext</span>(<span class="ch">'}'</span>, str, open)</span>
<span id="cb28-9"><a href="#cb28-9"></a>        <span class="fu">isnothing</span>(close) <span class="op">&amp;&amp;</span> <span class="cf">break</span>  <span class="co"># ペアになる'}'がない</span></span>
<span id="cb28-10"><a href="#cb28-10"></a>        <span class="co"># '{'より前までを詰める</span></span>
<span id="cb28-11"><a href="#cb28-11"></a>        <span class="fu">push!</span>(parts, str[pos<span class="op">:</span><span class="fu">prevind</span>(str, open)])</span>
<span id="cb28-12"><a href="#cb28-12"></a>        <span class="co"># '{'と'}'の間の名前を詰める（空文字列ならそのまま）</span></span>
<span id="cb28-13"><a href="#cb28-13"></a>        name <span class="op">=</span> str[<span class="fu">nextind</span>(str, open)<span class="op">:</span><span class="fu">prevind</span>(str, close)]</span>
<span id="cb28-14"><a href="#cb28-14"></a>        <span class="fu">push!</span>(parts, <span class="fu">isempty</span>(name) ? <span class="st">"{}"</span> <span class="op">:</span> <span class="fu">Symbol</span>(name))</span>
<span id="cb28-15"><a href="#cb28-15"></a>        <span class="co"># '}'の直後の位置を取得する</span></span>
<span id="cb28-16"><a href="#cb28-16"></a>        pos <span class="op">=</span> <span class="fu">nextind</span>(str, close)</span>
<span id="cb28-17"><a href="#cb28-17"></a>    <span class="cf">end</span></span>
<span id="cb28-18"><a href="#cb28-18"></a>    <span class="co"># 残りの文字列を詰める</span></span>
<span id="cb28-19"><a href="#cb28-19"></a>    <span class="fu">push!</span>(parts, str[pos<span class="op">:</span><span class="kw">end</span>])</span>
<span id="cb28-20"><a href="#cb28-20"></a>    <span class="cf">return</span> parts</span>
<span id="cb28-21"><a href="#cb28-21"></a><span class="kw">end</span></span>
<span id="cb28-22"><a href="#cb28-22"></a></span>
<span id="cb28-23"><a href="#cb28-23"></a><span class="co"># マクロの定義</span></span>
<span id="cb28-24"><a href="#cb28-24"></a><span class="kw">macro</span> <span class="fu">f_str</span>(str)</span>
<span id="cb28-25"><a href="#cb28-25"></a>    parts <span class="op">=</span> <span class="fu">parse_fstring</span>(str)</span>
<span id="cb28-26"><a href="#cb28-26"></a>    <span class="co"># 変数（シンボル）はエスケープする</span></span>
<span id="cb28-27"><a href="#cb28-27"></a>    parts <span class="op">=</span> <span class="fu">map</span>(x <span class="op">-&gt;</span> x isa <span class="dt">Symbol</span> ? <span class="fu">esc</span>(x) <span class="op">:</span> x, parts)</span>
<span id="cb28-28"><a href="#cb28-28"></a>    <span class="cf">return</span> <span class="op">:</span>(<span class="fu">string</span>(<span class="op">$</span>(parts<span class="op">...</span>)))</span>
<span id="cb28-29"><a href="#cb28-29"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="genfun.jl" class="level3">
<h3 class="anchored" data-anchor-id="genfun.jl">genfun.jl</h3>
<div class="sourceCode" id="cb29"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb29-1"><a href="#cb29-1"></a><span class="pp">@generated</span> <span class="kw">function</span> <span class="fu">genfun</span>(x)</span>
<span id="cb29-2"><a href="#cb29-2"></a>    <span class="cf">if</span> x <span class="op">&lt;:</span><span class="dt"> Real</span></span>
<span id="cb29-3"><a href="#cb29-3"></a>        <span class="cf">return</span> <span class="op">:</span>(<span class="fu">println</span>(<span class="st">"</span><span class="sc">$</span>(<span class="fu">repr</span>(x))<span class="st"> is Real"</span>))</span>
<span id="cb29-4"><a href="#cb29-4"></a>    <span class="cf">else</span></span>
<span id="cb29-5"><a href="#cb29-5"></a>        <span class="cf">return</span> <span class="op">:</span>(<span class="fu">println</span>(<span class="st">"</span><span class="sc">$</span>(<span class="fu">repr</span>(x))<span class="st"> is not Real"</span>))</span>
<span id="cb29-6"><a href="#cb29-6"></a>    <span class="cf">end</span></span>
<span id="cb29-7"><a href="#cb29-7"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="polynomial.jl" class="level3">
<h3 class="anchored" data-anchor-id="polynomial.jl">polynomial.jl</h3>
<div class="sourceCode" id="cb30"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb30-1"><a href="#cb30-1"></a><span class="kw">function</span> <span class="fu">genpoly</span>(n)</span>
<span id="cb30-2"><a href="#cb30-2"></a>    <span class="pp">@assert</span> n <span class="op">≥</span> <span class="fl">1</span></span>
<span id="cb30-3"><a href="#cb30-3"></a>    ex <span class="op">=</span> <span class="op">:</span>(a[<span class="fl">1</span>])</span>
<span id="cb30-4"><a href="#cb30-4"></a>    <span class="cf">for</span> k <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span>n</span>
<span id="cb30-5"><a href="#cb30-5"></a>        ex <span class="op">=</span> <span class="op">:</span>(<span class="fu">fma</span>(<span class="op">$</span>(ex), x, a[<span class="op">$</span>(k)]))</span>
<span id="cb30-6"><a href="#cb30-6"></a>    <span class="cf">end</span></span>
<span id="cb30-7"><a href="#cb30-7"></a>    <span class="cf">return</span> ex</span>
<span id="cb30-8"><a href="#cb30-8"></a><span class="kw">end</span></span>
<span id="cb30-9"><a href="#cb30-9"></a></span>
<span id="cb30-10"><a href="#cb30-10"></a><span class="pp">@generated</span> <span class="fu">polynomial</span>(</span>
<span id="cb30-11"><a href="#cb30-11"></a>    x<span class="op">::</span><span class="dt">Number</span>,</span>
<span id="cb30-12"><a href="#cb30-12"></a>    a<span class="op">::</span><span class="dt">NTuple{n, Number}</span>,</span>
<span id="cb30-13"><a href="#cb30-13"></a>) <span class="kw">where</span> n <span class="op">=</span> <span class="fu">genpoly</span>(n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="章-8" class="level2">
<h2 class="anchored" data-anchor-id="章-8">11章</h2>
<section id="mysparse.jl" class="level3">
<h3 class="anchored" data-anchor-id="mysparse.jl">mysparse.jl</h3>
<div class="sourceCode" id="cb31"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb31-1"><a href="#cb31-1"></a><span class="co"># sparse関数のように振る舞う関数</span></span>
<span id="cb31-2"><a href="#cb31-2"></a><span class="kw">function</span> <span class="fu">mysparse</span>(I, J, V, m <span class="op">=</span> <span class="fu">maximum</span>(I), n <span class="op">=</span> <span class="fu">maximum</span>(J))</span>
<span id="cb31-3"><a href="#cb31-3"></a>    M <span class="op">=</span> <span class="fu">spzeros</span>(m, n)</span>
<span id="cb31-4"><a href="#cb31-4"></a>    <span class="cf">for</span> (i, j, v) <span class="kw">in</span> <span class="fu">zip</span>(I, J, V)</span>
<span id="cb31-5"><a href="#cb31-5"></a>        M[i,j] <span class="op">=</span> v</span>
<span id="cb31-6"><a href="#cb31-6"></a>    <span class="cf">end</span></span>
<span id="cb31-7"><a href="#cb31-7"></a>    <span class="cf">return</span> M</span>
<span id="cb31-8"><a href="#cb31-8"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="章-9" class="level2">
<h2 class="anchored" data-anchor-id="章-9">12章</h2>
<section id="tarai.jl" class="level3">
<h3 class="anchored" data-anchor-id="tarai.jl">tarai.jl</h3>
<div class="sourceCode" id="cb32"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb32-1"><a href="#cb32-1"></a><span class="co"># CPUを使い切る処理</span></span>
<span id="cb32-2"><a href="#cb32-2"></a><span class="kw">function</span> <span class="fu">tarai</span>(x, y, z)</span>
<span id="cb32-3"><a href="#cb32-3"></a>    <span class="cf">if</span> x <span class="op">&gt;</span> y</span>
<span id="cb32-4"><a href="#cb32-4"></a>        <span class="cf">return</span> <span class="fu">tarai</span>(</span>
<span id="cb32-5"><a href="#cb32-5"></a>            <span class="fu">tarai</span>(x <span class="op">-</span> <span class="fl">1</span>, y, z),</span>
<span id="cb32-6"><a href="#cb32-6"></a>            <span class="fu">tarai</span>(y <span class="op">-</span> <span class="fl">1</span>, z, x),</span>
<span id="cb32-7"><a href="#cb32-7"></a>            <span class="fu">tarai</span>(z <span class="op">-</span> <span class="fl">1</span>, x, y))</span>
<span id="cb32-8"><a href="#cb32-8"></a>    <span class="cf">else</span></span>
<span id="cb32-9"><a href="#cb32-9"></a>        <span class="cf">return</span> y</span>
<span id="cb32-10"><a href="#cb32-10"></a>    <span class="cf">end</span></span>
<span id="cb32-11"><a href="#cb32-11"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="producer-consumer.jl" class="level3">
<h3 class="anchored" data-anchor-id="producer-consumer.jl">producer-consumer.jl</h3>
<div class="sourceCode" id="cb33"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb33-1"><a href="#cb33-1"></a><span class="co"># チャネルに値を詰める生産者</span></span>
<span id="cb33-2"><a href="#cb33-2"></a>chan <span class="op">=</span> <span class="fu">Channel</span><span class="dt">{Int}</span>() <span class="cf">do</span> chan</span>
<span id="cb33-3"><a href="#cb33-3"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span></span>
<span id="cb33-4"><a href="#cb33-4"></a>        <span class="fu">put!</span>(chan, i)</span>
<span id="cb33-5"><a href="#cb33-5"></a>    <span class="cf">end</span></span>
<span id="cb33-6"><a href="#cb33-6"></a><span class="cf">end</span></span>
<span id="cb33-7"><a href="#cb33-7"></a></span>
<span id="cb33-8"><a href="#cb33-8"></a><span class="co"># チャネルから値を取り出す消費者</span></span>
<span id="cb33-9"><a href="#cb33-9"></a><span class="pp">@sync</span> <span class="cf">for</span> label <span class="kw">in</span> <span class="ch">'A'</span><span class="op">:</span><span class="ch">'E'</span></span>
<span id="cb33-10"><a href="#cb33-10"></a>    <span class="pp">@async</span> <span class="cf">for</span> data <span class="kw">in</span> chan</span>
<span id="cb33-11"><a href="#cb33-11"></a>        <span class="fu">println</span>(label, <span class="st">": "</span>, data)</span>
<span id="cb33-12"><a href="#cb33-12"></a>    <span class="cf">end</span></span>
<span id="cb33-13"><a href="#cb33-13"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="counter-bad.jl" class="level3">
<h3 class="anchored" data-anchor-id="counter-bad.jl">counter-bad.jl</h3>
<div class="sourceCode" id="cb34"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb34-1"><a href="#cb34-1"></a><span class="co"># 誤った実装！</span></span>
<span id="cb34-2"><a href="#cb34-2"></a>counter <span class="op">=</span> <span class="fl">0</span></span>
<span id="cb34-3"><a href="#cb34-3"></a><span class="bu">Threads</span>.<span class="pp">@threads</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1_000_000</span></span>
<span id="cb34-4"><a href="#cb34-4"></a>    <span class="kw">global</span> counter</span>
<span id="cb34-5"><a href="#cb34-5"></a>    counter <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb34-6"><a href="#cb34-6"></a><span class="cf">end</span></span>
<span id="cb34-7"><a href="#cb34-7"></a><span class="pp">@show</span> counter</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="mbmandelbrot.jl" class="level3">
<h3 class="anchored" data-anchor-id="mbmandelbrot.jl">mb/mandelbrot.jl</h3>
<div class="sourceCode" id="cb35"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb35-1"><a href="#cb35-1"></a><span class="kw">const</span> N <span class="op">=</span> <span class="fl">1000</span></span>
<span id="cb35-2"><a href="#cb35-2"></a></span>
<span id="cb35-3"><a href="#cb35-3"></a><span class="co"># マンデルブロ集合に含まれるか計算</span></span>
<span id="cb35-4"><a href="#cb35-4"></a><span class="kw">function</span> <span class="fu">mandelbrot</span>(c<span class="op">::</span><span class="dt">Complex</span>; maxiters <span class="op">=</span> N)</span>
<span id="cb35-5"><a href="#cb35-5"></a>    k <span class="op">=</span> <span class="fl">0</span></span>
<span id="cb35-6"><a href="#cb35-6"></a>    z <span class="op">=</span> <span class="fu">zero</span>(c)</span>
<span id="cb35-7"><a href="#cb35-7"></a>    <span class="cf">while</span> k <span class="op">&lt;</span> maxiters <span class="op">&amp;&amp;</span> <span class="fu">abs2</span>(z) <span class="op">≤</span> <span class="fl">4</span></span>
<span id="cb35-8"><a href="#cb35-8"></a>        z <span class="op">=</span> z<span class="op">*</span>z <span class="op">+</span> c</span>
<span id="cb35-9"><a href="#cb35-9"></a>        k <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb35-10"><a href="#cb35-10"></a>    <span class="cf">end</span></span>
<span id="cb35-11"><a href="#cb35-11"></a>    <span class="cf">return</span> maxiters <span class="op">-</span> k  <span class="co"># 0なら収束と判定</span></span>
<span id="cb35-12"><a href="#cb35-12"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="mbplot-seq.jl" class="level3">
<h3 class="anchored" data-anchor-id="mbplot-seq.jl">mb/plot-seq.jl</h3>
<div class="sourceCode" id="cb36"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb36-1"><a href="#cb36-1"></a><span class="co"># 逐次実行版</span></span>
<span id="cb36-2"><a href="#cb36-2"></a><span class="kw">function</span> <span class="fu">plot_seq</span>(x, y; maxiters <span class="op">=</span> <span class="fl">1000</span>)</span>
<span id="cb36-3"><a href="#cb36-3"></a>    m, n <span class="op">=</span> <span class="fu">length</span>.((y, x))</span>
<span id="cb36-4"><a href="#cb36-4"></a>    img <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Int16</span>, m, n)</span>
<span id="cb36-5"><a href="#cb36-5"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>n, i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>m</span>
<span id="cb36-6"><a href="#cb36-6"></a>        c <span class="op">=</span> <span class="fu">complex</span>(x[j], y[i])</span>
<span id="cb36-7"><a href="#cb36-7"></a>        img[i,j] <span class="op">=</span> <span class="fu">mandelbrot</span>(c; maxiters)</span>
<span id="cb36-8"><a href="#cb36-8"></a>    <span class="cf">end</span></span>
<span id="cb36-9"><a href="#cb36-9"></a>    <span class="cf">return</span> img</span>
<span id="cb36-10"><a href="#cb36-10"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="mbplot-par1.jl" class="level3">
<h3 class="anchored" data-anchor-id="mbplot-par1.jl">mb/plot-par1.jl</h3>
<div class="sourceCode" id="cb37"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb37-1"><a href="#cb37-1"></a><span class="co"># 並列実行版1</span></span>
<span id="cb37-2"><a href="#cb37-2"></a><span class="kw">function</span> <span class="fu">plot_par1</span>(x, y; maxiters <span class="op">=</span> N)</span>
<span id="cb37-3"><a href="#cb37-3"></a>    m, n <span class="op">=</span> <span class="fu">length</span>.((y, x))</span>
<span id="cb37-4"><a href="#cb37-4"></a>    img <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Int16</span>, m, n)</span>
<span id="cb37-5"><a href="#cb37-5"></a>    <span class="bu">Threads</span>.<span class="pp">@threads</span> <span class="op">:</span>static <span class="cf">for</span> j <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>n</span>
<span id="cb37-6"><a href="#cb37-6"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>m</span>
<span id="cb37-7"><a href="#cb37-7"></a>            c <span class="op">=</span> <span class="fu">complex</span>(x[j], y[i])</span>
<span id="cb37-8"><a href="#cb37-8"></a>            img[i,j] <span class="op">=</span> <span class="fu">mandelbrot</span>(c; maxiters)</span>
<span id="cb37-9"><a href="#cb37-9"></a>        <span class="cf">end</span></span>
<span id="cb37-10"><a href="#cb37-10"></a>    <span class="cf">end</span></span>
<span id="cb37-11"><a href="#cb37-11"></a>    <span class="cf">return</span> img</span>
<span id="cb37-12"><a href="#cb37-12"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="counter-lock.jl" class="level3">
<h3 class="anchored" data-anchor-id="counter-lock.jl">counter-lock.jl</h3>
<div class="sourceCode" id="cb38"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb38-1"><a href="#cb38-1"></a><span class="co"># ロックを使った排他制御</span></span>
<span id="cb38-2"><a href="#cb38-2"></a>counter <span class="op">=</span> <span class="fl">0</span></span>
<span id="cb38-3"><a href="#cb38-3"></a>mutex <span class="op">=</span> <span class="fu">ReentrantLock</span>()</span>
<span id="cb38-4"><a href="#cb38-4"></a><span class="bu">Threads</span>.<span class="pp">@threads</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1_000_000</span></span>
<span id="cb38-5"><a href="#cb38-5"></a>    <span class="kw">global</span> counter</span>
<span id="cb38-6"><a href="#cb38-6"></a>    <span class="fu">lock</span>(mutex)</span>
<span id="cb38-7"><a href="#cb38-7"></a>    <span class="co"># ←ここからクリティカルセクション</span></span>
<span id="cb38-8"><a href="#cb38-8"></a>    counter <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb38-9"><a href="#cb38-9"></a>    <span class="co"># ←ここまでクリティカルセクション</span></span>
<span id="cb38-10"><a href="#cb38-10"></a>    <span class="fu">unlock</span>(mutex)</span>
<span id="cb38-11"><a href="#cb38-11"></a><span class="cf">end</span></span>
<span id="cb38-12"><a href="#cb38-12"></a><span class="pp">@show</span> counter</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="notification.jl" class="level3">
<h3 class="anchored" data-anchor-id="notification.jl">notification.jl</h3>
<div class="sourceCode" id="cb39"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb39-1"><a href="#cb39-1"></a><span class="im">using</span> <span class="bu">.Threads</span>: Condition, @spawn</span>
<span id="cb39-2"><a href="#cb39-2"></a></span>
<span id="cb39-3"><a href="#cb39-3"></a><span class="pp">@sync</span> <span class="cf">begin</span></span>
<span id="cb39-4"><a href="#cb39-4"></a>    cond <span class="op">=</span> <span class="fu">Condition</span>()</span>
<span id="cb39-5"><a href="#cb39-5"></a>    ready <span class="op">=</span> <span class="cn">false</span></span>
<span id="cb39-6"><a href="#cb39-6"></a></span>
<span id="cb39-7"><a href="#cb39-7"></a>    <span class="co"># イベント通知をするタスク</span></span>
<span id="cb39-8"><a href="#cb39-8"></a>    <span class="pp">@spawn</span> <span class="cf">begin</span></span>
<span id="cb39-9"><a href="#cb39-9"></a>        <span class="fu">sleep</span>(<span class="fl">1</span>)</span>
<span id="cb39-10"><a href="#cb39-10"></a>        <span class="pp">@lock</span> cond <span class="cf">begin</span></span>
<span id="cb39-11"><a href="#cb39-11"></a>            ready <span class="op">=</span> <span class="cn">true</span></span>
<span id="cb39-12"><a href="#cb39-12"></a>            <span class="fu">println</span>(<span class="st">"Ready!"</span>)</span>
<span id="cb39-13"><a href="#cb39-13"></a>            <span class="co"># イベント通知</span></span>
<span id="cb39-14"><a href="#cb39-14"></a>            <span class="fu">notify</span>(cond)</span>
<span id="cb39-15"><a href="#cb39-15"></a>        <span class="cf">end</span></span>
<span id="cb39-16"><a href="#cb39-16"></a>    <span class="cf">end</span></span>
<span id="cb39-17"><a href="#cb39-17"></a></span>
<span id="cb39-18"><a href="#cb39-18"></a>    <span class="co"># イベント通知を受けるタスク</span></span>
<span id="cb39-19"><a href="#cb39-19"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">8</span></span>
<span id="cb39-20"><a href="#cb39-20"></a>        <span class="pp">@spawn</span> <span class="cf">begin</span></span>
<span id="cb39-21"><a href="#cb39-21"></a>            <span class="pp">@lock</span> cond <span class="cf">while</span> !ready</span>
<span id="cb39-22"><a href="#cb39-22"></a>                <span class="fu">wait</span>(cond)</span>
<span id="cb39-23"><a href="#cb39-23"></a>            <span class="cf">end</span></span>
<span id="cb39-24"><a href="#cb39-24"></a>            <span class="co"># イベント通知後の処理</span></span>
<span id="cb39-25"><a href="#cb39-25"></a>            <span class="fu">print</span>(<span class="st">"Go!"</span>)</span>
<span id="cb39-26"><a href="#cb39-26"></a>        <span class="cf">end</span></span>
<span id="cb39-27"><a href="#cb39-27"></a>    <span class="cf">end</span></span>
<span id="cb39-28"><a href="#cb39-28"></a><span class="cf">end</span></span>
<span id="cb39-29"><a href="#cb39-29"></a><span class="fu">println</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="counter-atomicadd.jl" class="level3">
<h3 class="anchored" data-anchor-id="counter-atomicadd.jl">counter-atomicadd.jl</h3>
<div class="sourceCode" id="cb40"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb40-1"><a href="#cb40-1"></a><span class="co"># アトミック操作によるカウンター</span></span>
<span id="cb40-2"><a href="#cb40-2"></a><span class="kw">mutable struct</span> Counter</span>
<span id="cb40-3"><a href="#cb40-3"></a>    <span class="pp">@atomic</span> count<span class="op">::</span><span class="dt">Int</span></span>
<span id="cb40-4"><a href="#cb40-4"></a><span class="kw">end</span></span>
<span id="cb40-5"><a href="#cb40-5"></a></span>
<span id="cb40-6"><a href="#cb40-6"></a>counter <span class="op">=</span> <span class="fu">Counter</span>(<span class="fl">0</span>)</span>
<span id="cb40-7"><a href="#cb40-7"></a><span class="bu">Threads</span>.<span class="pp">@threads</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1_000_000</span></span>
<span id="cb40-8"><a href="#cb40-8"></a>    <span class="pp">@atomic</span> counter.count <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb40-9"><a href="#cb40-9"></a><span class="cf">end</span></span>
<span id="cb40-10"><a href="#cb40-10"></a><span class="pp">@show</span> counter.count</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="atomic.jl" class="level3">
<h3 class="anchored" data-anchor-id="atomic.jl">atomic.jl</h3>
<div class="sourceCode" id="cb41"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb41-1"><a href="#cb41-1"></a><span class="co"># アトミック型</span></span>
<span id="cb41-2"><a href="#cb41-2"></a><span class="kw">mutable struct</span> <span class="dt">Atomic</span>{T}</span>
<span id="cb41-3"><a href="#cb41-3"></a>    <span class="pp">@atomic</span> data<span class="op">::</span><span class="dt">T</span></span>
<span id="cb41-4"><a href="#cb41-4"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="distaddworkers.jl" class="level3">
<h3 class="anchored" data-anchor-id="distaddworkers.jl">dist/addworkers.jl</h3>
<div class="sourceCode" id="cb42"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb42-1"><a href="#cb42-1"></a><span class="im">using</span> <span class="bu">Distributed</span></span>
<span id="cb42-2"><a href="#cb42-2"></a></span>
<span id="cb42-3"><a href="#cb42-3"></a><span class="kw">let</span></span>
<span id="cb42-4"><a href="#cb42-4"></a>    workers <span class="op">=</span> [</span>
<span id="cb42-5"><a href="#cb42-5"></a>        <span class="fu">split</span>(line, <span class="ch">'\t'</span>)[<span class="fl">1</span>]</span>
<span id="cb42-6"><a href="#cb42-6"></a>        for line <span class="kw">in</span> <span class="fu">eachline</span>(<span class="st">"workers.txt"</span>)]</span>
<span id="cb42-7"><a href="#cb42-7"></a>    exename <span class="op">=</span> <span class="st">"/usr/local/julia/bin/julia"</span></span>
<span id="cb42-8"><a href="#cb42-8"></a>    sshflags <span class="op">=</span> <span class="ss">`</span></span>
<span id="cb42-9"><a href="#cb42-9"></a>        <span class="op">-</span>q</span>
<span id="cb42-10"><a href="#cb42-10"></a>        <span class="op">-</span>i workerkey</span>
<span id="cb42-11"><a href="#cb42-11"></a>        <span class="op">-</span>o StrictHostKeyChecking<span class="op">=</span>no</span>
<span id="cb42-12"><a href="#cb42-12"></a>        <span class="op">-</span>o UserKnownHostsFile<span class="op">=/</span>dev<span class="op">/</span>null<span class="ss">`</span></span>
<span id="cb42-13"><a href="#cb42-13"></a>    <span class="fu">addprocs</span>(workers; dir <span class="op">=</span> <span class="st">"/"</span>, exename, sshflags)</span>
<span id="cb42-14"><a href="#cb42-14"></a>    <span class="pp">@info</span> <span class="st">"Connected to </span><span class="sc">$</span>(<span class="fu">length</span>(workers))<span class="st"> workers"</span></span>
<span id="cb42-15"><a href="#cb42-15"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="章-10" class="level2">
<h2 class="anchored" data-anchor-id="章-10">13章</h2>
<section id="walkpwd.jl" class="level3">
<h3 class="anchored" data-anchor-id="walkpwd.jl">walkpwd.jl</h3>
<div class="sourceCode" id="cb43"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb43-1"><a href="#cb43-1"></a><span class="co"># pwd()以下のすべてのディレクトリとファイルを再帰的に探索</span></span>
<span id="cb43-2"><a href="#cb43-2"></a><span class="cf">for</span> (root, dirs, files) <span class="kw">in</span> <span class="fu">walkdir</span>(<span class="fu">pwd</span>())</span>
<span id="cb43-3"><a href="#cb43-3"></a>    <span class="co"># root直下のディレクトリを列挙</span></span>
<span id="cb43-4"><a href="#cb43-4"></a>    <span class="cf">for</span> dir <span class="kw">in</span> dirs</span>
<span id="cb43-5"><a href="#cb43-5"></a>        <span class="fu">println</span>(<span class="st">"d:"</span>, <span class="fu">joinpath</span>(root, dir))</span>
<span id="cb43-6"><a href="#cb43-6"></a>    <span class="cf">end</span></span>
<span id="cb43-7"><a href="#cb43-7"></a>    <span class="co"># root直下のファイルを列挙</span></span>
<span id="cb43-8"><a href="#cb43-8"></a>    <span class="cf">for</span> file <span class="kw">in</span> files</span>
<span id="cb43-9"><a href="#cb43-9"></a>        <span class="fu">println</span>(<span class="st">"f:"</span>, <span class="fu">joinpath</span>(root, file))</span>
<span id="cb43-10"><a href="#cb43-10"></a>    <span class="cf">end</span></span>
<span id="cb43-11"><a href="#cb43-11"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="titlecase.jl" class="level3">
<h3 class="anchored" data-anchor-id="titlecase.jl">titlecase.jl</h3>
<div class="sourceCode" id="cb44"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb44-1"><a href="#cb44-1"></a><span class="co">#!/usr/bin/env julia</span></span>
<span id="cb44-2"><a href="#cb44-2"></a>line <span class="op">=</span> <span class="fu">readline</span>(<span class="cn">stdin</span>)</span>
<span id="cb44-3"><a href="#cb44-3"></a><span class="fu">println</span>(<span class="cn">stdout</span>, <span class="fu">titlecase</span>(line))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="json.jl" class="level3">
<h3 class="anchored" data-anchor-id="json.jl">json.jl</h3>
<div class="sourceCode" id="cb45"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb45-1"><a href="#cb45-1"></a><span class="im">using</span> <span class="bu">JSON</span></span>
<span id="cb45-2"><a href="#cb45-2"></a></span>
<span id="cb45-3"><a href="#cb45-3"></a><span class="co"># JSON形式の文字列のパース</span></span>
<span id="cb45-4"><a href="#cb45-4"></a>langs <span class="op">=</span> JSON.<span class="fu">parse</span>(<span class="st">"""</span></span>
<span id="cb45-5"><a href="#cb45-5"></a><span class="st">{</span></span>
<span id="cb45-6"><a href="#cb45-6"></a><span class="st">    "julia": {</span></span>
<span id="cb45-7"><a href="#cb45-7"></a><span class="st">        "first-release": 2012,</span></span>
<span id="cb45-8"><a href="#cb45-8"></a><span class="st">        "creators": [</span></span>
<span id="cb45-9"><a href="#cb45-9"></a><span class="st">            "Jeff Bezanson",</span></span>
<span id="cb45-10"><a href="#cb45-10"></a><span class="st">            "Stefen Karpinski",</span></span>
<span id="cb45-11"><a href="#cb45-11"></a><span class="st">            "Viral Shah"</span></span>
<span id="cb45-12"><a href="#cb45-12"></a><span class="st">        ]</span></span>
<span id="cb45-13"><a href="#cb45-13"></a><span class="st">    },</span></span>
<span id="cb45-14"><a href="#cb45-14"></a><span class="st">    "python": {</span></span>
<span id="cb45-15"><a href="#cb45-15"></a><span class="st">        "first-release": 1991,</span></span>
<span id="cb45-16"><a href="#cb45-16"></a><span class="st">        "creators": ["Guido van Rossum"]</span></span>
<span id="cb45-17"><a href="#cb45-17"></a><span class="st">    }</span></span>
<span id="cb45-18"><a href="#cb45-18"></a><span class="st">}</span></span>
<span id="cb45-19"><a href="#cb45-19"></a><span class="st">"""</span>)</span>
<span id="cb45-20"><a href="#cb45-20"></a></span>
<span id="cb45-21"><a href="#cb45-21"></a><span class="co"># JuliaのオブジェクトからJSON形式の文字列への変換</span></span>
<span id="cb45-22"><a href="#cb45-22"></a>JSON.<span class="fu">json</span>(langs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="logging.jl" class="level3">
<h3 class="anchored" data-anchor-id="logging.jl">logging.jl</h3>
<div class="sourceCode" id="cb46"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb46-1"><a href="#cb46-1"></a><span class="im">using</span> <span class="bu">Logging</span></span>
<span id="cb46-2"><a href="#cb46-2"></a></span>
<span id="cb46-3"><a href="#cb46-3"></a><span class="co"># ファイルに出力するロガー</span></span>
<span id="cb46-4"><a href="#cb46-4"></a>file <span class="op">=</span> <span class="fu">open</span>(<span class="st">"messages.log"</span>, <span class="st">"w"</span>)</span>
<span id="cb46-5"><a href="#cb46-5"></a>logger <span class="op">=</span> <span class="fu">ConsoleLogger</span>(file, <span class="bu">Logging</span>.Debug)</span>
<span id="cb46-6"><a href="#cb46-6"></a><span class="fu">with_logger</span>(logger) <span class="cf">do</span></span>
<span id="cb46-7"><a href="#cb46-7"></a>    <span class="pp">@info</span> <span class="st">"Info message"</span></span>
<span id="cb46-8"><a href="#cb46-8"></a>    <span class="pp">@debug</span> <span class="st">"Debug message"</span></span>
<span id="cb46-9"><a href="#cb46-9"></a><span class="cf">end</span></span>
<span id="cb46-10"><a href="#cb46-10"></a><span class="fu">close</span>(file)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="章-11" class="level2">
<h2 class="anchored" data-anchor-id="章-11">14章</h2>
<section id="toplogger.jl" class="level3">
<h3 class="anchored" data-anchor-id="toplogger.jl">toplogger.jl</h3>
<div class="sourceCode" id="cb47"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb47-1"><a href="#cb47-1"></a><span class="co"># topコマンドの1行目をlog.txtファイルに追記</span></span>
<span id="cb47-2"><a href="#cb47-2"></a>toplogger <span class="op">=</span> <span class="fu">pipeline</span>(</span>
<span id="cb47-3"><a href="#cb47-3"></a>    <span class="fu">pipeline</span>(<span class="ss">`top -b`</span>, <span class="cn">stdout</span> <span class="op">=</span> <span class="ss">`head -1`</span>),</span>
<span id="cb47-4"><a href="#cb47-4"></a>    <span class="cn">stdout</span> <span class="op">=</span> <span class="st">"log.txt"</span>,</span>
<span id="cb47-5"><a href="#cb47-5"></a>    append <span class="op">=</span> <span class="cn">true</span>,</span>
<span id="cb47-6"><a href="#cb47-6"></a>)</span>
<span id="cb47-7"><a href="#cb47-7"></a></span>
<span id="cb47-8"><a href="#cb47-8"></a><span class="co"># 1秒間隔で10回実行</span></span>
<span id="cb47-9"><a href="#cb47-9"></a><span class="cf">for</span> _ <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span></span>
<span id="cb47-10"><a href="#cb47-10"></a>    <span class="fu">run</span>(toplogger)</span>
<span id="cb47-11"><a href="#cb47-11"></a>    <span class="fu">sleep</span>(<span class="fl">1</span>)</span>
<span id="cb47-12"><a href="#cb47-12"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="章-12" class="level2">
<h2 class="anchored" data-anchor-id="章-12">15章</h2>
<section id="voyager.c" class="level3">
<h3 class="anchored" data-anchor-id="voyager.c">voyager.c</h3>
<div class="sourceCode" id="cb48"><pre class="sourceCode numberSource c number-lines code-with-copy"><code class="sourceCode c"><span id="cb48-1"><a href="#cb48-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb48-2"><a href="#cb48-2"></a></span>
<span id="cb48-3"><a href="#cb48-3"></a><span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> message <span class="op">=</span></span>
<span id="cb48-4"><a href="#cb48-4"></a>    <span class="st">"Hello from the children of planet Earth."</span><span class="op">;</span></span>
<span id="cb48-5"><a href="#cb48-5"></a></span>
<span id="cb48-6"><a href="#cb48-6"></a><span class="dt">void</span> say_hello<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb48-7"><a href="#cb48-7"></a><span class="op">{</span></span>
<span id="cb48-8"><a href="#cb48-8"></a>    printf<span class="op">(</span><span class="st">"</span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> message<span class="op">);</span></span>
<span id="cb48-9"><a href="#cb48-9"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="memcmp.jl" class="level3">
<h3 class="anchored" data-anchor-id="memcmp.jl">memcmp.jl</h3>
<div class="sourceCode" id="cb49"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb49-1"><a href="#cb49-1"></a><span class="co"># s1とs2のメモリ比較（o1とo2はオフセット）</span></span>
<span id="cb49-2"><a href="#cb49-2"></a><span class="kw">function</span> <span class="fu">memcmp</span>(x1, o1, x2, o2)</span>
<span id="cb49-3"><a href="#cb49-3"></a>    n <span class="op">=</span> <span class="fu">min</span>(<span class="fu">sizeof</span>(x1) <span class="op">-</span> o1, <span class="fu">sizeof</span>(x2) <span class="op">-</span> o2)</span>
<span id="cb49-4"><a href="#cb49-4"></a>    GC.<span class="pp">@preserve</span> x1 x2 <span class="cf">begin</span></span>
<span id="cb49-5"><a href="#cb49-5"></a>        s1 <span class="op">=</span> <span class="fu">pointer</span>(x1) <span class="op">+</span> o1</span>
<span id="cb49-6"><a href="#cb49-6"></a>        s2 <span class="op">=</span> <span class="fu">pointer</span>(x2) <span class="op">+</span> o2</span>
<span id="cb49-7"><a href="#cb49-7"></a>        <span class="co"># int memcmp(void *s1, void *s2, size_t n);</span></span>
<span id="cb49-8"><a href="#cb49-8"></a>        <span class="cf">return</span> <span class="fu">ccall</span>(</span>
<span id="cb49-9"><a href="#cb49-9"></a>            <span class="op">:</span>memcmp,</span>
<span id="cb49-10"><a href="#cb49-10"></a>            <span class="dt">Cint</span>,</span>
<span id="cb49-11"><a href="#cb49-11"></a>            (<span class="dt">Ptr</span>{Cvoid}, <span class="dt">Ptr</span>{Cvoid}, <span class="dt">Csize_t</span>),</span>
<span id="cb49-12"><a href="#cb49-12"></a>            s1, s2, n)</span>
<span id="cb49-13"><a href="#cb49-13"></a>    <span class="cf">end</span></span>
<span id="cb49-14"><a href="#cb49-14"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="sort.c" class="level3">
<h3 class="anchored" data-anchor-id="sort.c">sort.c</h3>
<div class="sourceCode" id="cb50"><pre class="sourceCode numberSource c number-lines code-with-copy"><code class="sourceCode c"><span id="cb50-1"><a href="#cb50-1"></a><span class="pp">#include </span><span class="im">&lt;stddef.h&gt;</span></span>
<span id="cb50-2"><a href="#cb50-2"></a></span>
<span id="cb50-3"><a href="#cb50-3"></a><span class="dt">void</span> sort<span class="op">(</span><span class="dt">double</span> <span class="op">*</span>xs<span class="op">,</span> <span class="dt">size_t</span> n<span class="op">)</span></span>
<span id="cb50-4"><a href="#cb50-4"></a><span class="op">{</span></span>
<span id="cb50-5"><a href="#cb50-5"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb50-6"><a href="#cb50-6"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> n<span class="op">;</span> j<span class="op">++)</span></span>
<span id="cb50-7"><a href="#cb50-7"></a>            <span class="cf">if</span> <span class="op">(</span>xs<span class="op">[</span>i<span class="op">]</span> <span class="op">&lt;</span> xs<span class="op">[</span>j<span class="op">])</span> <span class="op">{</span></span>
<span id="cb50-8"><a href="#cb50-8"></a>                <span class="co">// swap x[i] and x[j]</span></span>
<span id="cb50-9"><a href="#cb50-9"></a>                <span class="dt">double</span> tmp <span class="op">=</span> xs<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb50-10"><a href="#cb50-10"></a>                xs<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> xs<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb50-11"><a href="#cb50-11"></a>                xs<span class="op">[</span>j<span class="op">]</span> <span class="op">=</span> tmp<span class="op">;</span></span>
<span id="cb50-12"><a href="#cb50-12"></a>            <span class="op">}</span></span>
<span id="cb50-13"><a href="#cb50-13"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="textwrap.jl" class="level3">
<h3 class="anchored" data-anchor-id="textwrap.jl">textwrap.jl</h3>
<div class="sourceCode" id="cb51"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb51-1"><a href="#cb51-1"></a><span class="im">using</span> <span class="bu">PyCall</span></span>
<span id="cb51-2"><a href="#cb51-2"></a></span>
<span id="cb51-3"><a href="#cb51-3"></a><span class="co"># モジュールの読込みと関数定義</span></span>
<span id="cb51-4"><a href="#cb51-4"></a>py<span class="st">"""</span></span>
<span id="cb51-5"><a href="#cb51-5"></a><span class="st">import textwrap</span></span>
<span id="cb51-6"><a href="#cb51-6"></a></span>
<span id="cb51-7"><a href="#cb51-7"></a><span class="st"># wraptextはテキストを適当なところで折り返す</span></span>
<span id="cb51-8"><a href="#cb51-8"></a><span class="st">def wraptext(text, width=50):</span></span>
<span id="cb51-9"><a href="#cb51-9"></a><span class="st">    return "</span><span class="sc">\n</span><span class="st">".join(textwrap.wrap(text, width=width))</span></span>
<span id="cb51-10"><a href="#cb51-10"></a><span class="st">"""</span></span>
<span id="cb51-11"><a href="#cb51-11"></a></span>
<span id="cb51-12"><a href="#cb51-12"></a><span class="co"># 関数の取得</span></span>
<span id="cb51-13"><a href="#cb51-13"></a>wraptest <span class="op">=</span> py<span class="st">"wraptext"</span></span>
<span id="cb51-14"><a href="#cb51-14"></a></span>
<span id="cb51-15"><a href="#cb51-15"></a><span class="co"># 実行例</span></span>
<span id="cb51-16"><a href="#cb51-16"></a>longtext <span class="op">=</span> <span class="st">"Julia was designed from the beginning for high performance. Julia programs compile to efficient native code for multiple platforms via LLVM."</span></span>
<span id="cb51-17"><a href="#cb51-17"></a><span class="fu">println</span>(<span class="fu">wraptest</span>(longtext))</span>
<span id="cb51-18"><a href="#cb51-18"></a><span class="co">## Julia was designed from the beginning for high</span></span>
<span id="cb51-19"><a href="#cb51-19"></a><span class="co">## performance. Julia programs compile to efficient</span></span>
<span id="cb51-20"><a href="#cb51-20"></a><span class="co">## native code for multiple platforms via LLVM.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="章-13" class="level2">
<h2 class="anchored" data-anchor-id="章-13">16章</h2>
<section id="myprojecthello.jl" class="level3">
<h3 class="anchored" data-anchor-id="myprojecthello.jl">myproject/hello.jl</h3>
<div class="sourceCode" id="cb52"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb52-1"><a href="#cb52-1"></a><span class="im">using</span> <span class="bu">Example</span>: hello</span>
<span id="cb52-2"><a href="#cb52-2"></a></span>
<span id="cb52-3"><a href="#cb52-3"></a><span class="fu">println</span>(<span class="fu">hello</span>(<span class="cn">ARGS</span>[<span class="fl">1</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="pkgtemplate.jl" class="level3">
<h3 class="anchored" data-anchor-id="pkgtemplate.jl">pkgtemplate.jl</h3>
<div class="sourceCode" id="cb53"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb53-1"><a href="#cb53-1"></a><span class="im">using</span> <span class="bu">PkgTemplates</span></span>
<span id="cb53-2"><a href="#cb53-2"></a></span>
<span id="cb53-3"><a href="#cb53-3"></a>template <span class="op">=</span> <span class="fu">Template</span>(</span>
<span id="cb53-4"><a href="#cb53-4"></a>    <span class="co"># ~/workspace以下にパッケージを生成</span></span>
<span id="cb53-5"><a href="#cb53-5"></a>    dir <span class="op">=</span> <span class="st">"~/workspace"</span>,</span>
<span id="cb53-6"><a href="#cb53-6"></a>    <span class="co"># Julia 1.6以降をサポート</span></span>
<span id="cb53-7"><a href="#cb53-7"></a>    julia <span class="op">=</span> <span class="st">v"1.6"</span>,</span>
<span id="cb53-8"><a href="#cb53-8"></a>    <span class="co"># プラグインの設定</span></span>
<span id="cb53-9"><a href="#cb53-9"></a>    plugins <span class="op">=</span> [</span>
<span id="cb53-10"><a href="#cb53-10"></a>        <span class="co"># テスト固有の環境を有効化</span></span>
<span id="cb53-11"><a href="#cb53-11"></a>        <span class="fu">Tests</span>(project <span class="op">=</span> <span class="cn">true</span>),</span>
<span id="cb53-12"><a href="#cb53-12"></a>        <span class="co"># 自動化にGitHub Actionsを使用</span></span>
<span id="cb53-13"><a href="#cb53-13"></a>        <span class="fu">GitHubActions</span>(),</span>
<span id="cb53-14"><a href="#cb53-14"></a>        <span class="co"># カバレッジ報告にCodecovを使用</span></span>
<span id="cb53-15"><a href="#cb53-15"></a>        <span class="fu">Codecov</span>(),</span>
<span id="cb53-16"><a href="#cb53-16"></a>        <span class="co"># ドキュメント生成にDocumenter.jlを使用</span></span>
<span id="cb53-17"><a href="#cb53-17"></a>        <span class="fu">Documenter</span><span class="dt">{GitHubActions}</span>(),</span>
<span id="cb53-18"><a href="#cb53-18"></a>    ]</span>
<span id="cb53-19"><a href="#cb53-19"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="othellosrcothello.jl" class="level3">
<h3 class="anchored" data-anchor-id="othellosrcothello.jl">Othello/src/Othello.jl</h3>
<div class="sourceCode" id="cb54"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb54-1"><a href="#cb54-1"></a><span class="co"># Othelloモジュールの定義開始</span></span>
<span id="cb54-2"><a href="#cb54-2"></a><span class="kw">module</span> Othello</span>
<span id="cb54-3"><a href="#cb54-3"></a></span>
<span id="cb54-4"><a href="#cb54-4"></a><span class="co"># インターフェース（モジュール外から使う型や関数）</span></span>
<span id="cb54-5"><a href="#cb54-5"></a><span class="kw">export</span> User, RandomAI, play</span>
<span id="cb54-6"><a href="#cb54-6"></a></span>
<span id="cb54-7"><a href="#cb54-7"></a><span class="fu">include</span>(<span class="st">"disk.jl"</span>)</span>
<span id="cb54-8"><a href="#cb54-8"></a><span class="fu">include</span>(<span class="st">"position.jl"</span>)</span>
<span id="cb54-9"><a href="#cb54-9"></a><span class="fu">include</span>(<span class="st">"board.jl"</span>)</span>
<span id="cb54-10"><a href="#cb54-10"></a><span class="fu">include</span>(<span class="st">"player.jl"</span>)</span>
<span id="cb54-11"><a href="#cb54-11"></a><span class="fu">include</span>(<span class="st">"game.jl"</span>)</span>
<span id="cb54-12"><a href="#cb54-12"></a></span>
<span id="cb54-13"><a href="#cb54-13"></a><span class="kw">end</span>  <span class="co"># Othelloモジュールの定義終了</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="othellotestruntests.jl" class="level3">
<h3 class="anchored" data-anchor-id="othellotestruntests.jl">Othello/test/runtests.jl</h3>
<div class="sourceCode" id="cb55"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb55-1"><a href="#cb55-1"></a><span class="im">using</span> <span class="bu">Othello</span></span>
<span id="cb55-2"><a href="#cb55-2"></a><span class="im">using</span> <span class="bu">Test</span></span>
<span id="cb55-3"><a href="#cb55-3"></a></span>
<span id="cb55-4"><a href="#cb55-4"></a><span class="co"># 何度も使う変数は取り込んでおく</span></span>
<span id="cb55-5"><a href="#cb55-5"></a><span class="im">using</span> <span class="bu">Othello</span>: DISK_EMPTY, DISK_WHITE, DISK_BLACK</span>
<span id="cb55-6"><a href="#cb55-6"></a></span>
<span id="cb55-7"><a href="#cb55-7"></a><span class="co"># テストケースのグループ化</span></span>
<span id="cb55-8"><a href="#cb55-8"></a><span class="pp">@testset</span> <span class="st">"Othello.jl"</span> <span class="cf">begin</span></span>
<span id="cb55-9"><a href="#cb55-9"></a>    <span class="co"># flip関数のテスト</span></span>
<span id="cb55-10"><a href="#cb55-10"></a>    <span class="pp">@test</span> Othello.<span class="fu">flip</span>(DISK_WHITE) <span class="op">==</span> DISK_BLACK</span>
<span id="cb55-11"><a href="#cb55-11"></a>    <span class="pp">@test</span> Othello.<span class="fu">flip</span>(DISK_BLACK) <span class="op">==</span> DISK_WHITE</span>
<span id="cb55-12"><a href="#cb55-12"></a>    <span class="co"># ArgumentErrorが発生することをテスト</span></span>
<span id="cb55-13"><a href="#cb55-13"></a>    <span class="pp">@test_throws</span> <span class="dt">ArgumentError</span> Othello.<span class="fu">flip</span>(DISK_EMPTY)</span>
<span id="cb55-14"><a href="#cb55-14"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="message.jl" class="level3">
<h3 class="anchored" data-anchor-id="message.jl">message.jl</h3>
<div class="sourceCode" id="cb56"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb56-1"><a href="#cb56-1"></a><span class="st">"""</span></span>
<span id="cb56-2"><a href="#cb56-2"></a><span class="st">A data type to represent a message.</span></span>
<span id="cb56-3"><a href="#cb56-3"></a><span class="st">"""</span></span>
<span id="cb56-4"><a href="#cb56-4"></a><span class="kw">struct</span> Message</span>
<span id="cb56-5"><a href="#cb56-5"></a>    from<span class="op">::</span><span class="dt">String</span></span>
<span id="cb56-6"><a href="#cb56-6"></a>    content<span class="op">::</span><span class="dt">String</span></span>
<span id="cb56-7"><a href="#cb56-7"></a><span class="kw">end</span></span>
<span id="cb56-8"><a href="#cb56-8"></a></span>
<span id="cb56-9"><a href="#cb56-9"></a><span class="st">"""</span></span>
<span id="cb56-10"><a href="#cb56-10"></a><span class="st">    send(msg, to[; anonymous = false])</span></span>
<span id="cb56-11"><a href="#cb56-11"></a></span>
<span id="cb56-12"><a href="#cb56-12"></a><span class="st">Send a message `msg` to a person `to`.</span></span>
<span id="cb56-13"><a href="#cb56-13"></a></span>
<span id="cb56-14"><a href="#cb56-14"></a><span class="st">It sends the message and returns the number of written bytes.</span></span>
<span id="cb56-15"><a href="#cb56-15"></a></span>
<span id="cb56-16"><a href="#cb56-16"></a><span class="st"># Examples</span></span>
<span id="cb56-17"><a href="#cb56-17"></a><span class="st">```jldoctest</span></span>
<span id="cb56-18"><a href="#cb56-18"></a><span class="st">julia&gt; msg = Message("Alice", "Hi, how have you been?");</span></span>
<span id="cb56-19"><a href="#cb56-19"></a></span>
<span id="cb56-20"><a href="#cb56-20"></a><span class="st">julia&gt; send(msg, "Bob")</span></span>
<span id="cb56-21"><a href="#cb56-21"></a><span class="st">30</span></span>
<span id="cb56-22"><a href="#cb56-22"></a><span class="st">```</span></span>
<span id="cb56-23"><a href="#cb56-23"></a><span class="st">"""</span></span>
<span id="cb56-24"><a href="#cb56-24"></a><span class="kw">function</span> <span class="fu">send</span>(</span>
<span id="cb56-25"><a href="#cb56-25"></a>    msg<span class="op">::</span><span class="dt">Message</span>,</span>
<span id="cb56-26"><a href="#cb56-26"></a>    to<span class="op">::</span><span class="dt">AbstractString</span>;</span>
<span id="cb56-27"><a href="#cb56-27"></a>    anonymous<span class="op">::</span><span class="dt">Bool </span><span class="op">=</span> <span class="cn">false</span>,</span>
<span id="cb56-28"><a href="#cb56-28"></a>)</span>
<span id="cb56-29"><a href="#cb56-29"></a>    from <span class="op">=</span> anonymous ? <span class="st">"?"</span> <span class="op">:</span> msg.from</span>
<span id="cb56-30"><a href="#cb56-30"></a>    data <span class="op">=</span> <span class="st">"[</span><span class="sc">$</span>from<span class="st">] </span><span class="sc">$</span>(msg.content)<span class="st">"</span></span>
<span id="cb56-31"><a href="#cb56-31"></a>    <span class="cf">return</span> <span class="fu">write</span>(<span class="cn">devnull</span>, data)</span>
<span id="cb56-32"><a href="#cb56-32"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="章-14" class="level2">
<h2 class="anchored" data-anchor-id="章-14">17章</h2>
<section id="primetools.jl" class="level3">
<h3 class="anchored" data-anchor-id="primetools.jl">PrimeTools.jl</h3>
<div class="sourceCode" id="cb57"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb57-1"><a href="#cb57-1"></a><span class="kw">module</span> PrimeTools</span>
<span id="cb57-2"><a href="#cb57-2"></a></span>
<span id="cb57-3"><a href="#cb57-3"></a><span class="kw">function</span> <span class="fu">isprime</span>(n<span class="op">::</span><span class="dt">Integer</span>)</span>
<span id="cb57-4"><a href="#cb57-4"></a>    <span class="cf">if</span> n <span class="op">≤</span> <span class="fl">1</span></span>
<span id="cb57-5"><a href="#cb57-5"></a>        <span class="cf">return</span> <span class="cn">false</span></span>
<span id="cb57-6"><a href="#cb57-6"></a>    <span class="cf">end</span></span>
<span id="cb57-7"><a href="#cb57-7"></a>    i <span class="op">=</span> <span class="fl">2</span></span>
<span id="cb57-8"><a href="#cb57-8"></a>    <span class="cf">while</span> i <span class="op">≤</span> <span class="fu">isqrt</span>(n)</span>
<span id="cb57-9"><a href="#cb57-9"></a>        <span class="cf">if</span> n <span class="op">%</span> i <span class="op">==</span> <span class="fl">0</span></span>
<span id="cb57-10"><a href="#cb57-10"></a>            <span class="cf">return</span> <span class="cn">false</span></span>
<span id="cb57-11"><a href="#cb57-11"></a>        <span class="cf">end</span></span>
<span id="cb57-12"><a href="#cb57-12"></a>        i <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb57-13"><a href="#cb57-13"></a>    <span class="cf">end</span></span>
<span id="cb57-14"><a href="#cb57-14"></a>    <span class="cf">return</span> <span class="cn">true</span></span>
<span id="cb57-15"><a href="#cb57-15"></a><span class="kw">end</span></span>
<span id="cb57-16"><a href="#cb57-16"></a></span>
<span id="cb57-17"><a href="#cb57-17"></a><span class="kw">end</span>  <span class="co"># module</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="isin.jl" class="level3">
<h3 class="anchored" data-anchor-id="isin.jl">isin.jl</h3>
<div class="sourceCode" id="cb58"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb58-1"><a href="#cb58-1"></a><span class="co"># xがcolに含まれるか判定</span></span>
<span id="cb58-2"><a href="#cb58-2"></a><span class="kw">function</span> <span class="fu">isin</span>(x<span class="op">::</span><span class="dt">T</span>, col<span class="op">::</span><span class="dt">Vector{T}</span>) <span class="kw">where</span> T</span>
<span id="cb58-3"><a href="#cb58-3"></a>    <span class="cf">for</span> y <span class="kw">in</span> col</span>
<span id="cb58-4"><a href="#cb58-4"></a>        y <span class="op">==</span> x <span class="op">&amp;&amp;</span> <span class="cf">return</span> <span class="cn">true</span></span>
<span id="cb58-5"><a href="#cb58-5"></a>    <span class="cf">end</span></span>
<span id="cb58-6"><a href="#cb58-6"></a>    <span class="cf">return</span> <span class="cn">false</span></span>
<span id="cb58-7"><a href="#cb58-7"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="sum-unstable.jl" class="level3">
<h3 class="anchored" data-anchor-id="sum-unstable.jl">sum-unstable.jl</h3>
<div class="sourceCode" id="cb59"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb59-1"><a href="#cb59-1"></a><span class="co"># 型が安定していないsum関数の実装</span></span>
<span id="cb59-2"><a href="#cb59-2"></a><span class="kw">function</span> <span class="fu">sum_unstable</span>(xs)</span>
<span id="cb59-3"><a href="#cb59-3"></a>    s <span class="op">=</span> <span class="fl">0</span></span>
<span id="cb59-4"><a href="#cb59-4"></a>    <span class="cf">for</span> x <span class="kw">in</span> xs</span>
<span id="cb59-5"><a href="#cb59-5"></a>        s <span class="op">+=</span> x</span>
<span id="cb59-6"><a href="#cb59-6"></a>    <span class="cf">end</span></span>
<span id="cb59-7"><a href="#cb59-7"></a>    <span class="cf">return</span> s</span>
<span id="cb59-8"><a href="#cb59-8"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="loop.jl" class="level3">
<h3 class="anchored" data-anchor-id="loop.jl">loop.jl</h3>
<div class="sourceCode" id="cb60"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb60-1"><a href="#cb60-1"></a><span class="kw">function</span> <span class="fu">loop</span>(n)</span>
<span id="cb60-2"><a href="#cb60-2"></a>    s <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb60-3"><a href="#cb60-3"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>n</span>
<span id="cb60-4"><a href="#cb60-4"></a>        s <span class="op">+=</span> <span class="fu">sin</span>(i) <span class="op">/</span> i</span>
<span id="cb60-5"><a href="#cb60-5"></a>    <span class="cf">end</span></span>
<span id="cb60-6"><a href="#cb60-6"></a>    <span class="cf">return</span> <span class="fl">2</span>s <span class="op">+</span> <span class="fl">1</span></span>
<span id="cb60-7"><a href="#cb60-7"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="sum-stable.jl" class="level3">
<h3 class="anchored" data-anchor-id="sum-stable.jl">sum-stable.jl</h3>
<div class="sourceCode" id="cb61"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb61-1"><a href="#cb61-1"></a><span class="co"># 型が安定しているsum関数の実装</span></span>
<span id="cb61-2"><a href="#cb61-2"></a><span class="kw">function</span> <span class="fu">sum_stable</span>(xs)</span>
<span id="cb61-3"><a href="#cb61-3"></a>    s <span class="op">=</span> <span class="fu">zero</span>(<span class="fu">eltype</span>(xs))</span>
<span id="cb61-4"><a href="#cb61-4"></a>    <span class="cf">for</span> x <span class="kw">in</span> xs</span>
<span id="cb61-5"><a href="#cb61-5"></a>        s <span class="op">+=</span> x</span>
<span id="cb61-6"><a href="#cb61-6"></a>    <span class="cf">end</span></span>
<span id="cb61-7"><a href="#cb61-7"></a>    <span class="cf">return</span> s</span>
<span id="cb61-8"><a href="#cb61-8"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="章-15" class="level2">
<h2 class="anchored" data-anchor-id="章-15">18章</h2>
<section id="calccircle.jl" class="level3">
<h3 class="anchored" data-anchor-id="calccircle.jl">calccircle.jl</h3>
<div class="sourceCode" id="cb62"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb62-1"><a href="#cb62-1"></a><span class="co"># 円の直径・円周・面積の計算関数</span></span>
<span id="cb62-2"><a href="#cb62-2"></a><span class="fu">diameter</span>(r) <span class="op">=</span> <span class="fl">2</span>r</span>
<span id="cb62-3"><a href="#cb62-3"></a><span class="fu">circumference</span>(r) <span class="op">=</span> <span class="fu">diameter</span>(r) <span class="op">*</span> <span class="cn">π</span></span>
<span id="cb62-4"><a href="#cb62-4"></a><span class="fu">area</span>(r) <span class="op">=</span> <span class="cn">π</span> <span class="op">*</span> r<span class="op">^</span><span class="fl">2</span></span>
<span id="cb62-5"><a href="#cb62-5"></a></span>
<span id="cb62-6"><a href="#cb62-6"></a><span class="co"># メイン関数</span></span>
<span id="cb62-7"><a href="#cb62-7"></a><span class="kw">function</span> <span class="fu">main</span>(args)</span>
<span id="cb62-8"><a href="#cb62-8"></a>    r <span class="op">=</span> <span class="fu">parse</span>(<span class="dt">Float64</span>, args[<span class="fl">1</span>])</span>
<span id="cb62-9"><a href="#cb62-9"></a>    <span class="fu">println</span>(<span class="st">"       radius = </span><span class="sc">$</span>(r)<span class="st">"</span>)</span>
<span id="cb62-10"><a href="#cb62-10"></a>    <span class="fu">println</span>(<span class="st">"     diameter = </span><span class="sc">$</span>(<span class="fu">diameter</span>(r))<span class="st">"</span>)</span>
<span id="cb62-11"><a href="#cb62-11"></a>    <span class="fu">println</span>(<span class="st">"circumference = </span><span class="sc">$</span>(<span class="fu">circumference</span>(r))<span class="st">"</span>)</span>
<span id="cb62-12"><a href="#cb62-12"></a>    <span class="fu">println</span>(<span class="st">"         area = </span><span class="sc">$</span>(<span class="fu">area</span>(r))<span class="st">"</span>)</span>
<span id="cb62-13"><a href="#cb62-13"></a><span class="kw">end</span></span>
<span id="cb62-14"><a href="#cb62-14"></a></span>
<span id="cb62-15"><a href="#cb62-15"></a><span class="co"># プログラムのエントリーポイント</span></span>
<span id="cb62-16"><a href="#cb62-16"></a>(<span class="fu">abspath</span>(<span class="cn">PROGRAM_FILE</span>) <span class="op">==</span> <span class="pp">@__FILE__</span>) <span class="op">&amp;&amp;</span> <span class="fu">main</span>(<span class="cn">ARGS</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="calccircle-test.jl" class="level3">
<h3 class="anchored" data-anchor-id="calccircle-test.jl">calccircle-test.jl</h3>
<div class="sourceCode" id="cb63"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb63-1"><a href="#cb63-1"></a><span class="im">using</span> <span class="bu">Test</span></span>
<span id="cb63-2"><a href="#cb63-2"></a></span>
<span id="cb63-3"><a href="#cb63-3"></a><span class="fu">include</span>(<span class="st">"circle.jl"</span>)</span>
<span id="cb63-4"><a href="#cb63-4"></a></span>
<span id="cb63-5"><a href="#cb63-5"></a><span class="pp">@testset</span> <span class="st">"circle"</span> <span class="cf">begin</span></span>
<span id="cb63-6"><a href="#cb63-6"></a>    r <span class="op">=</span> <span class="fl">2.1</span></span>
<span id="cb63-7"><a href="#cb63-7"></a>    <span class="pp">@test</span> <span class="fu">diameter</span>(r) <span class="op">≈</span> <span class="fl">4.2</span></span>
<span id="cb63-8"><a href="#cb63-8"></a>    <span class="pp">@test</span> <span class="fu">circumference</span>(r) <span class="op">≈</span> <span class="fl">13.194689145077131</span></span>
<span id="cb63-9"><a href="#cb63-9"></a>    <span class="pp">@test</span> <span class="fu">area</span>(r) <span class="op">≈</span> <span class="fl">13.854423602330987</span></span>
<span id="cb63-10"><a href="#cb63-10"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="sleeper.jl" class="level3">
<h3 class="anchored" data-anchor-id="sleeper.jl">sleeper.jl</h3>
<div class="sourceCode" id="cb64"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb64-1"><a href="#cb64-1"></a><span class="co"># sleep関数を呼び出す関数</span></span>
<span id="cb64-2"><a href="#cb64-2"></a><span class="kw">function</span> <span class="fu">sleeper</span>()</span>
<span id="cb64-3"><a href="#cb64-3"></a>    <span class="fu">sleep</span>(<span class="fl">1</span>)</span>
<span id="cb64-4"><a href="#cb64-4"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">15</span></span>
<span id="cb64-5"><a href="#cb64-5"></a>        <span class="fu">sleep</span>(<span class="fl">0.1</span>)</span>
<span id="cb64-6"><a href="#cb64-6"></a>    <span class="cf">end</span></span>
<span id="cb64-7"><a href="#cb64-7"></a>    <span class="fu">deepsleeper</span>(<span class="fl">3</span>)</span>
<span id="cb64-8"><a href="#cb64-8"></a><span class="kw">end</span></span>
<span id="cb64-9"><a href="#cb64-9"></a></span>
<span id="cb64-10"><a href="#cb64-10"></a><span class="co"># 再帰関数</span></span>
<span id="cb64-11"><a href="#cb64-11"></a><span class="kw">function</span> <span class="fu">deepsleeper</span>(n)</span>
<span id="cb64-12"><a href="#cb64-12"></a>    <span class="cf">if</span> n <span class="op">≤</span> <span class="fl">1</span></span>
<span id="cb64-13"><a href="#cb64-13"></a>        <span class="fu">sleep</span>(<span class="fl">1</span>)</span>
<span id="cb64-14"><a href="#cb64-14"></a>    <span class="cf">else</span></span>
<span id="cb64-15"><a href="#cb64-15"></a>        <span class="fu">deepsleeper</span>(n <span class="op">-</span> <span class="fl">1</span>)</span>
<span id="cb64-16"><a href="#cb64-16"></a>    <span class="cf">end</span></span>
<span id="cb64-17"><a href="#cb64-17"></a><span class="kw">end</span></span>
<span id="cb64-18"><a href="#cb64-18"></a></span>
<span id="cb64-19"><a href="#cb64-19"></a><span class="im">using</span> <span class="bu">Profile</span></span>
<span id="cb64-20"><a href="#cb64-20"></a><span class="fu">sleeper</span>()           <span class="co"># コンパイル</span></span>
<span id="cb64-21"><a href="#cb64-21"></a><span class="pp">@profile</span> <span class="fu">sleeper</span>()  <span class="co"># プロファイル</span></span>
<span id="cb64-22"><a href="#cb64-22"></a><span class="bu">Profile</span>.<span class="fu">print</span>()     <span class="co"># プロファイル結果の出力</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="allocator.jl" class="level3">
<h3 class="anchored" data-anchor-id="allocator.jl">allocator.jl</h3>
<div class="sourceCode" id="cb65"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb65-1"><a href="#cb65-1"></a><span class="co"># メモリを割り当てる関数</span></span>
<span id="cb65-2"><a href="#cb65-2"></a><span class="kw">function</span> <span class="fu">allocator</span>(n)</span>
<span id="cb65-3"><a href="#cb65-3"></a>    <span class="fu">zeros</span>(n)</span>
<span id="cb65-4"><a href="#cb65-4"></a>    <span class="fu">zeros</span>(n, n)</span>
<span id="cb65-5"><a href="#cb65-5"></a>    <span class="fu">zeros</span>(n, n, n)</span>
<span id="cb65-6"><a href="#cb65-6"></a><span class="kw">end</span></span>
<span id="cb65-7"><a href="#cb65-7"></a></span>
<span id="cb65-8"><a href="#cb65-8"></a><span class="im">using</span> <span class="bu">Profile</span></span>
<span id="cb65-9"><a href="#cb65-9"></a><span class="fu">allocator</span>(<span class="fl">1</span>)                 <span class="co"># コンパイル</span></span>
<span id="cb65-10"><a href="#cb65-10"></a><span class="bu">Profile</span>.<span class="fu">clear_malloc_data</span>()  <span class="co"># リセット</span></span>
<span id="cb65-11"><a href="#cb65-11"></a><span class="fu">allocator</span>(<span class="fl">100</span>)               <span class="co"># プロファイル</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="vec4.jl" class="level3">
<h3 class="anchored" data-anchor-id="vec4.jl">vec4.jl</h3>
<div class="sourceCode" id="cb66"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb66-1"><a href="#cb66-1"></a><span class="co"># 長さ4のベクトル</span></span>
<span id="cb66-2"><a href="#cb66-2"></a><span class="kw">struct</span> Vec4{T}</span>
<span id="cb66-3"><a href="#cb66-3"></a>    x<span class="op">::</span><span class="dt">T</span></span>
<span id="cb66-4"><a href="#cb66-4"></a>    y<span class="op">::</span><span class="dt">T</span></span>
<span id="cb66-5"><a href="#cb66-5"></a>    z<span class="op">::</span><span class="dt">T</span></span>
<span id="cb66-6"><a href="#cb66-6"></a>    w<span class="op">::</span><span class="dt">T</span></span>
<span id="cb66-7"><a href="#cb66-7"></a><span class="kw">end</span></span>
<span id="cb66-8"><a href="#cb66-8"></a></span>
<span id="cb66-9"><a href="#cb66-9"></a><span class="co"># Vec4型のnorm</span></span>
<span id="cb66-10"><a href="#cb66-10"></a><span class="fu">norm</span>(v<span class="op">::</span><span class="dt">Vec4</span>) <span class="op">=</span></span>
<span id="cb66-11"><a href="#cb66-11"></a>    <span class="fu">sqrt</span>(<span class="fu">abs2</span>(v.x) <span class="op">+</span> <span class="fu">abs2</span>(v.y) <span class="op">+</span> <span class="fu">abs2</span>(v.z) <span class="op">+</span> <span class="fu">abs2</span>(v.w))</span>
<span id="cb66-12"><a href="#cb66-12"></a></span>
<span id="cb66-13"><a href="#cb66-13"></a><span class="co"># Vector型のnorm</span></span>
<span id="cb66-14"><a href="#cb66-14"></a><span class="kw">function</span> <span class="fu">norm</span>(v<span class="op">::</span><span class="dt">AbstractVector</span>)</span>
<span id="cb66-15"><a href="#cb66-15"></a>    s <span class="op">=</span> <span class="fu">zero</span>(<span class="fu">eltype</span>(v))</span>
<span id="cb66-16"><a href="#cb66-16"></a>    <span class="cf">for</span> x <span class="kw">in</span> v</span>
<span id="cb66-17"><a href="#cb66-17"></a>        s <span class="op">+=</span> <span class="fu">abs2</span>(x)</span>
<span id="cb66-18"><a href="#cb66-18"></a>    <span class="cf">end</span></span>
<span id="cb66-19"><a href="#cb66-19"></a>    <span class="cf">return</span> <span class="fu">sqrt</span>(s)</span>
<span id="cb66-20"><a href="#cb66-20"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="rank1matrix.jl" class="level3">
<h3 class="anchored" data-anchor-id="rank1matrix.jl">rank1matrix.jl</h3>
<div class="sourceCode" id="cb67"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb67-1"><a href="#cb67-1"></a><span class="im">using</span> <span class="bu">LinearAlgebra</span>: norm, normalize, normalize!</span>
<span id="cb67-2"><a href="#cb67-2"></a></span>
<span id="cb67-3"><a href="#cb67-3"></a><span class="co"># 階数が1以下の行列</span></span>
<span id="cb67-4"><a href="#cb67-4"></a><span class="kw">struct</span> Rank1Matrix{T} <span class="op">&lt;:</span><span class="dt"> AbstractMatrix{T}</span></span>
<span id="cb67-5"><a href="#cb67-5"></a>    <span class="co"># A = u * v'</span></span>
<span id="cb67-6"><a href="#cb67-6"></a>    u<span class="op">::</span><span class="dt">Vector{T}</span></span>
<span id="cb67-7"><a href="#cb67-7"></a>    v<span class="op">::</span><span class="dt">Vector{T}</span></span>
<span id="cb67-8"><a href="#cb67-8"></a><span class="kw">end</span></span>
<span id="cb67-9"><a href="#cb67-9"></a></span>
<span id="cb67-10"><a href="#cb67-10"></a><span class="co"># 基本操作</span></span>
<span id="cb67-11"><a href="#cb67-11"></a><span class="bu">Base</span>.<span class="fu">size</span>(A<span class="op">::</span><span class="dt">Rank1Matrix</span>) <span class="op">=</span> (<span class="fu">length</span>(A.u), <span class="fu">length</span>(A.v))</span>
<span id="cb67-12"><a href="#cb67-12"></a><span class="bu">Base</span>.<span class="fu">getindex</span>(A<span class="op">::</span><span class="dt">Rank1Matrix</span>, i<span class="op">::</span><span class="dt">Integer</span>, j<span class="op">::</span><span class="dt">Integer</span>) <span class="op">=</span></span>
<span id="cb67-13"><a href="#cb67-13"></a>    A.u[i] <span class="op">*</span> A.v[j]</span>
<span id="cb67-14"><a href="#cb67-14"></a></span>
<span id="cb67-15"><a href="#cb67-15"></a><span class="co"># Matrix型への変換</span></span>
<span id="cb67-16"><a href="#cb67-16"></a><span class="fu">Matrix</span>(A<span class="op">::</span><span class="dt">Rank1Matrix</span>) <span class="op">=</span> A.u <span class="op">*</span> A.v<span class="op">'</span></span>
<span id="cb67-17"><a href="#cb67-17"></a></span>
<span id="cb67-18"><a href="#cb67-18"></a><span class="co"># 行列ベクトル積</span></span>
<span id="cb67-19"><a href="#cb67-19"></a><span class="bu">Base</span>.<span class="op">:</span><span class="fu">*</span>(A<span class="op">::</span><span class="dt">Rank1Matrix</span>, x<span class="op">::</span><span class="dt">AbstractVector</span>) <span class="op">=</span> A.u <span class="op">*</span> A.v<span class="op">'</span>x</span>
<span id="cb67-20"><a href="#cb67-20"></a></span>
<span id="cb67-21"><a href="#cb67-21"></a><span class="co"># 行列積</span></span>
<span id="cb67-22"><a href="#cb67-22"></a><span class="bu">Base</span>.<span class="op">:</span><span class="fu">*</span>(A<span class="op">::</span><span class="dt">Rank1Matrix</span>, B<span class="op">::</span><span class="dt">Rank1Matrix</span>) <span class="op">=</span></span>
<span id="cb67-23"><a href="#cb67-23"></a>    <span class="fu">Rank1Matrix</span>(A.u <span class="op">*</span> A.v<span class="op">'</span>B.u, B.v)</span>
<span id="cb67-24"><a href="#cb67-24"></a><span class="bu">Base</span>.<span class="op">:</span><span class="fu">*</span>(A<span class="op">::</span><span class="dt">Rank1Matrix</span>, B<span class="op">::</span><span class="dt">AbstractMatrix</span>) <span class="op">=</span></span>
<span id="cb67-25"><a href="#cb67-25"></a>    <span class="fu">Rank1Matrix</span>(A.u, B<span class="op">'</span>A.v)</span>
<span id="cb67-26"><a href="#cb67-26"></a><span class="bu">Base</span>.<span class="op">:</span><span class="fu">*</span>(A<span class="op">::</span><span class="dt">AbstractMatrix</span>, B<span class="op">::</span><span class="dt">Rank1Matrix</span>) <span class="op">=</span></span>
<span id="cb67-27"><a href="#cb67-27"></a>    <span class="fu">Rank1Matrix</span>(A <span class="op">*</span> B.u, B.v)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="database.jl" class="level3">
<h3 class="anchored" data-anchor-id="database.jl">database.jl</h3>
<div class="sourceCode" id="cb68"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb68-1"><a href="#cb68-1"></a><span class="co"># データベースのレコード</span></span>
<span id="cb68-2"><a href="#cb68-2"></a><span class="kw">struct</span> Record{T}</span>
<span id="cb68-3"><a href="#cb68-3"></a>    serial<span class="op">::</span><span class="dt">Int</span></span>
<span id="cb68-4"><a href="#cb68-4"></a>    data<span class="op">::</span><span class="dt">T</span></span>
<span id="cb68-5"><a href="#cb68-5"></a><span class="kw">end</span></span>
<span id="cb68-6"><a href="#cb68-6"></a></span>
<span id="cb68-7"><a href="#cb68-7"></a><span class="co"># データベース</span></span>
<span id="cb68-8"><a href="#cb68-8"></a><span class="kw">struct</span> Database{T}</span>
<span id="cb68-9"><a href="#cb68-9"></a>    records<span class="op">::</span><span class="dt">Vector{Record{T}}</span></span>
<span id="cb68-10"><a href="#cb68-10"></a><span class="kw">end</span></span>
<span id="cb68-11"><a href="#cb68-11"></a></span>
<span id="cb68-12"><a href="#cb68-12"></a><span class="co"># 空のデータベースのコンストラクタ</span></span>
<span id="cb68-13"><a href="#cb68-13"></a><span class="fu">Database</span><span class="dt">{T}</span>() <span class="kw">where</span> T <span class="op">=</span> <span class="fu">Database</span><span class="dt">{T}</span>(Record{T}[])</span>
<span id="cb68-14"><a href="#cb68-14"></a></span>
<span id="cb68-15"><a href="#cb68-15"></a><span class="co"># データベースに新しいレコードを追加</span></span>
<span id="cb68-16"><a href="#cb68-16"></a><span class="kw">function</span> <span class="bu">Base</span>.<span class="fu">push!</span>(db<span class="op">::</span><span class="dt">Database{T}</span>, item) <span class="kw">where</span> T</span>
<span id="cb68-17"><a href="#cb68-17"></a>    serial <span class="op">=</span> <span class="fu">length</span>(db.records)</span>
<span id="cb68-18"><a href="#cb68-18"></a>    record <span class="op">=</span> <span class="fu">Record</span>(serial, <span class="fu">convert</span>(T, item))</span>
<span id="cb68-19"><a href="#cb68-19"></a>    <span class="fu">push!</span>(db.records, record)</span>
<span id="cb68-20"><a href="#cb68-20"></a>    <span class="cf">return</span> db</span>
<span id="cb68-21"><a href="#cb68-21"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="split.jl" class="level3">
<h3 class="anchored" data-anchor-id="split.jl">split.jl</h3>
<div class="sourceCode" id="cb69"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb69-1"><a href="#cb69-1"></a><span class="co"># SubString版</span></span>
<span id="cb69-2"><a href="#cb69-2"></a><span class="kw">function</span> <span class="fu">split_sub</span>(isprefix, s)</span>
<span id="cb69-3"><a href="#cb69-3"></a>    pos <span class="op">=</span> <span class="fu">findfirst</span>(!isprefix, s)</span>
<span id="cb69-4"><a href="#cb69-4"></a>    pos <span class="op">===</span> <span class="cn">nothing</span> <span class="op">&amp;&amp;</span> <span class="cf">return</span> <span class="fu">SubString</span>(s), <span class="fu">SubString</span>(<span class="st">""</span>)</span>
<span id="cb69-5"><a href="#cb69-5"></a>    <span class="cf">return</span> <span class="pp">@view</span>(s[begin<span class="op">:</span><span class="fu">prevind</span>(s, pos)]), <span class="pp">@view</span>(s[pos<span class="op">:</span><span class="kw">end</span>])</span>
<span id="cb69-6"><a href="#cb69-6"></a><span class="kw">end</span></span>
<span id="cb69-7"><a href="#cb69-7"></a></span>
<span id="cb69-8"><a href="#cb69-8"></a><span class="co"># String版</span></span>
<span id="cb69-9"><a href="#cb69-9"></a><span class="kw">function</span> <span class="fu">split_str</span>(isprefix, s)</span>
<span id="cb69-10"><a href="#cb69-10"></a>    pos <span class="op">=</span> <span class="fu">findfirst</span>(!isprefix, s)</span>
<span id="cb69-11"><a href="#cb69-11"></a>    pos <span class="op">===</span> <span class="cn">nothing</span> <span class="op">&amp;&amp;</span> <span class="cf">return</span> s, <span class="st">""</span></span>
<span id="cb69-12"><a href="#cb69-12"></a>    <span class="cf">return</span> s[begin<span class="op">:</span><span class="fu">prevind</span>(s, pos)], s[pos<span class="op">:</span><span class="kw">end</span>]</span>
<span id="cb69-13"><a href="#cb69-13"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="rowmins.jl" class="level3">
<h3 class="anchored" data-anchor-id="rowmins.jl">rowmins.jl</h3>
<div class="sourceCode" id="cb70"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb70-1"><a href="#cb70-1"></a><span class="co"># 各行の最小値を計算する関数（行優先）</span></span>
<span id="cb70-2"><a href="#cb70-2"></a><span class="kw">function</span> <span class="fu">rowmins_row</span>(A)</span>
<span id="cb70-3"><a href="#cb70-3"></a>    a <span class="op">=</span> A[<span class="op">:</span>,begin]</span>
<span id="cb70-4"><a href="#cb70-4"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">axes</span>(A, <span class="fl">1</span>)</span>
<span id="cb70-5"><a href="#cb70-5"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="fu">firstindex</span>(A, <span class="fl">2</span>)<span class="op">+</span><span class="fl">1</span><span class="op">:</span><span class="fu">lastindex</span>(A, <span class="fl">2</span>)</span>
<span id="cb70-6"><a href="#cb70-6"></a>            <span class="pp">@inbounds</span> a[i] <span class="op">=</span> <span class="fu">min</span>(A[i,j], a[i])</span>
<span id="cb70-7"><a href="#cb70-7"></a>        <span class="cf">end</span></span>
<span id="cb70-8"><a href="#cb70-8"></a>    <span class="cf">end</span></span>
<span id="cb70-9"><a href="#cb70-9"></a>    <span class="cf">return</span> a</span>
<span id="cb70-10"><a href="#cb70-10"></a><span class="kw">end</span></span>
<span id="cb70-11"><a href="#cb70-11"></a></span>
<span id="cb70-12"><a href="#cb70-12"></a><span class="co"># 各行の最小値を計算する関数（列優先）</span></span>
<span id="cb70-13"><a href="#cb70-13"></a><span class="kw">function</span> <span class="fu">rowmins_col</span>(A)</span>
<span id="cb70-14"><a href="#cb70-14"></a>    a <span class="op">=</span> A[<span class="op">:</span>,begin]</span>
<span id="cb70-15"><a href="#cb70-15"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="fu">firstindex</span>(A, <span class="fl">2</span>)<span class="op">+</span><span class="fl">1</span><span class="op">:</span><span class="fu">lastindex</span>(A, <span class="fl">2</span>)</span>
<span id="cb70-16"><a href="#cb70-16"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">axes</span>(A, <span class="fl">1</span>)</span>
<span id="cb70-17"><a href="#cb70-17"></a>            <span class="pp">@inbounds</span> a[i] <span class="op">=</span> <span class="fu">min</span>(A[i,j], a[i])</span>
<span id="cb70-18"><a href="#cb70-18"></a>        <span class="cf">end</span></span>
<span id="cb70-19"><a href="#cb70-19"></a>    <span class="cf">end</span></span>
<span id="cb70-20"><a href="#cb70-20"></a>    <span class="cf">return</span> a</span>
<span id="cb70-21"><a href="#cb70-21"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="sortmerge.jl" class="level3">
<h3 class="anchored" data-anchor-id="sortmerge.jl">sortmerge.jl</h3>
<div class="sourceCode" id="cb71"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb71-1"><a href="#cb71-1"></a><span class="co"># ソート済の配列A,Bの要素を配列Cに昇順にコピー</span></span>
<span id="cb71-2"><a href="#cb71-2"></a><span class="kw">function</span> <span class="fu">sortmerge!</span>(C, A, B)</span>
<span id="cb71-3"><a href="#cb71-3"></a>    <span class="pp">@assert</span> <span class="fu">length</span>(A) <span class="op">+</span> <span class="fu">length</span>(B) <span class="op">==</span> <span class="fu">length</span>(C)</span>
<span id="cb71-4"><a href="#cb71-4"></a>    i, j, k <span class="op">=</span> <span class="fu">firstindex</span>.((A, B, C))</span>
<span id="cb71-5"><a href="#cb71-5"></a>    <span class="pp">@inbounds</span> <span class="cf">while</span> i <span class="op">≤</span> <span class="fu">lastindex</span>(A) <span class="op">&amp;&amp;</span> j <span class="op">≤</span> <span class="fu">lastindex</span>(B)</span>
<span id="cb71-6"><a href="#cb71-6"></a>        a <span class="op">=</span> A[i]</span>
<span id="cb71-7"><a href="#cb71-7"></a>        b <span class="op">=</span> B[j]</span>
<span id="cb71-8"><a href="#cb71-8"></a>        <span class="cf">if</span> <span class="fu">isless</span>(a, b)</span>
<span id="cb71-9"><a href="#cb71-9"></a>            C[k] <span class="op">=</span> a</span>
<span id="cb71-10"><a href="#cb71-10"></a>            i <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb71-11"><a href="#cb71-11"></a>        <span class="cf">else</span></span>
<span id="cb71-12"><a href="#cb71-12"></a>            C[k] <span class="op">=</span> b</span>
<span id="cb71-13"><a href="#cb71-13"></a>            j <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb71-14"><a href="#cb71-14"></a>        <span class="cf">end</span></span>
<span id="cb71-15"><a href="#cb71-15"></a>        k <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb71-16"><a href="#cb71-16"></a>    <span class="cf">end</span></span>
<span id="cb71-17"><a href="#cb71-17"></a>    <span class="cf">if</span> i <span class="op">≤</span> <span class="fu">lastindex</span>(A)</span>
<span id="cb71-18"><a href="#cb71-18"></a>        <span class="fu">copyto!</span>(C, k, A, i, <span class="fu">lastindex</span>(A) <span class="op">-</span> i <span class="op">+</span> <span class="fl">1</span>)</span>
<span id="cb71-19"><a href="#cb71-19"></a>    <span class="cf">else</span></span>
<span id="cb71-20"><a href="#cb71-20"></a>        <span class="fu">copyto!</span>(C, k, B, j, <span class="fu">lastindex</span>(B) <span class="op">-</span> j <span class="op">+</span> <span class="fl">1</span>)</span>
<span id="cb71-21"><a href="#cb71-21"></a>    <span class="cf">end</span></span>
<span id="cb71-22"><a href="#cb71-22"></a>    <span class="cf">return</span> C</span>
<span id="cb71-23"><a href="#cb71-23"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="b64hex2char.jl" class="level3">
<h3 class="anchored" data-anchor-id="b64hex2char.jl">b64/hex2char.jl</h3>
<div class="sourceCode" id="cb72"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb72-1"><a href="#cb72-1"></a><span class="co"># 6ビットから1文字への変換関数</span></span>
<span id="cb72-2"><a href="#cb72-2"></a><span class="fu">hex2char</span>(h<span class="op">::</span><span class="dt">UInt8</span>) <span class="op">=</span></span>
<span id="cb72-3"><a href="#cb72-3"></a>    h <span class="op">&lt;</span> <span class="bn">0x1a</span> ? <span class="fu">UInt8</span>(<span class="ch">'A'</span>) <span class="op">+</span> h        <span class="op">:</span></span>
<span id="cb72-4"><a href="#cb72-4"></a>    h <span class="op">&lt;</span> <span class="bn">0x34</span> ? <span class="fu">UInt8</span>(<span class="ch">'a'</span>) <span class="op">+</span> h <span class="op">-</span> <span class="bn">0x1a</span> <span class="op">:</span></span>
<span id="cb72-5"><a href="#cb72-5"></a>    h <span class="op">&lt;</span> <span class="bn">0x3e</span> ? <span class="fu">UInt8</span>(<span class="ch">'0'</span>) <span class="op">+</span> h <span class="op">-</span> <span class="bn">0x34</span> <span class="op">:</span></span>
<span id="cb72-6"><a href="#cb72-6"></a>    h <span class="op">≡</span> <span class="bn">0x3e</span> ? <span class="fu">UInt8</span>(<span class="ch">'+'</span>) <span class="op">:</span> <span class="fu">UInt8</span>(<span class="ch">'/'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="b64encode1.jl" class="level3">
<h3 class="anchored" data-anchor-id="b64encode1.jl">b64/encode1.jl</h3>
<div class="sourceCode" id="cb73"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb73-1"><a href="#cb73-1"></a><span class="co"># Base64符号化関数（バージョン1）</span></span>
<span id="cb73-2"><a href="#cb73-2"></a><span class="kw">function</span> <span class="fu">encode1</span>(data<span class="op">::</span><span class="dt">AbstractVector{UInt8}</span>)</span>
<span id="cb73-3"><a href="#cb73-3"></a>    str <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">UInt8</span>, <span class="fu">cld</span>(<span class="fu">sizeof</span>(data), <span class="fl">3</span>) <span class="op">*</span> <span class="fl">4</span>)</span>
<span id="cb73-4"><a href="#cb73-4"></a>    i <span class="op">=</span> <span class="fu">firstindex</span>(data)</span>
<span id="cb73-5"><a href="#cb73-5"></a>    j <span class="op">=</span> <span class="fu">firstindex</span>(str)</span>
<span id="cb73-6"><a href="#cb73-6"></a>    k <span class="op">=</span> <span class="fl">0</span>     <span class="co"># 持ち越されたビットの長さ</span></span>
<span id="cb73-7"><a href="#cb73-7"></a>    h <span class="op">=</span> <span class="bn">0x00</span>  <span class="co"># 持ち越されたビット</span></span>
<span id="cb73-8"><a href="#cb73-8"></a>    <span class="pp">@inbounds</span> <span class="cf">while</span> i <span class="op">≤</span> <span class="fu">lastindex</span>(data)</span>
<span id="cb73-9"><a href="#cb73-9"></a>        x <span class="op">=</span> data[i]</span>
<span id="cb73-10"><a href="#cb73-10"></a>        str[j] <span class="op">=</span> <span class="fu">hex2char</span>(h <span class="op">|</span> x <span class="op">&gt;&gt;</span> (k <span class="op">+</span> <span class="fl">2</span>))</span>
<span id="cb73-11"><a href="#cb73-11"></a>        j <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb73-12"><a href="#cb73-12"></a>        k <span class="op">+=</span> <span class="fl">2</span>; k <span class="op">%=</span> <span class="fl">8</span></span>
<span id="cb73-13"><a href="#cb73-13"></a>        h <span class="op">=</span> <span class="bn">0x3f</span> <span class="op">&amp;</span> x <span class="op">&lt;&lt;</span> (<span class="fl">6</span> <span class="op">-</span> k)</span>
<span id="cb73-14"><a href="#cb73-14"></a>        k <span class="op">≤</span> <span class="fl">4</span> <span class="op">&amp;&amp;</span> (i <span class="op">+=</span> <span class="fl">1</span>)</span>
<span id="cb73-15"><a href="#cb73-15"></a>    <span class="cf">end</span></span>
<span id="cb73-16"><a href="#cb73-16"></a>    <span class="co"># 余ったビットの処理</span></span>
<span id="cb73-17"><a href="#cb73-17"></a>    k <span class="op">==</span> <span class="fl">0</span> <span class="op">||</span> (str[j] <span class="op">=</span> <span class="fu">hex2char</span>(h); j <span class="op">+=</span> <span class="fl">1</span>)</span>
<span id="cb73-18"><a href="#cb73-18"></a>    <span class="co"># パディング処理</span></span>
<span id="cb73-19"><a href="#cb73-19"></a>    j <span class="op">≤</span> <span class="fu">lastindex</span>(str) <span class="op">&amp;&amp;</span> (str[j] <span class="op">=</span> <span class="fu">UInt</span>(<span class="ch">'='</span>); j <span class="op">+=</span> <span class="fl">1</span>)</span>
<span id="cb73-20"><a href="#cb73-20"></a>    j <span class="op">≤</span> <span class="fu">lastindex</span>(str) <span class="op">&amp;&amp;</span> (str[j] <span class="op">=</span> <span class="fu">UInt</span>(<span class="ch">'='</span>); j <span class="op">+=</span> <span class="fl">1</span>)</span>
<span id="cb73-21"><a href="#cb73-21"></a>    <span class="cf">return</span> str</span>
<span id="cb73-22"><a href="#cb73-22"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="b64encode2.jl" class="level3">
<h3 class="anchored" data-anchor-id="b64encode2.jl">b64/encode2.jl</h3>
<div class="sourceCode" id="cb74"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb74-1"><a href="#cb74-1"></a><span class="co"># Base64符号化関数（バージョン2）</span></span>
<span id="cb74-2"><a href="#cb74-2"></a><span class="kw">function</span> <span class="fu">encode2</span>(data<span class="op">::</span><span class="dt">AbstractVector{UInt8}</span>)</span>
<span id="cb74-3"><a href="#cb74-3"></a>    str <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">UInt8</span>, <span class="fu">cld</span>(<span class="fu">sizeof</span>(data), <span class="fl">3</span>) <span class="op">*</span> <span class="fl">4</span>)</span>
<span id="cb74-4"><a href="#cb74-4"></a>    i <span class="op">=</span> <span class="fu">firstindex</span>(data)</span>
<span id="cb74-5"><a href="#cb74-5"></a>    j <span class="op">=</span> <span class="fu">firstindex</span>(str)</span>
<span id="cb74-6"><a href="#cb74-6"></a>    <span class="pp">@inbounds</span> <span class="cf">while</span> i <span class="op">+</span> <span class="fl">2</span> <span class="op">≤</span> <span class="fu">lastindex</span>(data)</span>
<span id="cb74-7"><a href="#cb74-7"></a>        x1, x2, x3 <span class="op">=</span> data[i], data[i<span class="op">+</span><span class="fl">1</span>], data[i<span class="op">+</span><span class="fl">2</span>]</span>
<span id="cb74-8"><a href="#cb74-8"></a>        i <span class="op">+=</span> <span class="fl">3</span></span>
<span id="cb74-9"><a href="#cb74-9"></a>        h1 <span class="op">=</span>                  x1 <span class="op">&gt;&gt;</span> <span class="fl">2</span></span>
<span id="cb74-10"><a href="#cb74-10"></a>        h2 <span class="op">=</span> x1 <span class="op">&lt;&lt;</span> <span class="fl">4</span> <span class="op">&amp;</span> <span class="bn">0x3f</span> <span class="op">|</span> x2 <span class="op">&gt;&gt;</span> <span class="fl">4</span></span>
<span id="cb74-11"><a href="#cb74-11"></a>        h3 <span class="op">=</span> x2 <span class="op">&lt;&lt;</span> <span class="fl">2</span> <span class="op">&amp;</span> <span class="bn">0x3f</span> <span class="op">|</span> x3 <span class="op">&gt;&gt;</span> <span class="fl">6</span></span>
<span id="cb74-12"><a href="#cb74-12"></a>        h4 <span class="op">=</span> x3      <span class="op">&amp;</span> <span class="bn">0x3f</span></span>
<span id="cb74-13"><a href="#cb74-13"></a>        str[j  ] <span class="op">=</span> <span class="fu">hex2char</span>(h1)</span>
<span id="cb74-14"><a href="#cb74-14"></a>        str[j<span class="op">+</span><span class="fl">1</span>] <span class="op">=</span> <span class="fu">hex2char</span>(h2)</span>
<span id="cb74-15"><a href="#cb74-15"></a>        str[j<span class="op">+</span><span class="fl">2</span>] <span class="op">=</span> <span class="fu">hex2char</span>(h3)</span>
<span id="cb74-16"><a href="#cb74-16"></a>        str[j<span class="op">+</span><span class="fl">3</span>] <span class="op">=</span> <span class="fu">hex2char</span>(h4)</span>
<span id="cb74-17"><a href="#cb74-17"></a>        j <span class="op">+=</span> <span class="fl">4</span></span>
<span id="cb74-18"><a href="#cb74-18"></a>    <span class="cf">end</span></span>
<span id="cb74-19"><a href="#cb74-19"></a>    <span class="fu">finish!</span>(str, data, <span class="fu">lastindex</span>(data) <span class="op">-</span> i <span class="op">+</span> <span class="fl">1</span>)</span>
<span id="cb74-20"><a href="#cb74-20"></a>    <span class="cf">return</span> str</span>
<span id="cb74-21"><a href="#cb74-21"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="b64encode3.jl" class="level3">
<h3 class="anchored" data-anchor-id="b64encode3.jl">b64/encode3.jl</h3>
<div class="sourceCode" id="cb75"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb75-1"><a href="#cb75-1"></a><span class="co"># ルックアップテーブル</span></span>
<span id="cb75-2"><a href="#cb75-2"></a><span class="kw">const</span> ENCODE_TABLE <span class="op">=</span> <span class="dt">UInt8</span>[<span class="ch">'A'</span><span class="op">:</span><span class="ch">'Z'</span>; <span class="ch">'a'</span><span class="op">:</span><span class="ch">'z'</span>; <span class="ch">'0'</span><span class="op">:</span><span class="ch">'9'</span>; <span class="ch">'+'</span>; <span class="ch">'/'</span>]</span>
<span id="cb75-3"><a href="#cb75-3"></a></span>
<span id="cb75-4"><a href="#cb75-4"></a><span class="co"># Base64符号化関数（バージョン3）</span></span>
<span id="cb75-5"><a href="#cb75-5"></a><span class="kw">function</span> <span class="fu">encode3</span>(data<span class="op">::</span><span class="dt">AbstractVector{UInt8}</span>)</span>
<span id="cb75-6"><a href="#cb75-6"></a>    str <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">UInt8</span>, <span class="fu">cld</span>(<span class="fu">sizeof</span>(data), <span class="fl">3</span>) <span class="op">*</span> <span class="fl">4</span>)</span>
<span id="cb75-7"><a href="#cb75-7"></a>    i <span class="op">=</span> <span class="fu">firstindex</span>(data)</span>
<span id="cb75-8"><a href="#cb75-8"></a>    j <span class="op">=</span> <span class="fu">firstindex</span>(str)</span>
<span id="cb75-9"><a href="#cb75-9"></a>    <span class="pp">@inbounds</span> <span class="cf">while</span> i <span class="op">+</span> <span class="fl">2</span> <span class="op">≤</span> <span class="fu">lastindex</span>(data)</span>
<span id="cb75-10"><a href="#cb75-10"></a>        x1, x2, x3 <span class="op">=</span> data[i], data[i<span class="op">+</span><span class="fl">1</span>], data[i<span class="op">+</span><span class="fl">2</span>]</span>
<span id="cb75-11"><a href="#cb75-11"></a>        i <span class="op">+=</span> <span class="fl">3</span></span>
<span id="cb75-12"><a href="#cb75-12"></a>        h1 <span class="op">=</span>                  x1 <span class="op">&gt;&gt;</span> <span class="fl">2</span></span>
<span id="cb75-13"><a href="#cb75-13"></a>        h2 <span class="op">=</span> x1 <span class="op">&lt;&lt;</span> <span class="fl">4</span> <span class="op">&amp;</span> <span class="bn">0x3f</span> <span class="op">|</span> x2 <span class="op">&gt;&gt;</span> <span class="fl">4</span></span>
<span id="cb75-14"><a href="#cb75-14"></a>        h3 <span class="op">=</span> x2 <span class="op">&lt;&lt;</span> <span class="fl">2</span> <span class="op">&amp;</span> <span class="bn">0x3f</span> <span class="op">|</span> x3 <span class="op">&gt;&gt;</span> <span class="fl">6</span></span>
<span id="cb75-15"><a href="#cb75-15"></a>        h4 <span class="op">=</span> x3      <span class="op">&amp;</span> <span class="bn">0x3f</span></span>
<span id="cb75-16"><a href="#cb75-16"></a>        str[j  ] <span class="op">=</span> ENCODE_TABLE[h1<span class="op">+</span><span class="fl">1</span>]</span>
<span id="cb75-17"><a href="#cb75-17"></a>        str[j<span class="op">+</span><span class="fl">1</span>] <span class="op">=</span> ENCODE_TABLE[h2<span class="op">+</span><span class="fl">1</span>]</span>
<span id="cb75-18"><a href="#cb75-18"></a>        str[j<span class="op">+</span><span class="fl">2</span>] <span class="op">=</span> ENCODE_TABLE[h3<span class="op">+</span><span class="fl">1</span>]</span>
<span id="cb75-19"><a href="#cb75-19"></a>        str[j<span class="op">+</span><span class="fl">3</span>] <span class="op">=</span> ENCODE_TABLE[h4<span class="op">+</span><span class="fl">1</span>]</span>
<span id="cb75-20"><a href="#cb75-20"></a>        j <span class="op">+=</span> <span class="fl">4</span></span>
<span id="cb75-21"><a href="#cb75-21"></a>    <span class="cf">end</span></span>
<span id="cb75-22"><a href="#cb75-22"></a>    <span class="fu">finish!</span>(str, data, <span class="fu">lastindex</span>(data) <span class="op">-</span> i <span class="op">+</span> <span class="fl">1</span>)</span>
<span id="cb75-23"><a href="#cb75-23"></a>    <span class="cf">return</span> str</span>
<span id="cb75-24"><a href="#cb75-24"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="mbplot-par2.jl" class="level3">
<h3 class="anchored" data-anchor-id="mbplot-par2.jl">mb/plot-par2.jl</h3>
<div class="sourceCode" id="cb76"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb76-1"><a href="#cb76-1"></a><span class="co"># 並列実行版2</span></span>
<span id="cb76-2"><a href="#cb76-2"></a><span class="kw">function</span> <span class="fu">plot_par2</span>(x, y; maxiters <span class="op">=</span> N, blocksize <span class="op">=</span> <span class="cn">nothing</span>)</span>
<span id="cb76-3"><a href="#cb76-3"></a>    m, n <span class="op">=</span> <span class="fu">length</span>.((y, x))</span>
<span id="cb76-4"><a href="#cb76-4"></a>    <span class="cf">if</span> <span class="fu">isnothing</span>(blocksize)</span>
<span id="cb76-5"><a href="#cb76-5"></a>        <span class="co"># スレッド数x32個の区画に分割</span></span>
<span id="cb76-6"><a href="#cb76-6"></a>        p <span class="op">=</span> <span class="bu">Threads</span>.<span class="fu">nthreads</span>()</span>
<span id="cb76-7"><a href="#cb76-7"></a>        blocksize <span class="op">=</span> <span class="fu">cld</span>(n, <span class="fl">32</span>p)</span>
<span id="cb76-8"><a href="#cb76-8"></a>    <span class="cf">end</span></span>
<span id="cb76-9"><a href="#cb76-9"></a>    chan <span class="op">=</span> <span class="fu">Channel</span>(spawn <span class="op">=</span> <span class="cn">true</span>) <span class="cf">do</span> chan</span>
<span id="cb76-10"><a href="#cb76-10"></a>        <span class="co"># y軸と平行に分割</span></span>
<span id="cb76-11"><a href="#cb76-11"></a>        <span class="cf">for</span> J <span class="kw">in</span> <span class="bu">Iterators</span>.<span class="fu">partition</span>(<span class="fl">1</span><span class="op">:</span>n, blocksize)</span>
<span id="cb76-12"><a href="#cb76-12"></a>            <span class="fu">put!</span>(chan, J)</span>
<span id="cb76-13"><a href="#cb76-13"></a>        <span class="cf">end</span></span>
<span id="cb76-14"><a href="#cb76-14"></a>    <span class="cf">end</span></span>
<span id="cb76-15"><a href="#cb76-15"></a>    img <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Int16</span>, m, n)</span>
<span id="cb76-16"><a href="#cb76-16"></a>    <span class="bu">Threads</span>.<span class="fu">foreach</span>(chan) <span class="cf">do</span> J</span>
<span id="cb76-17"><a href="#cb76-17"></a>        <span class="cf">for</span> j <span class="kw">in</span> J, i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>m</span>
<span id="cb76-18"><a href="#cb76-18"></a>            c <span class="op">=</span> <span class="fu">complex</span>(x[j], y[i])</span>
<span id="cb76-19"><a href="#cb76-19"></a>            img[i,j] <span class="op">=</span> <span class="fu">mandelbrot</span>(c; maxiters)</span>
<span id="cb76-20"><a href="#cb76-20"></a>        <span class="cf">end</span></span>
<span id="cb76-21"><a href="#cb76-21"></a>    <span class="cf">end</span></span>
<span id="cb76-22"><a href="#cb76-22"></a>    <span class="cf">return</span> img</span>
<span id="cb76-23"><a href="#cb76-23"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="fsparsum.jl" class="level3">
<h3 class="anchored" data-anchor-id="fsparsum.jl">fs/parsum.jl</h3>
<div class="sourceCode" id="cb77"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb77-1"><a href="#cb77-1"></a><span class="im">using</span> <span class="bu">.Threads</span>: nthreads, @threads, threadid</span>
<span id="cb77-2"><a href="#cb77-2"></a></span>
<span id="cb77-3"><a href="#cb77-3"></a><span class="kw">function</span> <span class="fu">parsum</span>(A, k)</span>
<span id="cb77-4"><a href="#cb77-4"></a>    s <span class="op">=</span> <span class="fu">zeros</span>(<span class="fu">eltype</span>(A), (<span class="fu">nthreads</span>() <span class="op">-</span> <span class="fl">1</span>) <span class="op">&lt;&lt;</span> k <span class="op">+</span> <span class="fl">1</span>)</span>
<span id="cb77-5"><a href="#cb77-5"></a>    <span class="pp">@threads</span> <span class="op">:</span>static <span class="cf">for</span> j <span class="kw">in</span> <span class="fu">axes</span>(A, <span class="fl">2</span>)</span>
<span id="cb77-6"><a href="#cb77-6"></a>        offset <span class="op">=</span> (<span class="fu">threadid</span>() <span class="op">-</span> <span class="fl">1</span>) <span class="op">&lt;&lt;</span> k <span class="op">+</span> <span class="fl">1</span></span>
<span id="cb77-7"><a href="#cb77-7"></a>        <span class="co"># 行列Aのj列目の総和を計算</span></span>
<span id="cb77-8"><a href="#cb77-8"></a>        <span class="pp">@inbounds</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">axes</span>(A, <span class="fl">1</span>)</span>
<span id="cb77-9"><a href="#cb77-9"></a>            s[offset] <span class="op">+=</span> A[i,j]</span>
<span id="cb77-10"><a href="#cb77-10"></a>        <span class="cf">end</span></span>
<span id="cb77-11"><a href="#cb77-11"></a>    <span class="cf">end</span></span>
<span id="cb77-12"><a href="#cb77-12"></a>    <span class="cf">return</span> <span class="fu">sum</span>(s)</span>
<span id="cb77-13"><a href="#cb77-13"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="histhistogram-serial.jl" class="level3">
<h3 class="anchored" data-anchor-id="histhistogram-serial.jl">hist/histogram-serial.jl</h3>
<div class="sourceCode" id="cb78"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb78-1"><a href="#cb78-1"></a><span class="im">using</span> <span class="bu">Images</span></span>
<span id="cb78-2"><a href="#cb78-2"></a></span>
<span id="cb78-3"><a href="#cb78-3"></a><span class="kw">const</span> Img <span class="op">=</span> <span class="dt">Array</span>{RGB{N0f8}}</span>
<span id="cb78-4"><a href="#cb78-4"></a></span>
<span id="cb78-5"><a href="#cb78-5"></a><span class="co"># 逐次実行</span></span>
<span id="cb78-6"><a href="#cb78-6"></a><span class="kw">function</span> <span class="fu">histogram_serial</span>(img<span class="op">::</span><span class="dt">Img</span>)</span>
<span id="cb78-7"><a href="#cb78-7"></a>    hist_r <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Int</span>, <span class="fl">256</span>)</span>
<span id="cb78-8"><a href="#cb78-8"></a>    hist_g <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Int</span>, <span class="fl">256</span>)</span>
<span id="cb78-9"><a href="#cb78-9"></a>    hist_b <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Int</span>, <span class="fl">256</span>)</span>
<span id="cb78-10"><a href="#cb78-10"></a>    <span class="pp">@inbounds</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">eachindex</span>(img)</span>
<span id="cb78-11"><a href="#cb78-11"></a>        x <span class="op">=</span> img[i]  <span class="co"># 画素（pixel）</span></span>
<span id="cb78-12"><a href="#cb78-12"></a>        hist_r[<span class="fu">reinterpret</span>(<span class="dt">UInt8</span>, x.r)<span class="op">+</span><span class="fl">1</span>] <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb78-13"><a href="#cb78-13"></a>        hist_g[<span class="fu">reinterpret</span>(<span class="dt">UInt8</span>, x.g)<span class="op">+</span><span class="fl">1</span>] <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb78-14"><a href="#cb78-14"></a>        hist_b[<span class="fu">reinterpret</span>(<span class="dt">UInt8</span>, x.b)<span class="op">+</span><span class="fl">1</span>] <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb78-15"><a href="#cb78-15"></a>    <span class="cf">end</span></span>
<span id="cb78-16"><a href="#cb78-16"></a>    <span class="cf">return</span> hist_r, hist_g, hist_b</span>
<span id="cb78-17"><a href="#cb78-17"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="histhistogram-lock.jl" class="level3">
<h3 class="anchored" data-anchor-id="histhistogram-lock.jl">hist/histogram-lock.jl</h3>
<div class="sourceCode" id="cb79"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb79-1"><a href="#cb79-1"></a><span class="im">using</span> <span class="bu">.Threads</span>: @threads, SpinLock</span>
<span id="cb79-2"><a href="#cb79-2"></a></span>
<span id="cb79-3"><a href="#cb79-3"></a><span class="co"># ロックを使った排他制御</span></span>
<span id="cb79-4"><a href="#cb79-4"></a><span class="kw">function</span> <span class="fu">histogram_lock</span>(img<span class="op">::</span><span class="dt">Img</span>)</span>
<span id="cb79-5"><a href="#cb79-5"></a>    hist_r <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Int</span>, <span class="fl">256</span>)</span>
<span id="cb79-6"><a href="#cb79-6"></a>    hist_g <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Int</span>, <span class="fl">256</span>)</span>
<span id="cb79-7"><a href="#cb79-7"></a>    hist_b <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Int</span>, <span class="fl">256</span>)</span>
<span id="cb79-8"><a href="#cb79-8"></a>    mutex <span class="op">=</span> <span class="fu">SpinLock</span>()</span>
<span id="cb79-9"><a href="#cb79-9"></a>    <span class="pp">@inbounds</span> <span class="pp">@threads</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">eachindex</span>(img)</span>
<span id="cb79-10"><a href="#cb79-10"></a>        x <span class="op">=</span> img[i]  <span class="co"># 画素（pixel）</span></span>
<span id="cb79-11"><a href="#cb79-11"></a>        <span class="fu">lock</span>(mutex)  <span class="co"># クリティカルセクション開始</span></span>
<span id="cb79-12"><a href="#cb79-12"></a>        hist_r[<span class="fu">reinterpret</span>(<span class="dt">UInt8</span>, x.r)<span class="op">+</span><span class="fl">1</span>] <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb79-13"><a href="#cb79-13"></a>        hist_g[<span class="fu">reinterpret</span>(<span class="dt">UInt8</span>, x.g)<span class="op">+</span><span class="fl">1</span>] <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb79-14"><a href="#cb79-14"></a>        hist_b[<span class="fu">reinterpret</span>(<span class="dt">UInt8</span>, x.b)<span class="op">+</span><span class="fl">1</span>] <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb79-15"><a href="#cb79-15"></a>        <span class="fu">unlock</span>(mutex)  <span class="co"># クリティカルセクション終了</span></span>
<span id="cb79-16"><a href="#cb79-16"></a>    <span class="cf">end</span></span>
<span id="cb79-17"><a href="#cb79-17"></a>    <span class="cf">return</span> hist_r, hist_g, hist_b</span>
<span id="cb79-18"><a href="#cb79-18"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="histhistogram-mapreduce.jl" class="level3">
<h3 class="anchored" data-anchor-id="histhistogram-mapreduce.jl">hist/histogram-mapreduce.jl</h3>
<div class="sourceCode" id="cb80"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb80-1"><a href="#cb80-1"></a><span class="im">using</span> <span class="bu">.Threads</span>: @spawn, nthreads</span>
<span id="cb80-2"><a href="#cb80-2"></a></span>
<span id="cb80-3"><a href="#cb80-3"></a><span class="co"># MapReduceパターン</span></span>
<span id="cb80-4"><a href="#cb80-4"></a><span class="kw">function</span> <span class="fu">histogram_mapreduce</span>(img<span class="op">::</span><span class="dt">Img</span>; p <span class="op">=</span> <span class="fu">nthreads</span>())</span>
<span id="cb80-5"><a href="#cb80-5"></a>    <span class="co"># Map</span></span>
<span id="cb80-6"><a href="#cb80-6"></a>    n <span class="op">=</span> <span class="fu">cld</span>(<span class="fu">length</span>(img), p)</span>
<span id="cb80-7"><a href="#cb80-7"></a>    parts <span class="op">=</span> <span class="bu">Iterators</span>.<span class="fu">partition</span>(<span class="fu">eachindex</span>(img), n)</span>
<span id="cb80-8"><a href="#cb80-8"></a>    tasks <span class="op">=</span> <span class="fu">map</span>(parts) <span class="cf">do</span> part</span>
<span id="cb80-9"><a href="#cb80-9"></a>        <span class="pp">@spawn</span> <span class="cf">begin</span></span>
<span id="cb80-10"><a href="#cb80-10"></a>            hist_r <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Int</span>, <span class="fl">256</span>)</span>
<span id="cb80-11"><a href="#cb80-11"></a>            hist_g <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Int</span>, <span class="fl">256</span>)</span>
<span id="cb80-12"><a href="#cb80-12"></a>            hist_b <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Int</span>, <span class="fl">256</span>)</span>
<span id="cb80-13"><a href="#cb80-13"></a>            <span class="pp">@inbounds</span> <span class="cf">for</span> i <span class="kw">in</span> part</span>
<span id="cb80-14"><a href="#cb80-14"></a>                x <span class="op">=</span> img[i]  <span class="co"># 画素（pixel）</span></span>
<span id="cb80-15"><a href="#cb80-15"></a>                hist_r[<span class="fu">reinterpret</span>(<span class="dt">UInt8</span>, x.r)<span class="op">+</span><span class="fl">1</span>] <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb80-16"><a href="#cb80-16"></a>                hist_g[<span class="fu">reinterpret</span>(<span class="dt">UInt8</span>, x.g)<span class="op">+</span><span class="fl">1</span>] <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb80-17"><a href="#cb80-17"></a>                hist_b[<span class="fu">reinterpret</span>(<span class="dt">UInt8</span>, x.b)<span class="op">+</span><span class="fl">1</span>] <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb80-18"><a href="#cb80-18"></a>            <span class="cf">end</span></span>
<span id="cb80-19"><a href="#cb80-19"></a>            hist_r, hist_g, hist_b</span>
<span id="cb80-20"><a href="#cb80-20"></a>        <span class="cf">end</span></span>
<span id="cb80-21"><a href="#cb80-21"></a>    <span class="cf">end</span></span>
<span id="cb80-22"><a href="#cb80-22"></a></span>
<span id="cb80-23"><a href="#cb80-23"></a>    <span class="co"># Reduce</span></span>
<span id="cb80-24"><a href="#cb80-24"></a>    <span class="kw">function</span> <span class="fu">add!</span>((r1, g1, b1), (r2, g2, b2))</span>
<span id="cb80-25"><a href="#cb80-25"></a>        r1 <span class="op">.+=</span> r2</span>
<span id="cb80-26"><a href="#cb80-26"></a>        g1 <span class="op">.+=</span> g2</span>
<span id="cb80-27"><a href="#cb80-27"></a>        b1 <span class="op">.+=</span> b2</span>
<span id="cb80-28"><a href="#cb80-28"></a>        <span class="cf">return</span> r1, g1, b1</span>
<span id="cb80-29"><a href="#cb80-29"></a>    <span class="kw">end</span></span>
<span id="cb80-30"><a href="#cb80-30"></a>    <span class="cf">return</span> <span class="fu">foldl</span>(add!, <span class="fu">fetch</span>(task)<span class="op">::</span><span class="dt">NTuple{3, Vector{Int}} </span><span class="cf">for</span> task <span class="kw">in</span> tasks)</span>
<span id="cb80-31"><a href="#cb80-31"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="nqnqueens-flat.jl" class="level3">
<h3 class="anchored" data-anchor-id="nqnqueens-flat.jl">nq/nqueens-flat.jl</h3>
<div class="sourceCode" id="cb81"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb81-1"><a href="#cb81-1"></a><span class="co"># フラット並列（MapReduce）</span></span>
<span id="cb81-2"><a href="#cb81-2"></a><span class="kw">function</span> <span class="fu">nqueens_flat</span>(n)</span>
<span id="cb81-3"><a href="#cb81-3"></a>    n <span class="op">≤</span> <span class="fl">1</span> <span class="op">&amp;&amp;</span> <span class="cf">return</span> <span class="fu">Int</span>(n <span class="op">==</span> <span class="fl">1</span>)</span>
<span id="cb81-4"><a href="#cb81-4"></a>    tasks <span class="op">=</span> <span class="fu">map</span>(<span class="fl">1</span><span class="op">:</span>n) <span class="cf">do</span> rank</span>
<span id="cb81-5"><a href="#cb81-5"></a>        <span class="co"># (1, j)に最初のクイーンがあるタスクを作成</span></span>
<span id="cb81-6"><a href="#cb81-6"></a>        <span class="pp">@spawn</span> <span class="cf">begin</span></span>
<span id="cb81-7"><a href="#cb81-7"></a>            ranks <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Int</span>, n)</span>
<span id="cb81-8"><a href="#cb81-8"></a>            ranks[<span class="fl">1</span>] <span class="op">=</span> rank</span>
<span id="cb81-9"><a href="#cb81-9"></a>            <span class="cf">return</span> <span class="fu">solve</span>(ranks, <span class="fl">2</span>)</span>
<span id="cb81-10"><a href="#cb81-10"></a>        <span class="cf">end</span></span>
<span id="cb81-11"><a href="#cb81-11"></a>    <span class="cf">end</span></span>
<span id="cb81-12"><a href="#cb81-12"></a>    <span class="cf">return</span> <span class="fu">sum</span>(<span class="fu">fetch</span>(task)<span class="op">::</span><span class="dt">Int </span><span class="cf">for</span> task <span class="kw">in</span> tasks)</span>
<span id="cb81-13"><a href="#cb81-13"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="nqnqueens-nested.jl" class="level3">
<h3 class="anchored" data-anchor-id="nqnqueens-nested.jl">nq/nqueens-nested.jl</h3>
<div class="sourceCode" id="cb82"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb82-1"><a href="#cb82-1"></a><span class="co"># ネスト並列</span></span>
<span id="cb82-2"><a href="#cb82-2"></a><span class="kw">function</span> <span class="fu">nqueens_nested</span>(n)</span>
<span id="cb82-3"><a href="#cb82-3"></a>    n <span class="op">≤</span> <span class="fl">0</span> <span class="op">&amp;&amp;</span> <span class="cf">return</span> <span class="fl">0</span></span>
<span id="cb82-4"><a href="#cb82-4"></a>    <span class="cf">return</span> <span class="fu">parsolve</span>(<span class="fu">zeros</span>(<span class="dt">Int</span>, n), <span class="fl">1</span>)</span>
<span id="cb82-5"><a href="#cb82-5"></a><span class="kw">end</span></span>
<span id="cb82-6"><a href="#cb82-6"></a></span>
<span id="cb82-7"><a href="#cb82-7"></a><span class="co"># solve関数の並列版</span></span>
<span id="cb82-8"><a href="#cb82-8"></a><span class="kw">function</span> <span class="fu">parsolve</span>(ranks, file)</span>
<span id="cb82-9"><a href="#cb82-9"></a>    n <span class="op">=</span> <span class="fu">length</span>(ranks)</span>
<span id="cb82-10"><a href="#cb82-10"></a>    n <span class="op">-</span> file <span class="op">&lt;</span> <span class="fl">12</span> <span class="op">&amp;&amp;</span> <span class="cf">return</span> <span class="fu">solve</span>(ranks, file)</span>
<span id="cb82-11"><a href="#cb82-11"></a>    tasks <span class="op">=</span> <span class="fu">map</span>(<span class="fl">1</span><span class="op">:</span>n) <span class="cf">do</span> rank</span>
<span id="cb82-12"><a href="#cb82-12"></a>        <span class="pp">@spawn</span> <span class="cf">begin</span></span>
<span id="cb82-13"><a href="#cb82-13"></a>            <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>file<span class="op">-</span><span class="fl">1</span></span>
<span id="cb82-14"><a href="#cb82-14"></a>                r <span class="op">=</span> rank <span class="op">-</span> ranks[i]</span>
<span id="cb82-15"><a href="#cb82-15"></a>                <span class="cf">if</span> r <span class="op">==</span> <span class="fl">0</span> <span class="op">||</span> file <span class="op">-</span> i <span class="op">==</span> <span class="fu">abs</span>(r)</span>
<span id="cb82-16"><a href="#cb82-16"></a>                    <span class="cf">return</span> <span class="fl">0</span></span>
<span id="cb82-17"><a href="#cb82-17"></a>                <span class="cf">end</span></span>
<span id="cb82-18"><a href="#cb82-18"></a>            <span class="cf">end</span></span>
<span id="cb82-19"><a href="#cb82-19"></a>            <span class="kw">let</span> ranks <span class="op">=</span> <span class="fu">copy</span>(ranks)</span>
<span id="cb82-20"><a href="#cb82-20"></a>                ranks[file] <span class="op">=</span> rank</span>
<span id="cb82-21"><a href="#cb82-21"></a>                <span class="cf">return</span> <span class="fu">parsolve</span>(ranks, file <span class="op">+</span> <span class="fl">1</span>)</span>
<span id="cb82-22"><a href="#cb82-22"></a>            <span class="cf">end</span></span>
<span id="cb82-23"><a href="#cb82-23"></a>        <span class="cf">end</span></span>
<span id="cb82-24"><a href="#cb82-24"></a>    <span class="kw">end</span></span>
<span id="cb82-25"><a href="#cb82-25"></a>    <span class="cf">return</span> <span class="fu">sum</span>(<span class="fu">fetch</span>(task)<span class="op">::</span><span class="dt">Int </span><span class="cf">for</span> task <span class="kw">in</span> tasks)</span>
<span id="cb82-26"><a href="#cb82-26"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>